<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>    
	Usermaatre &middot; Lenses in F#    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  
  <style type="text/css">
	
	.left-align {
		text-align:left;
	}
	
	.header-bug {
		font-size:0px;
	}
	
  </style>
  
  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  
  
</head>


  <body class="theme-base-0b">
  
    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Usermaatre
        </a>
      </h1>
      <p class="lead">Programming, science, history and gaming. Not necessarily in that order.</p>
    </div>

    <nav class="sidebar-nav">
	  <a class="sidebar-nav-item" href="/">Home</a>
	  <a class="sidebar-nav-item" href="/about">About</a>
	  <a class="sidebar-nav-item" href="/archive">Archive</a>
      <a class="sidebar-nav-item" href="https://twitter.com/m_d_watts" target="_blank">Twitter</a>	  
      <a class="sidebar-nav-item" href="https://github.com/wattsm" target="_blank">GitHub</a>      
    </nav>
	
	<p>&copy; 2015. All rights reserved.</p>
	
	
  </div>
</div>


    <div class="content container">	
      <div class="post">
  <h1 class="post-title">Lenses in F#</h1>
  <span class="post-date">
	15 Oct 2015
&middot;
Programming 

	&middot;
	<a href="/tags/fsharp">F#</a>	

&middot;
<a data-disqus-identifier="Lenses in F#" href="/programming/2015/10/15/lenses-in-fsharp/#disqus_thread">0 Comments</a>	
  </span>
  <p>I recently came across the concept of lenses in functional programming - a useful tool that can significantly reduce the amount of boilerplate code required when working
with <a href="https://msdn.microsoft.com/en-us/library/dd233184.aspx">record types</a>. I first noticed them in <a href="http://suave.io/">suave</a>&#39;s source code and, intrigued, did some further research which lead me to <a href="https://www21.in.tum.de/teaching/fp/SS15/papers/17.pdf">this paper</a> by Albert Steckermeier 
which describes the concept in detail (using Haskell). </p>

<p>As my background is primarily with OO languages I find that I quite often stumble across concepts in functional programming that more experienced practitioners would 
take for granted. There did not seem to a huge amount of information on lenses out there, so I thought I would write a short post about lenses in F#.</p>

<!-- more -->

<h3>What is a lens?</h3>

<p>A lens is simply a tuple of two functions, <code>get</code> and <code>put</code>, for a given part of a data structure. Using Steckermeier&#39;s terminology the data structure is 
the <em>source</em> and the part focused on is the <em>view</em>.</p>

<p>Using this terminology we can define a lens quite simply in F#.</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">type</span> <span class="nc">Lens</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">S</span><span class="o">,</span> <span class="k">&#39;</span><span class="n">V</span><span class="o">&gt;</span> <span class="o">=</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">S</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">V</span><span class="o">)</span> <span class="o">*</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">V</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">S</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">S</span><span class="o">)</span>
</code></pre></div>
<p>We can trivially create a <code>Lens</code> module to allow us to elegantly call the <code>get</code> and <code>put</code> functions of a lens.</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="o">[&lt;</span><span class="n">RequireQualifiedAccess</span><span class="o">&gt;]</span>
<span class="k">module</span> <span class="nn">Lens</span> <span class="o">=</span> 
    <span class="k">let</span> <span class="nv">get</span> <span class="o">=</span> <span class="n">fst</span>
    <span class="k">let</span> <span class="nv">put</span> <span class="o">=</span> <span class="n">snd</span>
</code></pre></div>
<p>As lenses are just tuples we can easily select the <code>get</code> or <code>put</code> function using the standard <code>fst</code> and <code>snd</code> functions.</p>

<p>Below is an example of a type with an associated lens and how that lens would be used.</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">type</span> <span class="nc">Address</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">City</span> <span class="o">:</span> <span class="n">String</span><span class="o">;</span>
  <span class="n">PostCode</span> <span class="o">:</span> <span class="n">String</span><span class="o">;</span>
<span class="o">}</span>
<span class="k">with</span>

  <span class="c1">//A lens for the PostCode field. The trailing underscore is a naming convention</span>
  <span class="c1">//used to denote lenses.</span>
  <span class="k">static</span> <span class="k">member</span> <span class="n">PostCode_</span> <span class="o">=</span> 
    <span class="o">(</span><span class="k">fun</span> <span class="n">address</span> <span class="o">-&gt;</span> <span class="n">address</span><span class="o">.</span><span class="n">PostCode</span><span class="o">),</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">postCode</span> <span class="n">address</span> <span class="o">-&gt;</span> <span class="o">{</span> <span class="n">address</span> <span class="k">with</span> <span class="n">PostCode</span> <span class="o">=</span> <span class="n">postCode</span><span class="o">;</span> <span class="o">})</span>

<span class="k">let</span> <span class="nv">original</span> <span class="o">=</span> <span class="o">{</span> <span class="n">City</span> <span class="o">=</span> <span class="s">&quot;Cityville&quot;</span><span class="o">;</span> <span class="n">PostCode</span> <span class="o">=</span> <span class="s">&quot;CV1&quot;</span><span class="o">;</span> <span class="o">}</span>

<span class="c1">//Get the post code using the lens</span>
<span class="k">let</span> <span class="nv">postCode</span> <span class="o">=</span> <span class="nn">Lens</span><span class="p">.</span><span class="n">get</span> <span class="nn">Address</span><span class="p">.</span><span class="n">PostCode_</span> <span class="n">address</span>

<span class="c1">//Update the post code using the lens</span>
<span class="k">let</span> <span class="nv">updated</span> <span class="o">=</span> <span class="nn">Lens</span><span class="p">.</span><span class="n">put</span> <span class="nn">Address</span><span class="p">.</span><span class="n">PostCode_</span> <span class="s">&quot;CV3&quot;</span> <span class="n">address</span>
</code></pre></div>
<p>Here we define a type <code>Address</code> (source) with an associated lens for the <code>PostCode</code> field (view). We then use the lens to get the value of the post code and to create an updated address 
with a different post code.</p>

<h3>Composing lenses</h3>

<p>The real power of lenses is that they are composable - you can combine two or more lenses to create a new lens which allows you to focus in on a part of the source that is normally only accessible
by drilling down into the data structure - e.g. <code>person.Address.PostCode</code>. </p>

<p>Composing two lenses is simply a case of creating a new lens by composing the two sets of <code>get</code> and <code>put</code> functions. In order to do this the type of the view of the first lens 
must be the same as the type of the source of the second lens, i.e. composition has the signature <code>Lens&lt;&#39;A, &#39;B&gt; -&gt; Lens&lt;&#39;B, &#39;C&gt; -&gt; Lens&lt;&#39;A, &#39;C&gt;</code>.</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="o">[&lt;</span><span class="n">RequireQualifiedAccess</span><span class="o">&gt;]</span>
<span class="k">module</span> <span class="nn">Lens</span> <span class="o">=</span> 

    <span class="k">let</span> <span class="nv">compose</span> <span class="o">(</span><span class="n">xLens</span> <span class="o">:</span> <span class="n">Lens</span><span class="o">&lt;_,_&gt;)</span> <span class="o">(</span><span class="n">yLens</span> <span class="o">:</span> <span class="n">Lens</span><span class="o">&lt;_,_&gt;)</span> <span class="o">=</span> 

        <span class="k">let</span> <span class="nv">xGet</span><span class="o">,</span> <span class="n">xPut</span> <span class="o">=</span> <span class="n">xLens</span>
        <span class="k">let</span> <span class="nv">yGet</span><span class="o">,</span> <span class="n">yPut</span> <span class="o">=</span> <span class="n">yLens</span>

        <span class="k">let</span> <span class="nv">composedGet</span> <span class="o">=</span> <span class="n">xGet</span> <span class="o">&gt;&gt;</span> <span class="n">yGet</span>

        <span class="k">let</span> <span class="nv">composedPut</span> <span class="n">yView</span> <span class="n">xSource</span> <span class="o">=</span>         

            <span class="k">let</span> <span class="nv">yUpdatedSource</span> <span class="o">=</span> <span class="n">yPut</span> <span class="n">yView</span> <span class="o">(</span><span class="n">xGet</span> <span class="n">xSource</span><span class="o">)</span>
            <span class="k">let</span> <span class="nv">xUpdatedSource</span> <span class="o">=</span> <span class="n">xPut</span> <span class="n">yUpdatedSource</span> <span class="n">xSource</span>

            <span class="n">xUpdatedSource</span>

        <span class="o">(</span><span class="n">composedGet</span><span class="o">,</span> <span class="n">composedPut</span><span class="o">)</span>

<span class="o">[&lt;</span><span class="n">AutoOpen</span><span class="o">&gt;]</span>
<span class="k">module</span> <span class="nn">Operators</span> <span class="o">=</span> 

    <span class="k">let</span> <span class="o">(&gt;=&gt;)</span> <span class="o">=</span> <span class="nn">Lens</span><span class="p">.</span><span class="n">compose</span>
</code></pre></div>
<p>For the sake of clarity I have made this implementation quite verbose, it can be written far more succintly. The infix operator <code>&gt;=&gt;</code> is included as a useful shorthand for composing
lenses.</p>

<p>We can now demonstrate why lenses are so useful. Consider the following record types.</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">type</span> <span class="nc">Address</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">City</span> <span class="o">:</span> <span class="n">String</span><span class="o">;</span>
    <span class="n">PostCode</span> <span class="o">:</span> <span class="n">String</span><span class="o">;</span>
<span class="o">}</span>

<span class="k">type</span> <span class="nc">Person</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">Name</span> <span class="o">:</span> <span class="n">String</span><span class="o">;</span>
    <span class="n">Address</span> <span class="o">:</span> <span class="n">Address</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div>
<p>Now let&#39;s imagine that we have a <code>Person</code> record and we want to change the post code of the address.</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="nv">person</span><span class="k">&#39;</span> <span class="o">=</span> <span class="o">{</span> <span class="n">person</span> <span class="k">with</span> <span class="n">Address</span> <span class="o">=</span> <span class="o">{</span> <span class="n">person</span><span class="o">.</span><span class="n">Address</span> <span class="k">with</span> <span class="n">PostCode</span> <span class="o">=</span> <span class="n">postCode</span><span class="o">;</span> <span class="o">};</span> <span class="o">}</span>
</code></pre></div>
<p>That&#39;s quite ugly, and it only gets worse as the data structures become more complicated. We can use lenses to neaten this code and reduce the amount of boilerplate code required. Assume that
we have lenses <code>Address.PostCode_</code> and <code>Person.Address_</code>.</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="nv">person</span><span class="k">&#39;</span> <span class="o">=</span> <span class="nn">Lens</span><span class="p">.</span><span class="n">put</span> <span class="o">(</span><span class="nn">Person</span><span class="p">.</span><span class="n">Address_</span> <span class="o">&gt;=&gt;</span> <span class="nn">Address</span><span class="p">.</span><span class="n">PostCode_</span><span class="o">)</span> <span class="n">postCode</span> <span class="n">person</span>
</code></pre></div>
<p>This ability to compose lenses becomes increasingly useful the more complex the data structure becomes. They can be used inline, as above, or to create new functions.</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="o">[&lt;</span><span class="n">CompilationRepresentation</span><span class="o">(</span><span class="nn">CompilationRepresentationFlags</span><span class="p">.</span><span class="n">ModuleSuffix</span><span class="o">)&gt;]</span>
<span class="k">module</span> <span class="nn">Person</span> <span class="o">=</span> 

    <span class="c1">//String -&gt; Person -&gt; Person</span>
    <span class="k">let</span> <span class="nv">setPostCode</span> <span class="o">=</span> <span class="nn">Lens</span><span class="p">.</span><span class="n">put</span> <span class="o">(</span><span class="nn">Person</span><span class="p">.</span><span class="n">Address_</span> <span class="o">&gt;=&gt;</span> <span class="nn">Address</span><span class="p">.</span><span class="n">PostCode_</span><span class="o">)</span>
</code></pre></div>
<p>Finally, another useful aspect of lenses is that they are not restricted to working on single values. For example, let&#39;s expand our <code>Address</code> type and use a lens to work with multiple
fields simultaneously.</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">type</span> <span class="nc">Address</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">HouseNumber</span> <span class="o">:</span> <span class="n">Int32</span><span class="o">;</span>
    <span class="n">StreetName</span> <span class="o">:</span> <span class="n">String</span><span class="o">;</span>
    <span class="n">City</span> <span class="o">:</span> <span class="n">String</span><span class="o">;</span>
    <span class="n">PostCode</span> <span class="o">:</span> <span class="n">String</span>
<span class="o">}</span>
<span class="k">with</span>

    <span class="k">static</span> <span class="k">member</span> <span class="n">Street</span> <span class="o">=</span> 
        <span class="o">(</span><span class="k">fun</span> <span class="n">address</span> <span class="o">-&gt;</span> <span class="n">address</span><span class="o">.</span><span class="n">HouseNumber</span><span class="o">,</span> <span class="n">address</span><span class="o">.</span><span class="n">StreetName</span><span class="o">),</span>
        <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">houseNumber</span><span class="o">,</span> <span class="n">streetName</span><span class="o">)</span> <span class="n">address</span> <span class="o">-&gt;</span> 
            <span class="o">{</span> <span class="n">address</span> <span class="k">with</span> <span class="n">HouseNumber</span> <span class="o">=</span> <span class="n">houseNumber</span><span class="o">;</span> <span class="n">StreetName</span> <span class="o">=</span> <span class="n">streetName</span><span class="o">;</span> <span class="o">})</span>

<span class="k">let</span> <span class="nv">address</span> <span class="o">=</span> <span class="o">{</span> <span class="n">HouseNumber</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">StreetName</span> <span class="o">=</span> <span class="s">&quot;Main Street&quot;</span><span class="o">;</span> <span class="n">City</span> <span class="o">=</span> <span class="s">&quot;Cityville&quot;</span><span class="o">;</span> <span class="n">PostCode</span> <span class="o">=</span> <span class="s">&quot;CV1&quot;</span><span class="o">;</span> <span class="o">}</span>
<span class="k">let</span> <span class="nv">person</span> <span class="o">=</span> <span class="o">{</span> <span class="n">Name</span> <span class="o">=</span> <span class="s">&quot;Bob&quot;</span><span class="o">;</span> <span class="n">Address</span> <span class="o">=</span> <span class="n">address</span><span class="o">;</span> <span class="o">}</span>

<span class="k">let</span> <span class="nv">person</span><span class="k">&#39;</span> <span class="o">=</span> <span class="nn">Lens</span><span class="p">.</span><span class="n">put</span> <span class="o">(</span><span class="nn">Person</span><span class="p">.</span><span class="n">Address_</span> <span class="o">&gt;=&gt;</span> <span class="nn">Address</span><span class="p">.</span><span class="n">Street_</span><span class="o">)</span> <span class="o">(</span><span class="mi">23</span><span class="o">,</span> <span class="s">&quot;High Street&quot;</span><span class="o">)</span> <span class="n">person</span>
</code></pre></div>
<h3>Conclusion</h3>

<p>In this post I&#39;ve given a quick overview of lenses and their implementation in F# and shown how they can be used to make working with record types a little more elegant. </p>

<p>If you are interested in seeing a more complete implementation of lenses in F# then I would suggest having a look at <a href="https://github.com/xyncro/aether">Aether on GitHub</a>.</p>

</div>

<div class="comments">
	<h3>Comments</h3>

	<div id="disqus_thread"></div>
	<script type="text/javascript">
		/* * * CONFIGURATION VARIABLES * * */
		var disqus_shortname = 'usermaatre';
		var disqus_title = "Lenses in F#";
		var disqus_identifier = "Lenses in F#";
		
		/* * * DON'T EDIT BELOW THIS LINE * * */
		(function() {
			var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
    
      <li>
        <h5>
          <a href="/programming/2015/05/20/modeling-historical-dates/">
            Modeling historical dates
            <small>20 May 2015</small>
          </a>
        </h5>
      </li>
    
      <li>
        <h5>
          <a href="/programming/2015/01/19/futures-in-fsharp/">
            Futures in F#
            <small>19 Jan 2015</small>
          </a>
        </h5>
      </li>
    
      <li>
        <h5>
          <a href="/programming/2015/02/13/using-dbscan-for-fun-and-profit-in-elite-dangerous/">
            Using DBSCAN for fun and (mostly) profit in Elite:Dangerous
            <small>13 Feb 2015</small>
          </a>
        </h5>
      </li>
    
  </ul>
</div>
    </div>

	
	<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'usermaatre';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
  </body>
</html>
