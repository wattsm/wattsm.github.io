<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>    
	Usermaatre &middot; Stateful Akka.NET actors with F#    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  
  <style type="text/css">
	
	.left-align {
		text-align:left;
	}
	
	.header-bug {
		font-size:0px;
	}
	
  </style>
  
  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  
  
  <!-- Google analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-56516871-1', 'auto');
    ga('send', 'pageview');

  </script>
  
</head>


  <body class="theme-base-0b">
  
    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Usermaatre
        </a>
      </h1>
      <p class="lead">Programming, science, history and gaming. Not necessarily in that order.</p>
    </div>

    <nav class="sidebar-nav">
	  <a class="sidebar-nav-item" href="/">Home</a>
	  <a class="sidebar-nav-item" href="/about">About</a>
	  <a class="sidebar-nav-item" href="/archive">Archive</a>
      <a class="sidebar-nav-item" href="https://twitter.com/m_d_watts" target="_blank">Twitter</a>	  
      <a class="sidebar-nav-item" href="https://github.com/wattsm" target="_blank">GitHub</a>      
    </nav>
	
	<p>&copy; 2015. All rights reserved.</p>
	
	
  </div>
</div>


    <div class="content container">	
      <div class="post">
  <h1 class="post-title">Stateful Akka.NET actors with F#</h1>
  <span class="post-date">
	13 Nov 2015
&middot;
Programming 

	&middot;
	<a href="/tags/fsharp">F#</a>, 	

	
	<a href="/tags/akka.net">Akka.NET</a>	

&middot;
<a data-disqus-identifier="Stateful Akka.NET actors with F#" href="/programming/2015/11/13/stateful-akka-actors-with-fsharp/#disqus_thread">0 Comments</a>	
  </span>
  <p><a href="http://getakka.net/">Akka.NET</a> is the .Net implementation of Java&#39;s <a href="http://akka.io/">Akka</a> framework, which allows developers to build &quot;highly concurrent, distributed, and resilient message-driven applications&quot; via
an <a href="https://en.wikipedia.org/wiki/Actor_model">actor model</a>. One of the many nice features of Akka.NET is that it comes with an <a href="http://getakka.net/docs/FSharp%20API">F# API</a>. However, there are some scenarios which the F# API does not specifically cater for, 
and one of those is stafeul actors. </p>

<p>In this post I will describe how to implement a simple stateful Akka.NET actor in a functional style without mutable variables.</p>

<!-- more -->

<h3>Stateful actors</h3>

<p>When talking about stateful actors I am specifically talking about actors that behave like <a href="http://en.wikipedia.org/wiki/Finite-state_machine">finite state machines</a> - i.e. they have some concept of their current state and 
can change their behaviour depending on their inputs. Akka.NET supports this kind of actor via switchable behaviours. Aaron Stannard&#39;s blog post 
&quot;<a href="https://petabridge.com/blog/akka-actors-finite-state-machines-switchable-behavior/">Building Finite State Machines With Actors: Switchable Behavior</a>&quot; gives an excellent
overview of how you would implement a stateful actor in Akka.NET using C#.</p>

<p>Akka.NET&#39;s F# API provides a lot of handy tools for working with actors in a functional style but unfortunately switchable behaviours are not covered, so in order to use them
you have to create a type which implements <code>ReceiveActor</code> as per Aaron&#39;s blog post. Implementing stateful actors in this way will also likely require the use of mutable variables. </p>

<p>Given how elegant actors created using the <code>actorOf</code> functions provided by the F# API can be, stateful actors created by inheriting from <code>ReceiveActor</code> can seem clunky 
and out of place, and mutable variables are generally frowned upon in functional programming.</p>

<p>It would be useful to have an equivalent of <code>actorOf</code> for creating stateful actors in a functional style and without mutable variables for the sake of consistency if nothing else.</p>

<h3>C# example</h3>

<p>Before we look at implementing stateful actors in F# let&#39;s look at a simple C# example. </p>

<p>One usage of stateful actors is to act as an aggregator for data - e.g. an actor which collates data from multiple sources into a single message. This actor might 
have two states - waiting and collecting. When the initial request for the collated data arrives it sends requests to various other actors for data and then moves 
to the collecting state and waits for replies. When all of the data has been received it sends the collated data back to the original requester and then moves back 
into the waiting state or stops, depending on the lifecycle.</p>

<p>Here is a simplified version of that stateful actor written in C#. This actor starts in the waiting state. When it receives the <code>StartCollecting</code> message it moves 
to the collecting state. When in the collecting state the value of any <code>Collected</code> messages are recorded. When the maximum number of values have been collected or 
the <code>StopCollecting</code> message is received the actor prints the values it has stored and moves back to the waiting state.</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">ExampleActor</span> <span class="p">:</span> <span class="n">ReceiveActor</span> <span class="p">{</span>

    <span class="k">private</span> <span class="kt">int</span> <span class="n">_count</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;</span> <span class="n">_values</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>

    <span class="k">public</span> <span class="nf">ExampleActor</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Waiting</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">Waiting</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Receive</span><span class="p">&lt;</span><span class="n">Messages</span><span class="p">.</span><span class="n">StartCollecting</span><span class="p">&gt;(</span><span class="n">message</span> <span class="p">=&gt;</span> <span class="p">{</span>

            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Starting collection&quot;</span><span class="p">);</span>

            <span class="n">_values</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
            <span class="n">_count</span> <span class="p">=</span> <span class="n">message</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span>

            <span class="k">this</span><span class="p">.</span><span class="n">Become</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Collecting</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">Collecting</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Receive</span><span class="p">&lt;</span><span class="n">Messages</span><span class="p">.</span><span class="n">Collected</span><span class="p">&gt;(</span><span class="n">message</span> <span class="p">=&gt;</span> <span class="p">{</span>

            <span class="n">_values</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="n">_values</span><span class="p">.</span><span class="n">Count</span><span class="p">()</span> <span class="p">==</span> <span class="n">_count</span><span class="p">)</span> <span class="p">{</span>

                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span>
                    <span class="s">&quot;Finished collecting ({0}/{0}): {1}&quot;</span><span class="p">,</span> 
                    <span class="n">_count</span><span class="p">,</span> 
                    <span class="n">String</span><span class="p">.</span><span class="n">Join</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="n">_values</span><span class="p">)</span>
                <span class="p">);</span>

                <span class="k">this</span><span class="p">.</span><span class="n">StopCollecting</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">});</span>

        <span class="k">this</span><span class="p">.</span><span class="n">Receive</span><span class="p">&lt;</span><span class="n">Messages</span><span class="p">.</span><span class="n">StopCollecting</span><span class="p">&gt;(</span><span class="n">message</span> <span class="p">=&gt;</span> <span class="p">{</span>

            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span>
                <span class="s">&quot;Stopped collecting ({0}/{1}): {2}&quot;</span><span class="p">,</span> 
                <span class="n">_values</span><span class="p">.</span><span class="n">Count</span><span class="p">(),</span> 
                <span class="n">_count</span><span class="p">,</span> 
                <span class="n">String</span><span class="p">.</span><span class="n">Join</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="n">_values</span><span class="p">)</span>
            <span class="p">);</span>

            <span class="k">this</span><span class="p">.</span><span class="n">StopCollecting</span><span class="p">();</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">StopCollecting</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Become</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Waiting</span><span class="p">);</span>

        <span class="c1">//Or stop</span>
        <span class="c1">//ReceiveActor.Context.Stop(this.Self);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>While it is possible to implement this actor in F# using the same approach let&#39;s look at a more elegant approach to creating stateful actors by building on Akka.NET&#39;s F# API.</p>

<h3>Stateful actors using F&#35;</h3>

<p>The basic implementation of an Akka.NET actor in F# is a simple recursive function which receives the next message, processes it and then loops.</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="nv">actor</span> <span class="o">=</span> 
    <span class="n">spawn</span> <span class="n">system</span> <span class="s">&quot;Actor&quot;</span> <span class="o">(</span><span class="k">fun</span> <span class="n">mailbox</span> <span class="o">-&gt;</span>

        <span class="k">let</span> <span class="nv">rec</span> <span class="n">run</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">actor</span> <span class="o">{</span>

            <span class="k">let!</span> <span class="nv">message</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">.</span><span class="n">Receive</span> <span class="bp">()</span>

            <span class="c1">//Process the message</span>

            <span class="k">return</span><span class="o">!</span> <span class="o">(</span><span class="n">run</span> <span class="bp">()</span><span class="o">)</span>
        <span class="o">}</span>

        <span class="n">run</span> <span class="bp">()</span>
    <span class="o">)</span>
</code></pre></div>
<p>We can use the recursive nature of the <code>run</code> function to keep a track of the actor&#39;s current state, both in terms of its behaviour and any associated data. We might try
and implement this like so:</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="nv">initialState</span> <span class="o">=</span> <span class="o">...</span>
<span class="k">let</span> <span class="nv">initialHandler</span> <span class="o">=</span> <span class="o">...</span>

<span class="k">let</span> <span class="nv">actor</span> <span class="o">=</span> 
    <span class="n">spawn</span> <span class="n">system</span> <span class="s">&quot;Actor&quot;</span> <span class="o">(</span><span class="k">fun</span> <span class="n">mailbox</span> <span class="o">-&gt;</span>

        <span class="k">let</span> <span class="nv">rec</span> <span class="n">run</span> <span class="n">data</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">actor</span> <span class="o">{</span>

            <span class="k">let!</span> <span class="nv">message</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">.</span><span class="n">Receive</span> <span class="bp">()</span>

            <span class="k">let</span> <span class="nv">data</span><span class="k">&#39;</span><span class="o">,</span> <span class="n">handler&#39;</span> <span class="o">=</span> <span class="o">(</span><span class="n">handler</span> <span class="n">data</span> <span class="n">message</span><span class="o">)</span>

            <span class="k">return</span><span class="o">!</span> <span class="o">(</span><span class="n">run</span> <span class="n">data&#39;</span> <span class="n">handler&#39;</span><span class="o">)</span>
        <span class="o">}</span>

        <span class="n">run</span> <span class="n">initialState</span> <span class="n">initialHandler</span>
    <span class="o">)</span>
</code></pre></div>
<p>Here the actor&#39;s behaviour is defined by the <code>handler</code> function which accepts the current state&#39;s data and the message and returns udpated data and the next handler to be used. 
However we run into problems when we try to define the signature for <code>handler</code> as it is self recursive - i.e. the second element in the tuple it returns has the same signature as itself.</p>

<p>To address this we can use recursive types to create a definition of our <code>handler</code>.</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="o">[&lt;</span><span class="n">AutoOpen</span><span class="o">&gt;]</span>
<span class="k">module</span> <span class="nn">Types</span> <span class="o">=</span> 

    <span class="k">type</span> <span class="nc">Handler</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">TData</span><span class="o">,</span> <span class="k">&#39;</span><span class="n">TMessage</span><span class="o">&gt;</span> <span class="o">=</span> <span class="k">&#39;</span><span class="n">TData</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">TMessage</span> <span class="o">-&gt;</span> <span class="n">Instruction</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">TData</span><span class="o">,</span> <span class="k">&#39;</span><span class="n">TMessage</span><span class="o">&gt;</span>

    <span class="ow">and</span> <span class="n">Instruction</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">TData</span><span class="o">,</span> <span class="k">&#39;</span><span class="n">TMessage</span><span class="o">&gt;</span> <span class="o">=</span> 
        <span class="o">|</span> <span class="n">Continue</span> <span class="k">of</span> <span class="k">&#39;</span><span class="n">TData</span>
        <span class="o">|</span> <span class="n">Become</span> <span class="k">of</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">TData</span> <span class="o">*</span> <span class="n">Handler</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">TData</span><span class="o">,</span> <span class="k">&#39;</span><span class="n">TMessage</span><span class="o">&gt;)</span>
        <span class="o">|</span> <span class="n">Unhandled</span>
        <span class="o">|</span> <span class="n">Stop</span>
</code></pre></div>
<p>First we define a handler type which is a function which accepts <code>&#39;TData</code> and <code>&#39;TMessage</code> and returns an <code>Instruction&lt;&#39;TData,&#39;TMessage&gt;</code>. Secondly we define <code>Instruction&lt;&#39;TData, &#39;TMessage&gt;</code> as a union of four 
possible values:</p>

<ul>
<li><code>Continue</code> - continue processing messages with updated data;</li>
<li><code>Become</code> - move to a new state;</li>
<li><code>Unhandled</code> - the message was unhandled;</li>
<li><code>Stop</code> - stop processing messages.</li>
</ul>

<p>Now that we have defined what our <code>handler</code> function should look like we can try and implement our actor again:</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="nv">handlers</span> <span class="o">=</span> <span class="o">...</span> <span class="c1">//Handler&lt;&#39;TData, &#39;TMessage&gt; list</span>
<span class="k">let</span> <span class="nv">initialData</span> <span class="o">=</span> <span class="o">...</span> <span class="c1">//&#39;TData</span>

<span class="k">let</span> <span class="nv">actor</span> <span class="o">=</span> 
    <span class="n">spawn</span> <span class="n">system</span> <span class="s">&quot;Actor&quot;</span> <span class="o">(</span><span class="k">fun</span> <span class="n">mailbox</span> <span class="o">-&gt;</span>

        <span class="k">let</span> <span class="nv">rec</span> <span class="n">run</span> <span class="n">data</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">actor</span> <span class="o">{</span>

            <span class="k">let!</span> <span class="nv">message</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">.</span><span class="n">Receive</span> <span class="bp">()</span>

            <span class="c1">//Process the message</span>
            <span class="k">let</span> <span class="nv">next</span><span class="o">,</span> <span class="n">handled</span> <span class="o">=</span> 
                <span class="k">match</span> <span class="o">(</span><span class="n">handler</span> <span class="n">data</span> <span class="n">message</span><span class="o">)</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">Continue</span> <span class="n">data&#39;</span> <span class="o">-&gt;</span>             <span class="n">Some</span> <span class="o">(</span><span class="n">data&#39;</span><span class="o">,</span> <span class="n">handler</span><span class="o">),</span> <span class="k">true</span>                 
                <span class="o">|</span> <span class="n">Become</span> <span class="o">(</span><span class="n">data&#39;</span><span class="o">,</span> <span class="n">handler&#39;</span><span class="o">)</span> <span class="o">-&gt;</span>   <span class="n">Some</span> <span class="o">(</span><span class="n">data&#39;</span><span class="o">,</span> <span class="n">handler&#39;</span><span class="o">),</span> <span class="k">true</span>
                <span class="o">|</span> <span class="n">Unhandled</span> <span class="o">-&gt;</span>                  <span class="n">Some</span> <span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">handler</span><span class="o">),</span> <span class="k">false</span>                 
                <span class="o">|</span> <span class="n">Stop</span> <span class="o">-&gt;</span>                       <span class="n">None</span><span class="o">,</span> <span class="k">true</span>

            <span class="c1">//Report unhandled messages</span>
            <span class="k">if</span> <span class="o">(</span><span class="ow">not</span> <span class="n">handled</span><span class="o">)</span> <span class="k">then</span>
                <span class="n">mailbox</span><span class="o">.</span><span class="n">Unhandled</span> <span class="o">(</span><span class="n">message</span><span class="o">)</span>

            <span class="c1">//Continue or exit the loop</span>
            <span class="k">match</span> <span class="n">next</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">None</span> <span class="o">-&gt;</span> 
                <span class="n">mailbox</span><span class="o">.</span><span class="n">Context</span><span class="o">.</span><span class="n">Stop</span> <span class="o">(</span><span class="n">mailbox</span><span class="o">.</span><span class="n">Self</span><span class="o">)</span>
                <span class="k">return</span> <span class="bp">()</span>

            <span class="o">|</span> <span class="n">Some</span> <span class="o">(</span><span class="n">data&#39;</span><span class="o">,</span> <span class="n">handler&#39;</span><span class="o">)</span> <span class="o">-&gt;</span>
                <span class="k">return</span><span class="o">!</span> <span class="o">(</span><span class="n">run</span> <span class="n">data&#39;</span> <span class="n">handler&#39;</span><span class="o">)</span>
        <span class="o">}</span>

        <span class="n">run</span> <span class="n">initialData</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">head</span> <span class="n">handlers</span><span class="o">)</span>
    <span class="o">)</span>
</code></pre></div>
<p>Now we have a working stateful actor. The <code>run</code> function receives a message and passes it and any current data to the handler function. The handler returns
an instruction telling the actor what do next. It translate this into either the arguments for the next iteration of the <code>run</code> function or as a stop signal (<code>None</code>) for the actor. 
It also sets a flag indicating whether the current message should be marked as unhandled. The function then either recurses or stops the actor and exits as appropriate.</p>

<p>The <code>run</code> function is started with the first handler in the <code>handlers</code> list and <code>initialData</code>, and will loop until a <code>Stop</code> instruction is issued. </p>

<p>This code can be packaged up into a function similar to Akka.NET F# API&#39;s <code>actorOf</code>:</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="c1">//Handler&lt;&#39;TData,&#39;TMessage&gt; list -&gt; &#39;TData -&gt; Actor&lt;&#39;TMessage&gt; -&gt; Cont&lt;&#39;TMessage, unit&gt;</span>
<span class="k">let</span> <span class="nv">statefulActorOf</span> <span class="n">handlers</span> <span class="n">initialData</span> <span class="o">(</span><span class="n">mailbox</span> <span class="o">:</span> <span class="n">Actor</span><span class="o">&lt;_&gt;)</span> <span class="o">=</span> 

    <span class="k">let</span> <span class="nv">rec</span> <span class="n">run</span> <span class="n">data</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">actor</span> <span class="o">{</span>

        <span class="k">let!</span> <span class="nv">message</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">.</span><span class="n">Receive</span> <span class="bp">()</span>

        <span class="c1">//Process the message</span>
        <span class="k">let</span> <span class="nv">next</span><span class="o">,</span> <span class="n">handled</span> <span class="o">=</span> 
            <span class="k">match</span> <span class="o">(</span><span class="n">handler</span> <span class="n">data</span> <span class="n">message</span><span class="o">)</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Continue</span> <span class="n">data&#39;</span> <span class="o">-&gt;</span>             <span class="n">Some</span> <span class="o">(</span><span class="n">data&#39;</span><span class="o">,</span> <span class="n">handler</span><span class="o">),</span> <span class="k">true</span>                 
            <span class="o">|</span> <span class="n">Become</span> <span class="o">(</span><span class="n">data&#39;</span><span class="o">,</span> <span class="n">handler&#39;</span><span class="o">)</span> <span class="o">-&gt;</span>   <span class="n">Some</span> <span class="o">(</span><span class="n">data&#39;</span><span class="o">,</span> <span class="n">handler&#39;</span><span class="o">),</span> <span class="k">true</span>
            <span class="o">|</span> <span class="n">Unhandled</span> <span class="o">-&gt;</span>                  <span class="n">Some</span> <span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">handler</span><span class="o">),</span> <span class="k">false</span>                 
            <span class="o">|</span> <span class="n">Stop</span> <span class="o">-&gt;</span>                       <span class="n">None</span><span class="o">,</span> <span class="k">true</span>

        <span class="c1">//Report unhandled messages</span>
        <span class="k">if</span> <span class="o">(</span><span class="ow">not</span> <span class="n">handled</span><span class="o">)</span> <span class="k">then</span>
            <span class="n">mailbox</span><span class="o">.</span><span class="n">Unhandled</span> <span class="o">(</span><span class="n">message</span><span class="o">)</span>

        <span class="c1">//Continue or exit the loop</span>
        <span class="k">match</span> <span class="n">next</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">None</span> <span class="o">-&gt;</span> 
            <span class="n">mailbox</span><span class="o">.</span><span class="n">Context</span><span class="o">.</span><span class="n">Stop</span> <span class="o">(</span><span class="n">mailbox</span><span class="o">.</span><span class="n">Self</span><span class="o">)</span>
            <span class="k">return</span> <span class="bp">()</span>

        <span class="o">|</span> <span class="n">Some</span> <span class="o">(</span><span class="n">data&#39;</span><span class="o">,</span> <span class="n">handler&#39;</span><span class="o">)</span> <span class="o">-&gt;</span>
            <span class="k">return</span><span class="o">!</span> <span class="o">(</span><span class="n">run</span> <span class="n">data&#39;</span> <span class="n">handler&#39;</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="n">run</span> <span class="n">initialData</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">head</span> <span class="n">handlers</span><span class="o">)</span>
</code></pre></div>
<p>We can now use this function to create stateful actors from a list of handlers and some initial data:</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="nv">actor</span> <span class="o">=</span> 
    <span class="n">spawn</span> <span class="n">system</span> <span class="s">&quot;Actor&quot;</span> <span class="o">(</span><span class="n">statefulActorOf</span> <span class="nn">Example</span><span class="p">.</span><span class="n">handlers</span> <span class="nn">Example</span><span class="p">.</span><span class="n">initialData</span><span class="o">)</span>
</code></pre></div>
<p>Finally, we can implement our example actor in a functional style without mutable variables:</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="o">[&lt;</span><span class="n">RequireQualifiedAccess</span><span class="o">&gt;]</span>
<span class="k">module</span> <span class="nn">Example</span> <span class="o">=</span> 

    <span class="o">[&lt;</span><span class="n">AutoOpen</span><span class="o">&gt;]</span>
    <span class="k">module</span> <span class="nn">private</span> <span class="n">Helpers</span> <span class="o">=</span> 

        <span class="k">let</span> <span class="nv">concat</span> <span class="o">(</span><span class="n">values</span> <span class="o">:</span> <span class="n">String</span> <span class="kt">list</span><span class="o">)</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">Join</span> <span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">,</span> <span class="n">values</span><span class="o">)</span>

    <span class="k">type</span> <span class="nc">Message</span> <span class="o">=</span> 
        <span class="o">|</span> <span class="n">StartCollecting</span> <span class="k">of</span> <span class="n">Int32</span>
        <span class="o">|</span> <span class="n">StopCollecting</span>
        <span class="o">|</span> <span class="n">Collected</span> <span class="k">of</span> <span class="n">String</span>

    <span class="k">let</span> <span class="nv">initialData</span> <span class="o">=</span> <span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="bp">[]</span><span class="o">)</span>

    <span class="k">let</span> <span class="nv">rec</span> <span class="k">private</span> <span class="n">waiting</span> <span class="o">_</span> <span class="o">=</span> <span class="k">function</span>
        <span class="o">|</span> <span class="n">StartCollecting</span> <span class="n">count</span> <span class="o">-&gt;</span> 

            <span class="n">printfn</span> <span class="s">&quot;Starting collection&quot;</span>

            <span class="n">Become</span> <span class="o">((</span><span class="n">count</span><span class="o">,</span> <span class="bp">[]</span><span class="o">),</span> <span class="n">collecting</span><span class="o">)</span>

        <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">Unhandled</span>

    <span class="ow">and</span> <span class="k">private</span> <span class="n">collecting</span> <span class="o">(</span><span class="n">count</span><span class="o">,</span> <span class="n">values</span><span class="o">)</span> <span class="o">=</span> 

        <span class="k">let</span> <span class="nv">stopCollecting</span> <span class="bp">()</span> <span class="o">=</span> 
            <span class="n">Become</span> <span class="o">(</span><span class="n">initialData</span><span class="o">,</span> <span class="n">waiting</span><span class="o">)</span>
            <span class="c1">//Or stop</span>
            <span class="c1">//Stop</span>

        <span class="k">function</span>
        <span class="o">|</span> <span class="n">Collected</span> <span class="n">value</span> <span class="o">-&gt;</span>

            <span class="k">let</span> <span class="nv">values</span><span class="k">&#39;</span> <span class="o">=</span> <span class="n">value</span> <span class="o">::</span> <span class="n">values</span>

            <span class="k">if</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">length</span> <span class="n">values&#39;</span><span class="o">)</span> <span class="o">=</span> <span class="n">count</span> <span class="k">then</span>

                <span class="n">printfn</span> <span class="s">&quot;Finished collecting (%u/%u): %s&quot;</span> 
                <span class="o">&lt;|</span> <span class="n">count</span> 
                <span class="o">&lt;|</span> <span class="n">count</span> 
                <span class="o">&lt;|</span> <span class="o">(</span><span class="n">concat</span> <span class="n">values&#39;</span><span class="o">)</span>

                <span class="n">stopCollecting</span> <span class="bp">()</span> 

            <span class="k">else</span>
                <span class="n">Continue</span> <span class="o">(</span><span class="n">count</span><span class="o">,</span> <span class="n">values&#39;</span><span class="o">)</span>

        <span class="o">|</span> <span class="n">StopCollecting</span> <span class="o">-&gt;</span> 

            <span class="n">printfn</span> <span class="s">&quot;Stopping collecting (%u/%u): %s&quot;</span> 
            <span class="o">&lt;|</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">length</span> <span class="n">values</span><span class="o">)</span> 
            <span class="o">&lt;|</span> <span class="n">count</span> 
            <span class="o">&lt;|</span> <span class="o">(</span><span class="n">concat</span> <span class="n">values</span><span class="o">)</span>

            <span class="n">stopCollecting</span> <span class="bp">()</span> 

        <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">Unhandled</span>

    <span class="k">let</span> <span class="nv">handlers</span> <span class="o">=</span> <span class="o">[</span> <span class="n">waiting</span><span class="o">;</span> <span class="n">collecting</span><span class="o">;</span> <span class="o">]</span>
</code></pre></div>
<p>Here we use a union to model the messages received by the actor and then simply use pattern matching in the handler functions. The <code>&#39;TData</code> for this actor is <code>(Int32 * String list)</code>
and contains both the number of values to collect and the values collected so far. The <code>collecting</code> handler simply adds to the list of values with each message received until 
the target number of values is reached, or the <code>StopCollecting</code> message is received.</p>

<p>Notice that the handler functions are mutually recursive so that the <code>waiting</code> state handler can return the <code>collecting</code> state handler and vice versa.</p>

<h3>Conclusion</h3>

<p>In this post I have shown how to create stateful actors in Akka.NET using a functional style. This allows you to create actor systems where all actors are created using a
familiar style without the need to inherit base types or use mutable variables. </p>

<p>The code for both the C# and F# implementations of examples are <a href="https://github.com/wattsm/stateful-akka-actors">available on GitHub</a>.</p>

</div>

<div class="comments">
	<h3>Comments</h3>

	<div id="disqus_thread"></div>
	<script type="text/javascript">
		/* * * CONFIGURATION VARIABLES * * */
		var disqus_shortname = 'usermaatre';
		var disqus_title = "Stateful Akka.NET actors with F#";
		var disqus_identifier = "Stateful Akka.NET actors with F#";
		
		/* * * DON'T EDIT BELOW THIS LINE * * */
		(function() {
			var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
    
      <li>
        <h5>
          <a href="/programming/2015/05/20/modeling-historical-dates/">
            Modeling historical dates
            <small>20 May 2015</small>
          </a>
        </h5>
      </li>
    
      <li>
        <h5>
          <a href="/programming/2015/02/13/using-dbscan-for-fun-and-profit-in-elite-dangerous/">
            Using DBSCAN for fun and (mostly) profit in Elite:Dangerous
            <small>13 Feb 2015</small>
          </a>
        </h5>
      </li>
    
      <li>
        <h5>
          <a href="/programming/2014/11/18/modeling-mars-rovers-with-fsharp/">
            Modeling Mars rovers with F#
            <small>18 Nov 2014</small>
          </a>
        </h5>
      </li>
    
  </ul>
</div>
    </div>

	
	<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'usermaatre';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
  </body>
</html>
