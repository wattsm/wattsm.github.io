<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>    
	Usermaatre &middot; WebAPI OData GraphDelta<T>    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  
  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  
  
  <!-- Google analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-56516871-1', 'auto');
    ga('send', 'pageview');

  </script>
  
</head>


  <body class="theme-base-0b">
  
    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Usermaatre
        </a>
      </h1>
      <p class="lead">Programming, science, history and gaming. Not necessarily in that order.</p>
    </div>

    <nav class="sidebar-nav">
	  <a class="sidebar-nav-item" href="/">Home</a>
	  <a class="sidebar-nav-item" href="/about">About</a>
	  <a class="sidebar-nav-item" href="/archive">Archive</a>
      <a class="sidebar-nav-item" href="https://twitter.com/m_d_watts" target="_blank">Twitter</a>	  
      <a class="sidebar-nav-item" href="https://github.com/wattsm" target="_blank">GitHub</a>      
    </nav>
	
	<p>&copy; 2015. All rights reserved.</p>
	
	
  </div>
</div>


    <div class="content container">	
      <div class="post">
  <h1 class="post-title">WebAPI OData GraphDelta<T></h1>
  <span class="post-date">
	10 Apr 2015
&middot;
Programming 

	&middot;
	<a href="/tags/webapi">WebAPI</a>, 	

	
	<a href="/tags/odata">OData</a>	

&middot;
<a data-disqus-identifier="WebAPI OData GraphDelta<T>" href="/programming/2015/04/10/odata-graph-delta/#disqus_thread">0 Comments</a>	
  </span>
  <p>In the course of a recent project I ran into a problem with the standard <code>Delta&lt;T&gt;</code> included in Microsoft WebAPI&#39;s OData functionality: it treats complex properties as atomic 
values meaning that instead of applying the delta to the existing value of the complex property it will create a new, blank value, apply the delta to that
and then set the complex property to the result. </p>

<p><a href="http://stackoverflow.com/questions/27963113/using-deltat-with-complex-objects">I asked about this behaviour on StackOverflow</a> and it turns out that it&#39;s a <a href="https://github.com/OData/WebApi/issues/135">known issue</a>. This post briefly outlines how I implemented an alternative to <code>Delta&lt;T&gt;</code> that handled changes to 
complex types the same way as changes are handled for entities. The post will feature minimal code but source code is <a href="https://github.com/wattsm/odata-graph-delta">available on GitHub</a>.</p>

<!-- more -->

<h3>An example</h3>

<p>Before looking at creating an alternative to <code>Delta&lt;T&gt;</code> we should first illustrate the problem. </p>

<p>Imagine we have a simple model with a <code>Person</code> entity and an <code>Address</code> complex type. The following JSON is used to update a <code>Person</code> using the MERGE or PATCH verbs:</p>
<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&quot;Title&quot;</span><span class="p">:</span> <span class="s2">&quot;Dr&quot;</span><span class="p">,</span>
  <span class="nt">&quot;Address&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;Street&quot;</span><span class="p">:</span> <span class="s2">&quot;Acacia Avenue&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>When then resulting <code>Delta&lt;T&gt;</code> is applied using the <code>Patch</code> method the effect will be the equivalent of:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">person</span><span class="p">.</span><span class="n">Title</span> <span class="p">=</span> <span class="s">&quot;Dr&quot;</span><span class="p">;</span>
<span class="n">person</span><span class="p">.</span><span class="n">Address</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Address</span><span class="p">()</span> <span class="p">{</span> <span class="n">Street</span> <span class="p">=</span> <span class="s">&quot;Acacia Avenue&quot;</span> <span class="p">};</span>
</code></pre></div>
<p>We would rather have the address changes applied to the existing <code>Address</code> if there is one (only creating a new value if there is not):</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">person</span><span class="p">.</span><span class="n">Title</span> <span class="p">=</span> <span class="s">&quot;Dr&quot;</span><span class="p">;</span>

<span class="k">if</span><span class="p">(</span><span class="n">person</span><span class="p">.</span><span class="n">Address</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">person</span><span class="p">.</span><span class="n">Address</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Address</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">person</span><span class="p">.</span><span class="n">Address</span><span class="p">.</span><span class="n">Street</span> <span class="p">=</span> <span class="s">&quot;Acacia Avenue&quot;</span><span class="p">;</span>
</code></pre></div>
<h3>GraphDelta&lt;T&gt;</h3>

<p>Instead of creating an alternative delta type from scratch I created two new types, <code>GraphDelta&lt;T&gt;</code> and <code>TypedGraphDelta</code>, which 
use <code>Delta&lt;T&gt;</code> and its base class, <code>TypedDelta</code> internally to produce the functionality we want.</p>

<p>Much like <code>Delta&lt;T&gt;</code>, <code>GraphDelta&lt;T&gt;</code> is simply a generic shortcut type that inherits from <code>TypedGraphDelta</code>. </p>

<p>The constructor of <code>TypedGraphDelta</code> accepts a <a href="http://www.newtonsoft.com/json">JSON.Net</a> <code>JObject</code> representing the delta and a model <code>Type</code>. It then uses the properties of the type 
to read updated values using <a href="http://goessner.net/articles/JsonPath/">JSONPath</a> and stores them in a root level <code>TypedDelta</code> instance. Any model property which is not a &quot;simple&quot; type 
(in this implementation value types, strings and byte arrays) is considered a child and is given its own <code>TypedGraphDelta</code> (and so the process is recursive and covers the entire object graph).</p>

<p>When <code>Patch</code> is called the root level <code>TypedDelta</code> is applied followed by all child <code>TypedGraphDelta</code> instances. If a property has a null value and changes were included in the JSON then
a new instance will be created, populated and set.</p>

<p>You can see the full code for <code>TypedGraphDelta</code> <a href="https://github.com/wattsm/odata-graph-delta/blob/master/ODataGraphDelta/TypedGraphDelta.cs">here</a>, and 
the tests are available <a href="https://github.com/wattsm/odata-graph-delta/blob/master/ODataGraphDelta.Tests/TypedGraphDelta.cs">here</a>.</p>

<p><strong>Note</strong> that this is a minimal implementation that does just enough to meet the basic requirements - e.g. it does not handle collections as how item matching is performed
will likely be specific to your services.</p>

<h3>Using GraphDelta&lt;T&gt;</h3>

<p>In order for WebAPI to be able to correctly deserialise the JSON in MERGE/PATCH requests to <code>GraphDelta&lt;T&gt;</code> we need to create a specific formatter. The formatter is configured such that it can 
only be used to read <code>GraphDelta&lt;T&gt;</code> with media type <code>application/json</code>, and it simply reads the request stream into a <code>JObject</code> and then passes it to the 
constructor of <code>GraphDelta&lt;T&gt;</code>. You can see the full code for the formatter <a href="https://github.com/wattsm/odata-graph-delta/blob/master/ODataGraphDelta/GraphDeltaFormatter.cs">here</a>.</p>

<p>We can then register this formatter with WebAPI:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">config</span><span class="p">.</span><span class="n">Formatters</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">GraphDeltaFormatter</span><span class="p">());</span>
</code></pre></div>
<p>Now our controller methods for MERGE/PATCH can accept <code>GraphDelta&lt;T&gt;</code>, and complex types can be updated in the same way as entities using the <code>Patch</code> method:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="na">[AcceptVerbs(&quot;MERGE,PATCH&quot;)]</span>
<span class="k">public</span> <span class="n">IHttpActionResult</span> <span class="nf">Patch</span><span class="p">([</span><span class="n">FromODataUri</span><span class="p">]</span> <span class="n">key</span><span class="p">,</span> <span class="n">GraphDelta</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">delta</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//Validate the request, get the entity and call delta.Patch</span>
<span class="p">}</span>
</code></pre></div>
<h3>Conclusion</h3>

<p>In this post I have briefly summarised how I created an alternative to WebAPI OData&#39;s <code>Delta&lt;T&gt;</code> type that applies updates to complex types in
the same as to entities and how to use it. The full source code is <a href="https://github.com/wattsm/odata-graph-delta">available on GitHub</a>.</p>

</div>

<div class="comments">
	<h3>Comments</h3>

	<div id="disqus_thread"></div>
	<script type="text/javascript">
		/* * * CONFIGURATION VARIABLES * * */
		var disqus_shortname = 'usermaatre';
		var disqus_title = "WebAPI OData GraphDelta<T>";
		var disqus_identifier = "WebAPI OData GraphDelta<T>";
		
		/* * * DON'T EDIT BELOW THIS LINE * * */
		(function() {
			var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
    
      <li>
        <h5>
          <a href="/programming/2014/12/12/testing-web-api-odata-controllers/">
            Testing Web API OData controllers
            <small>12 Dec 2014</small>
          </a>
        </h5>
      </li>
    
      <li>
        <h5>
          <a href="/programming/2013/07/24/fsharp-collections-reflection/">
            Creating F# collections via reflection
            <small>24 Jul 2013</small>
          </a>
        </h5>
      </li>
    
      <li>
        <h5>
          <a href="/programming/2015/01/19/futures-in-fsharp/">
            Futures in F#
            <small>19 Jan 2015</small>
          </a>
        </h5>
      </li>
    
  </ul>
</div>
    </div>

	
	<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'usermaatre';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
  </body>
</html>
