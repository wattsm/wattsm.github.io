<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="https://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Constructing lenses using quotations &middot; try/finally
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        try/finally
      </a>
    </div>
    <p class="lead">Occasional programming thoughts of Mark Watts.</p>
  </header>
  <nav id="sidebar-nav-links">
  
  

  

  


  
    
  

  
    
      <a class="page-link "
          href="/about/">About</a>
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  


  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  
    <span class="site-version">Currently v1.0</span>
  

  <nav id="sidebar-icon-links">
  

  
  
  
  

  <a id="github-link"
      class="icon"
      title="GitHub" aria-label="GitHub"
      href="https://github.com/wattsm"
      target="_blank">
    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 28" height="24" width="28"><path d="M12 2c6.625 0 12 5.375 12 12 0 5.297-3.437 9.797-8.203 11.391-0.609 0.109-0.828-0.266-0.828-0.578 0-0.391 0.016-1.687 0.016-3.297 0-1.125-0.375-1.844-0.812-2.219 2.672-0.297 5.484-1.313 5.484-5.922 0-1.313-0.469-2.375-1.234-3.219 0.125-0.313 0.531-1.531-0.125-3.187-1-0.313-3.297 1.234-3.297 1.234-0.953-0.266-1.984-0.406-3-0.406s-2.047 0.141-3 0.406c0 0-2.297-1.547-3.297-1.234-0.656 1.656-0.25 2.875-0.125 3.187-0.766 0.844-1.234 1.906-1.234 3.219 0 4.594 2.797 5.625 5.469 5.922-0.344 0.313-0.656 0.844-0.766 1.609-0.688 0.313-2.438 0.844-3.484-1-0.656-1.141-1.844-1.234-1.844-1.234-1.172-0.016-0.078 0.734-0.078 0.734 0.781 0.359 1.328 1.75 1.328 1.75 0.703 2.141 4.047 1.422 4.047 1.422 0 1 0.016 1.937 0.016 2.234 0 0.313-0.219 0.688-0.828 0.578-4.766-1.594-8.203-6.094-8.203-11.391 0-6.625 5.375-12 12-12zM4.547 19.234c0.031-0.063-0.016-0.141-0.109-0.187-0.094-0.031-0.172-0.016-0.203 0.031-0.031 0.063 0.016 0.141 0.109 0.187 0.078 0.047 0.172 0.031 0.203-0.031zM5.031 19.766c0.063-0.047 0.047-0.156-0.031-0.25-0.078-0.078-0.187-0.109-0.25-0.047-0.063 0.047-0.047 0.156 0.031 0.25 0.078 0.078 0.187 0.109 0.25 0.047zM5.5 20.469c0.078-0.063 0.078-0.187 0-0.297-0.063-0.109-0.187-0.156-0.266-0.094-0.078 0.047-0.078 0.172 0 0.281s0.203 0.156 0.266 0.109zM6.156 21.125c0.063-0.063 0.031-0.203-0.063-0.297-0.109-0.109-0.25-0.125-0.313-0.047-0.078 0.063-0.047 0.203 0.063 0.297 0.109 0.109 0.25 0.125 0.313 0.047zM7.047 21.516c0.031-0.094-0.063-0.203-0.203-0.25-0.125-0.031-0.266 0.016-0.297 0.109s0.063 0.203 0.203 0.234c0.125 0.047 0.266 0 0.297-0.094zM8.031 21.594c0-0.109-0.125-0.187-0.266-0.172-0.141 0-0.25 0.078-0.25 0.172 0 0.109 0.109 0.187 0.266 0.172 0.141 0 0.25-0.078 0.25-0.172zM8.937 21.438c-0.016-0.094-0.141-0.156-0.281-0.141-0.141 0.031-0.234 0.125-0.219 0.234 0.016 0.094 0.141 0.156 0.281 0.125s0.234-0.125 0.219-0.219z"></path>
</svg>

  </a>

  
    <a id="tags-link"
       class="icon"
       title="Tags" aria-label="Tags"
       href="/tags/">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
    </a>
  

  
    <a id="search-link"
       class="icon"
       title="Search" aria-label="Search"
       href="/search/">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</svg>
    </a>
  

  <!-- Optional additional links to insert for icons links -->
</nav>

  <p>
  &copy; 2020.  
</p>

</div>

    <main class="container">
      <header>
  <h1 class="post-title">Constructing lenses using quotations</h1>
</header>
<div class="content">
  <div class="post-meta">
  <span class="post-date">20 Nov 2015</span>
  <span class="post-categories">
    
      &bull;

      
      
      

      
        programming
      
    
      &bull;

      
      
      

      
        fsharp
      
    
  </span>
</div>


  <div class="post-body">
    <p>Earlier this month I wrote a post describing <a href="http://blog.usermaatre.co.uk/programming/2015/10/15/lenses-in-fsharp/">lenses in F#</a>. Lenses are a nice tool for reducing the amount of boilerplate code required when working with
record types, most notably when performing updates. However, the lenses themselves contain a fair amount of boilerplate, with most taking the form:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="k">member</span> <span class="nc">Lens_</span> <span class="p">=</span> 
  <span class="p">(</span><span class="k">fun</span> <span class="n">source</span> <span class="p">-&gt;</span> <span class="n">source</span><span class="p">.</span><span class="nc">View</span><span class="o">),</span>
  <span class="p">(</span><span class="k">fun</span> <span class="n">view</span> <span class="n">source</span> <span class="p">-&gt;</span> <span class="p">{</span> <span class="n">source</span> <span class="k">with</span> <span class="nc">View</span> <span class="p">=</span> <span class="n">view</span><span class="p">;</span> <span class="o">})</span>
</code></pre></div></div>

<p>I was intrigued, then, when I saw <a href="https://medium.com/@devboy_org/generic-lenses-for-f-record-types-6aea9f4cba40">Dominic Graefen’s post</a> about dynamic lenses using quotations and reflection. His post outlines a way to create a type of lens that 
requires essentially no boilerplate code. Dominic’s approach provides direct update access to record properties without the need for <code class="highlighter-rouge">Lens&lt;'TSource, 'TView&gt;</code> lens properties:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">original</span> <span class="p">=</span> <span class="p">{</span> <span class="nc">View</span> <span class="p">=</span> <span class="s2">"Original Value"</span><span class="p">;</span> <span class="p">}</span>
<span class="k">let</span> <span class="n">updated</span> <span class="p">=</span> <span class="nn">Lens</span><span class="p">.</span><span class="nc">With</span> <span class="o">&lt;@</span> <span class="n">original</span><span class="p">.</span><span class="nc">View</span> <span class="o">@&gt;</span> <span class="s2">"New Value"</span>
</code></pre></div></div>

<p>In this post I will describe how the same approach of using quotations and reflection can be used to create lens properties.</p>

<!-- more -->

<h3 id="motivation">Motivation</h3>

<p>There are two motivations for wanting lens properties on our record types.</p>

<p>Firstly they are potentially useful - they are reusable (i.e. a traditional lens can be passed around and applied to any instance of the source record type, whereas the 
dynamic versions are tied to a specific instance), composable and represent a standard pattern which can be used to interface with the code of other developers 
and third party libraries.</p>

<p>Secondly constructing the lens when the type is initialised, rather than on-demand may help improve performance. As Dominic says in his post both quotations and 
reflection can be detrimental to performance.</p>

<p>Ideally we would like a way to create lens properties with less boilerplate, e.g.:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="k">member</span> <span class="nc">Lens_</span> <span class="p">=</span> <span class="nn">Lens</span><span class="p">.</span><span class="n">make</span> <span class="o">&lt;@</span> <span class="k">fun</span> <span class="n">source</span> <span class="p">-&gt;</span> <span class="n">source</span><span class="p">.</span><span class="nc">View</span> <span class="o">@&gt;</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">Lens.make</code> function accepts an expression which points to the view and returns a lens. It has the signature <code class="highlighter-rouge">Expr&lt;'TSource -&gt; 'TView&gt; -&gt; Lens&lt;'TSource, 'TView&gt;</code>.</p>

<h3 id="implementation">Implementation</h3>

<p>If we assume that the <code class="highlighter-rouge">Lens</code> module used in <a href="http://blog.usermaatre.co.uk/programming/2015/10/15/lenses-in-fsharp/">my previous post</a> is the starting point then it’s actually quite straight forward to take Dominic’s approach and tweak it to construct
lenses of type <code class="highlighter-rouge">Lens&lt;'TSource, 'TView&gt;</code>. Using a simple lambda expression to point to the property of interest also helps simplify the code that parses the quotation.</p>

<p>Here is a basic implementation of <code class="highlighter-rouge">Lens.make</code> with supporting functions:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[&lt;</span><span class="nc">RequireQualifiedAccess</span><span class="p">&gt;]</span>
<span class="k">module</span> <span class="nc">Lens</span> <span class="p">=</span> 

    <span class="p">[&lt;</span><span class="nc">AutoOpen</span><span class="p">&gt;]</span>
    <span class="k">module</span> <span class="k">private</span> <span class="nc">Helpers</span> <span class="p">=</span> 
    
        <span class="k">let</span> <span class="n">getProperty</span> <span class="p">(</span><span class="n">expr</span> <span class="p">:</span> <span class="nc">Expr</span><span class="p">)</span> <span class="p">=</span> 
            <span class="k">match</span> <span class="n">expr</span> <span class="k">with</span>
            <span class="p">|</span> <span class="nc">Lambda</span> <span class="o">(_,</span> <span class="nc">PropertyGet</span> <span class="o">(_,</span> <span class="n">property</span><span class="p">,</span> <span class="o">_))</span> <span class="p">-&gt;</span> <span class="nc">Some</span> <span class="n">property</span>
            <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="nc">None</span>

        <span class="k">let</span> <span class="n">getUpdatedRecord</span><span class="p">&lt;</span><span class="k">'</span><span class="nc">TSource</span><span class="p">&gt;</span> <span class="p">(</span><span class="n">original</span> <span class="p">:</span> <span class="k">'</span><span class="nc">TSource</span><span class="p">)</span> <span class="p">(</span><span class="n">property</span> <span class="p">:</span> <span class="nc">PropertyInfo</span><span class="p">)</span> <span class="n">value</span> <span class="p">=</span> 

            <span class="k">let</span> <span class="n">recordType</span> <span class="p">=</span> <span class="n">typeof</span><span class="p">&lt;</span><span class="k">'</span><span class="nc">TSource</span><span class="p">&gt;</span>
            <span class="k">let</span> <span class="n">properties</span> <span class="p">=</span> <span class="nn">FSharpType</span><span class="p">.</span><span class="nc">GetRecordFields</span> <span class="n">recordType</span>

            <span class="k">let</span> <span class="n">values</span> <span class="p">=</span> 
                <span class="n">properties</span>
                <span class="p">|&gt;</span> <span class="nn">Array</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">property'</span> <span class="p">-&gt;</span> 
                        <span class="k">if</span> <span class="p">(</span><span class="n">property'</span> <span class="p">=</span> <span class="n">property</span><span class="p">)</span> <span class="k">then</span>
                            <span class="n">value</span>
                        <span class="k">else</span>
                            <span class="n">property'</span><span class="p">.</span><span class="nc">GetValue</span> <span class="n">original</span>
                    <span class="p">)</span>

            <span class="k">let</span> <span class="n">updated</span> <span class="p">=</span> <span class="nn">FSharpValue</span><span class="p">.</span><span class="nc">MakeRecord</span> <span class="p">(</span><span class="n">recordType</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

            <span class="n">updated</span> <span class="o">:?&gt;</span> <span class="k">'</span><span class="nc">TSource</span>

        <span class="k">let</span> <span class="n">withProperty</span> <span class="n">expr</span> <span class="n">f</span> <span class="p">=</span> 
            <span class="k">match</span> <span class="p">(</span><span class="n">getProperty</span> <span class="n">expr</span><span class="p">)</span> <span class="k">with</span>
            <span class="p">|</span> <span class="nc">Some</span> <span class="n">property</span> <span class="p">-&gt;</span> <span class="n">f</span> <span class="n">property</span>
            <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Expression must be a lambda of form: fun source -&gt; source.View"</span>

        <span class="k">let</span> <span class="n">createGet</span><span class="p">&lt;</span><span class="k">'</span><span class="nc">TSource</span><span class="p">,</span> <span class="k">'</span><span class="nc">TView</span><span class="p">&gt;</span> <span class="p">(</span><span class="n">expr</span> <span class="p">:</span> <span class="nc">Expr</span><span class="p">&lt;</span><span class="k">'</span><span class="nc">TSource</span> <span class="p">-&gt;</span> <span class="k">'</span><span class="nc">TView</span><span class="o">&gt;)</span> <span class="p">=</span> 
            <span class="n">withProperty</span> <span class="n">expr</span> <span class="p">(</span><span class="k">fun</span> <span class="n">property</span> <span class="p">-&gt;</span> 
                <span class="k">fun</span> <span class="p">(</span><span class="n">source</span> <span class="p">:</span> <span class="k">'</span><span class="nc">TSource</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">property</span><span class="p">.</span><span class="nc">GetValue</span> <span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="o">:?&gt;</span> <span class="k">'</span><span class="nc">TView</span>
            <span class="p">)</span>

        <span class="k">let</span> <span class="n">createPut</span><span class="p">&lt;</span><span class="k">'</span><span class="nc">TSource</span><span class="p">,</span> <span class="k">'</span><span class="nc">TView</span><span class="p">&gt;</span> <span class="p">(</span><span class="n">expr</span> <span class="p">:</span> <span class="nc">Expr</span><span class="p">&lt;</span><span class="k">'</span><span class="nc">TSource</span> <span class="p">-&gt;</span> <span class="k">'</span><span class="nc">TView</span><span class="o">&gt;)</span> <span class="p">=</span> 
            <span class="n">withProperty</span> <span class="n">expr</span> <span class="p">(</span><span class="k">fun</span> <span class="n">property</span> <span class="p">-&gt;</span>
                <span class="k">fun</span> <span class="p">(</span><span class="n">view</span> <span class="p">:</span> <span class="k">'</span><span class="nc">TView</span><span class="p">)</span> <span class="p">(</span><span class="n">source</span> <span class="p">:</span> <span class="k">'</span><span class="nc">TSource</span><span class="p">)</span> <span class="p">-&gt;</span>  <span class="n">getUpdatedRecord</span> <span class="n">source</span> <span class="n">property</span> <span class="n">view</span>
            <span class="p">)</span>

    <span class="k">let</span> <span class="n">make</span> <span class="n">expr</span> <span class="p">=</span> 
        <span class="p">(</span><span class="n">createGet</span> <span class="n">expr</span><span class="o">),</span>
        <span class="p">(</span><span class="n">createPut</span> <span class="n">expr</span><span class="p">)</span>
</code></pre></div></div>

<p>Lenses created using <code class="highlighter-rouge">Lens.make</code> will use reflection when called but the quotation parsing is only done once, when the type is initialised. Performance-wise this approach
speeds things up slightly. Using a similar approach to the author of the <a href="https://bitbucket.org/rojepp/reflenses/src/0c80f965aeaa?at=default">Reflenses project</a> that Dominic links to in his post we can run some basic tests:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">open</span> <span class="nc">System</span>
<span class="k">open</span> <span class="nn">System</span><span class="p">.</span><span class="nc">Diagnostics</span>

<span class="c1">//Records</span>
<span class="k">type</span> <span class="nc">Person</span> <span class="p">=</span> <span class="p">{</span>
  <span class="nc">Name</span> <span class="p">:</span> <span class="nc">String</span><span class="p">;</span>
  <span class="nc">Age</span> <span class="p">:</span> <span class="nc">Int32</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">with</span>  
  <span class="k">static</span> <span class="k">member</span> <span class="nc">Age_</span> <span class="p">=</span> <span class="nn">Lens</span><span class="p">.</span><span class="n">make</span> <span class="o">&lt;@</span> <span class="k">fun</span> <span class="n">person</span> <span class="p">-&gt;</span> <span class="n">person</span><span class="p">.</span><span class="nc">Age</span> <span class="o">@&gt;</span>

<span class="k">type</span> <span class="nc">Employee</span> <span class="p">=</span> <span class="p">{</span>
  <span class="nc">Payroll</span> <span class="p">:</span> <span class="nc">String</span><span class="p">;</span>
  <span class="nc">Person</span> <span class="p">:</span> <span class="nc">Person</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">with</span>  
  <span class="k">static</span> <span class="k">member</span> <span class="nc">Person_</span> <span class="p">=</span> <span class="nn">Lens</span><span class="p">.</span><span class="n">make</span> <span class="o">&lt;@</span> <span class="k">fun</span> <span class="n">employee</span> <span class="p">-&gt;</span> <span class="n">employee</span><span class="p">.</span><span class="nc">Person</span> <span class="o">@&gt;</span>

<span class="c1">//Test timer</span>
<span class="k">let</span> <span class="k">inline</span> <span class="n">time</span> <span class="n">f</span> <span class="n">iterations</span> <span class="p">=</span> 
  
  <span class="k">let</span> <span class="n">stopwatch</span> <span class="p">=</span> <span class="nn">Stopwatch</span><span class="p">.</span><span class="nc">StartNew</span> <span class="bp">()</span>
  
  <span class="k">for</span> <span class="p">_</span> <span class="k">in</span> <span class="mi">1</span> <span class="p">..</span> <span class="n">iterations</span> <span class="k">do</span>
    <span class="n">f</span> <span class="bp">()</span> <span class="p">|&gt;</span> <span class="n">ignore</span>
    
  <span class="n">stopwatch</span><span class="p">.</span><span class="nc">Stop</span> <span class="bp">()</span>
  
  <span class="n">printfn</span> <span class="s2">"%A"</span> <span class="n">stopwatch</span><span class="p">.</span><span class="nc">ElapsedMilliseconds</span>
  
<span class="c1">//Test data</span>
<span class="k">let</span> <span class="n">employee</span> <span class="p">=</span> <span class="p">{</span> <span class="nc">Payroll</span> <span class="p">=</span> <span class="s2">"XXXX"</span><span class="p">;</span> <span class="nc">Person</span> <span class="p">=</span> <span class="p">{</span> <span class="nc">Name</span> <span class="p">=</span>  <span class="s2">"Bob"</span><span class="p">;</span> <span class="nc">Age</span> <span class="p">=</span> <span class="mi">30</span><span class="p">;</span> <span class="o">};</span> <span class="p">}</span>

<span class="c1">//Tests of lenses using Lens.make</span>
<span class="k">let</span> <span class="n">lens</span> <span class="p">=</span> <span class="p">(</span><span class="nn">Employee</span><span class="p">.</span><span class="nc">Person_</span> <span class="o">&gt;=&gt;</span> <span class="nn">Person</span><span class="p">.</span><span class="nc">Age_</span><span class="p">)</span>

<span class="n">time</span> <span class="p">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="p">-&gt;</span> <span class="nn">Lens</span><span class="p">.</span><span class="n">put</span> <span class="n">lens</span> <span class="mi">25</span> <span class="n">employee</span><span class="p">)</span> <span class="mi">1000</span>                 <span class="c1">//90 ms</span>
<span class="n">time</span> <span class="p">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="p">-&gt;</span> <span class="nn">Lens</span><span class="p">.</span><span class="n">put</span> <span class="p">(</span><span class="nn">Employee</span><span class="p">.</span><span class="nc">Person_</span> <span class="o">&gt;=&gt;</span> <span class="nn">Person</span><span class="p">.</span><span class="nc">Age_</span><span class="p">)</span> <span class="mi">25</span> <span class="n">employee</span><span class="p">)</span> <span class="mi">1000</span>   <span class="c1">//152 ms</span>

<span class="c1">//Tests of lenses using Lens.With</span>
<span class="k">let</span> <span class="n">expr</span> <span class="p">=</span> <span class="o">&lt;@</span> <span class="n">employee</span><span class="p">.</span><span class="nn">Person</span><span class="p">.</span><span class="nc">Age</span> <span class="o">@&gt;</span>

<span class="n">time</span> <span class="p">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="p">-&gt;</span> <span class="nn">Lens</span><span class="p">.</span><span class="nc">With</span> <span class="n">expr</span> <span class="mi">25</span><span class="p">)</span> <span class="mi">1000</span>                     <span class="c1">//316 ms</span>
<span class="n">time</span> <span class="p">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="p">-&gt;</span> <span class="nn">Lens</span><span class="p">.</span><span class="nc">With</span> <span class="o">&lt;@</span> <span class="n">employee</span><span class="p">.</span><span class="nn">Person</span><span class="p">.</span><span class="nc">Age</span> <span class="o">@&gt;</span> <span class="mi">25</span><span class="p">)</span> <span class="mi">1000</span>           <span class="c1">//355 ms</span>
</code></pre></div></div>

<p>Both approachs can obviously be optimised further (e.g. via memoization <a href="https://bitbucket.org/rojepp/reflenses/src/0c80f965aeaad6846cf9dddc3952b8d44230ba1c/Reflenses/Reflenses.fs?at=default&amp;fileviewer=file-view-default">as demonstrated here by Reflenses</a>), but the lenses constructed by <code class="highlighter-rouge">Lens.make</code> seem to perform
significantly better than dynamic lenses. As both use essentially the same code to create updated records the difference is likely entirely due to quotation parsing done 
by the dynamic lenses.</p>

<h3 id="conclusion">Conclusion</h3>

<p>In this post I have shown how to use quotations and reflection to reduce the boilerplate code required when defining lenses for record types.</p>

<p>Ultimately I think that a <code class="highlighter-rouge">Lens</code> module with support for both traditional <code class="highlighter-rouge">Lens&lt;'TSource, 'TView&gt;</code> lenses and dynamic lenses provides the most flexibility 
for developers, with both approaches having pros and cons depending on the scenario.</p>

<p>For example, in order to update a property nested deep within a record type that is only updated once it would be preferable, in terms of readability and effort required, to simply
use a dynamic lens to perform the udpate. However, when working with more frequently used properties having ready made lenses which can be reused and combined might make more sense.</p>


    



<div class="post-tags">
  
    
    <a href="/tags/#fsharp">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">fsharp</span>
    </a>
  
    
    <a href="/tags/#dotnet">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">dotnet</span>
    </a>
  
    
    <a href="/tags/#lenses">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">lenses</span>
    </a>
  
</div>
  </div>

  
  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/programming/fsharp/2015/10/15/lenses-in-fsharp/">
            Lenses in F#
            <small>15 Oct 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/programming/fsharp/2016/01/19/optimising-civ5-cities-using-genetic-algorithms/">
            Optimising Civ 5 cities using genetic algorithms
            <small>19 Jan 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/programming/fsharp/2015/05/20/modeling-historical-dates/">
            Modeling historical dates
            <small>20 May 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>

    <!-- Optional footer content -->

  </body>
</html>
