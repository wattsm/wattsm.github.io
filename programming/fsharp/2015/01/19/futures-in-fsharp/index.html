<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="https://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Futures in F# &middot; try/finally
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        try/finally
      </a>
    </div>
    <p class="lead">Occasional programming thoughts of Mark Watts.</p>
  </header>
  <nav id="sidebar-nav-links">
  
  

  

  


  
    
  

  
    
      <a class="page-link "
          href="/about/">About</a>
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  


  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  
    <span class="site-version">Currently v1.0</span>
  

  <nav id="sidebar-icon-links">
  

  
  
  
  

  <a id="github-link"
      class="icon"
      title="GitHub" aria-label="GitHub"
      href="https://github.com/wattsm"
      target="_blank">
    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 28" height="24" width="28"><path d="M12 2c6.625 0 12 5.375 12 12 0 5.297-3.437 9.797-8.203 11.391-0.609 0.109-0.828-0.266-0.828-0.578 0-0.391 0.016-1.687 0.016-3.297 0-1.125-0.375-1.844-0.812-2.219 2.672-0.297 5.484-1.313 5.484-5.922 0-1.313-0.469-2.375-1.234-3.219 0.125-0.313 0.531-1.531-0.125-3.187-1-0.313-3.297 1.234-3.297 1.234-0.953-0.266-1.984-0.406-3-0.406s-2.047 0.141-3 0.406c0 0-2.297-1.547-3.297-1.234-0.656 1.656-0.25 2.875-0.125 3.187-0.766 0.844-1.234 1.906-1.234 3.219 0 4.594 2.797 5.625 5.469 5.922-0.344 0.313-0.656 0.844-0.766 1.609-0.688 0.313-2.438 0.844-3.484-1-0.656-1.141-1.844-1.234-1.844-1.234-1.172-0.016-0.078 0.734-0.078 0.734 0.781 0.359 1.328 1.75 1.328 1.75 0.703 2.141 4.047 1.422 4.047 1.422 0 1 0.016 1.937 0.016 2.234 0 0.313-0.219 0.688-0.828 0.578-4.766-1.594-8.203-6.094-8.203-11.391 0-6.625 5.375-12 12-12zM4.547 19.234c0.031-0.063-0.016-0.141-0.109-0.187-0.094-0.031-0.172-0.016-0.203 0.031-0.031 0.063 0.016 0.141 0.109 0.187 0.078 0.047 0.172 0.031 0.203-0.031zM5.031 19.766c0.063-0.047 0.047-0.156-0.031-0.25-0.078-0.078-0.187-0.109-0.25-0.047-0.063 0.047-0.047 0.156 0.031 0.25 0.078 0.078 0.187 0.109 0.25 0.047zM5.5 20.469c0.078-0.063 0.078-0.187 0-0.297-0.063-0.109-0.187-0.156-0.266-0.094-0.078 0.047-0.078 0.172 0 0.281s0.203 0.156 0.266 0.109zM6.156 21.125c0.063-0.063 0.031-0.203-0.063-0.297-0.109-0.109-0.25-0.125-0.313-0.047-0.078 0.063-0.047 0.203 0.063 0.297 0.109 0.109 0.25 0.125 0.313 0.047zM7.047 21.516c0.031-0.094-0.063-0.203-0.203-0.25-0.125-0.031-0.266 0.016-0.297 0.109s0.063 0.203 0.203 0.234c0.125 0.047 0.266 0 0.297-0.094zM8.031 21.594c0-0.109-0.125-0.187-0.266-0.172-0.141 0-0.25 0.078-0.25 0.172 0 0.109 0.109 0.187 0.266 0.172 0.141 0 0.25-0.078 0.25-0.172zM8.937 21.438c-0.016-0.094-0.141-0.156-0.281-0.141-0.141 0.031-0.234 0.125-0.219 0.234 0.016 0.094 0.141 0.156 0.281 0.125s0.234-0.125 0.219-0.219z"></path>
</svg>

  </a>

  
    <a id="tags-link"
       class="icon"
       title="Tags" aria-label="Tags"
       href="/tags/">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
    </a>
  

  
    <a id="search-link"
       class="icon"
       title="Search" aria-label="Search"
       href="/search/">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</svg>
    </a>
  

  <!-- Optional additional links to insert for icons links -->
</nav>

  <p>
  &copy; 2020.  
</p>

</div>

    <main class="container">
      <header>
  <h1 class="post-title">Futures in F#</h1>
</header>
<div class="content">
  <div class="post-meta">
  <span class="post-date">19 Jan 2015</span>
  <span class="post-categories">
    
      &bull;

      
      
      

      
        programming
      
    
      &bull;

      
      
      

      
        fsharp
      
    
  </span>
</div>


  <div class="post-body">
    <p>My first exposure to the concept of <a href="http://en.wikipedia.org/wiki/Futures_and_promises">futures (or promises)</a> was probably JavaScript’s <a href="https://github.com/kriskowal/q/wiki/API-Reference">Q API</a> and AngularJS’ <a href="https://docs.angularjs.org/api/ng/service/$q">$q service</a>, but it was only after reading Twitter’s 
“<a href="https://engineering.twitter.com/research/publication/your-server-as-a-function">Your Server as a Function</a>” paper that their usefulness really sank in. The closest thing that .Net has to the Scala futures illustrated in the paper are <code class="highlighter-rouge">Task&lt;T&gt;</code> and 
F#’s <code class="highlighter-rouge">Async&lt;'T&gt;</code>. Although these types are useful they do not provide all of the functionality of Scala’s <code class="highlighter-rouge">Future[T]</code>, nor are they as elegant.</p>

<p>In this post I will describe an approach to creating something akin to Scala’s <code class="highlighter-rouge">Future[T]</code> in F#.</p>

<!-- more -->

<h3 id="defining-a-future">Defining a future</h3>

<p>A broad definition of a future would be an asynchronous computation which may or may not succeed. As this post is about F# we will base our solution on the 
<code class="highlighter-rouge">Async&lt;'T&gt;</code> type (<code class="highlighter-rouge">Async.AwaitTask</code> function can be used to convert a <code class="highlighter-rouge">Task&lt;T&gt;</code> to <code class="highlighter-rouge">Async&lt;'T&gt;</code> if required).</p>

<p>We can define a discriminated union to represent the result of a future:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="nc">Outcome</span><span class="p">&lt;</span><span class="k">'</span><span class="n">a</span><span class="p">&gt;</span> <span class="p">=</span> 
	<span class="p">|</span> <span class="nc">Success</span> <span class="k">of</span> <span class="k">'</span><span class="n">a</span>
	<span class="p">|</span> <span class="nc">Failure</span> <span class="k">of</span> <span class="nc">Exception</span>
</code></pre></div></div>

<p>Using this we can define a future as:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="nc">Future</span><span class="p">&lt;</span><span class="k">'</span><span class="n">a</span><span class="p">&gt;</span> <span class="p">=</span> <span class="nc">Async</span><span class="p">&lt;</span><span class="nc">Outcome</span><span class="p">&lt;</span><span class="k">'</span><span class="n">a</span><span class="o">&gt;&gt;</span>
</code></pre></div></div>

<h3 id="creating-a-future">Creating a future</h3>

<p>Now that we have a definition of a future, we can think about ways that we might want to create them in our code.</p>

<p>We could create a future explicitly:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">future</span> <span class="p">=</span> 
	<span class="n">async</span> <span class="p">{</span>
		<span class="k">try</span>
			<span class="k">return</span> <span class="p">(</span><span class="nn">Success</span> <span class="p">...</span><span class="err">)</span>
		<span class="n">with</span>
		<span class="p">|</span> <span class="n">e</span> <span class="p">-&gt;</span> <span class="k">return</span> <span class="p">(</span><span class="nc">Failure</span> <span class="n">e</span><span class="p">)</span>
	<span class="p">}</span>
</code></pre></div></div>

<p>However, in order to reduce the amount of boilerplate required and generally neaten our code we can create a helper function to wrap
an <code class="highlighter-rouge">Async&lt;'T&gt;</code> to create a future:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//Async&lt;'a&gt; -&gt; Future&lt;'a&gt;</span>
<span class="k">let</span> <span class="n">wrap</span> <span class="n">computation</span> <span class="p">=</span> 
	<span class="n">async</span> <span class="p">{</span>
	
		<span class="k">let</span><span class="o">!</span> <span class="n">choice</span> <span class="p">=</span> <span class="p">(</span><span class="nn">Async</span><span class="p">.</span><span class="nc">Catch</span> <span class="n">computation</span><span class="p">)</span>
	
		<span class="k">return</span> <span class="p">(</span><span class="nn">Outcome</span><span class="p">.</span><span class="n">ofChoice</span> <span class="n">choice</span><span class="p">)</span>
	<span class="p">}</span>
</code></pre></div></div>

<p>This function accepts an <code class="highlighter-rouge">Async&lt;'T&gt;</code> and returns a <code class="highlighter-rouge">Future&lt;'T&gt;</code>. We use <code class="highlighter-rouge">Async.Catch</code> for exception handling which converts the <code class="highlighter-rouge">Async&lt;'T&gt;</code> to <code class="highlighter-rouge">Aync&lt;Choice&lt;'T, exn&gt;&gt;</code>. This <code class="highlighter-rouge">Choice</code> is
then converted to an <code class="highlighter-rouge">Outcome&lt;'T&gt;</code> using a simple conversion function:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">ofChoice</span> <span class="p">=</span> <span class="k">function</span>
	<span class="p">|</span> <span class="nc">Choice1Of2</span> <span class="n">value</span> <span class="p">-&gt;</span> <span class="nc">Success</span> <span class="n">value</span>
	<span class="p">|</span> <span class="nc">Choice2Of2</span> <span class="n">e</span> <span class="p">-&gt;</span> <span class="nc">Failure</span> <span class="n">e</span>
</code></pre></div></div>

<p>You may be asking why I did not just define <code class="highlighter-rouge">Future&lt;'T&gt;</code> using <code class="highlighter-rouge">Choice&lt;'T, exn&gt;</code>? My main reason is that I think <code class="highlighter-rouge">Outcome&lt;'T&gt;</code> has better
semantics - <code class="highlighter-rouge">Success</code> and <code class="highlighter-rouge">Failure</code> have a clearer meaning than <code class="highlighter-rouge">Choice1Of2</code> and <code class="highlighter-rouge">Choice2Of2</code>.</p>

<p>We can now create futures with minimal boilerplate and built-in exception handling:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">future</span> <span class="p">=</span> 
	<span class="nn">Future</span><span class="p">.</span><span class="n">wrap</span> <span class="p">(</span><span class="n">async</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">...</span>
	<span class="o">})</span>
</code></pre></div></div>

<p>Occasionally we may also want to create a future from a value:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">value</span> <span class="n">x</span> <span class="p">=</span> <span class="n">wrap</span> <span class="p">(</span><span class="n">async</span> <span class="p">{</span> <span class="k">return</span> <span class="n">x</span> <span class="o">})</span>
</code></pre></div></div>

<p>This allows us to do this:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//Future&lt;int&gt;</span>
<span class="k">let</span> <span class="n">future</span> <span class="p">=</span> <span class="nn">Future</span><span class="p">.</span><span class="n">value</span> <span class="mi">10</span> 
</code></pre></div></div>

<h3 id="working-with-futures">Working with futures</h3>

<p>The <a href="https://engineering.twitter.com/research/publication/your-server-as-a-function">Twitter paper</a> uses several handy functions for working with futures. This section outlines how to implement those functions, as well as a few others which may come in handy.</p>

<h5 id="flatmap">flatMap</h5>

<p>This function allows you to take the <code class="highlighter-rouge">Success</code> value of one future and create a new future by applying a mapping function to that value. This is analagous to the single argument
case of the <code class="highlighter-rouge">then</code> function of AngularJS’ <a href="https://docs.angularjs.org/api/ng/service/$q">$q service</a>.</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="n">flatMap</span> <span class="p">=</span> <span class="p">(</span><span class="k">'</span><span class="n">a</span> <span class="p">-&gt;</span> <span class="nc">Future</span><span class="p">&lt;</span><span class="k">'</span><span class="n">b</span><span class="o">&gt;)</span> <span class="p">-&gt;</span> <span class="nc">Future</span><span class="p">&lt;</span><span class="k">'</span><span class="n">a</span><span class="p">&gt;</span> <span class="p">-&gt;</span> <span class="nc">Future</span><span class="p">&lt;</span><span class="k">'</span><span class="n">b</span><span class="p">&gt;</span>
</code></pre></div></div>

<p>For our definition of a future <code class="highlighter-rouge">flatMap</code> looks like this:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">flatMap</span> <span class="n">f</span> <span class="n">future</span> <span class="p">=</span> 
	<span class="n">async</span> <span class="p">{</span>
		
		<span class="c1">//Evaluate the outcome of the first future</span>
		<span class="k">let</span><span class="o">!</span> <span class="n">outcome</span> <span class="p">=</span> <span class="n">future</span>
		
		<span class="c1">//Apply the mapping on success</span>
		<span class="k">match</span> <span class="n">outcome</span> <span class="k">with</span>
		<span class="p">|</span> <span class="nc">Success</span> <span class="n">value</span> <span class="p">-&gt;</span> <span class="k">return</span><span class="o">!</span> <span class="p">(</span><span class="n">f</span> <span class="n">value</span><span class="p">)</span>
		<span class="p">|</span> <span class="nc">Failure</span> <span class="n">e</span> <span class="p">-&gt;</span> <span class="nc">Failure</span> <span class="n">e</span>
	<span class="p">}</span>
</code></pre></div></div>

<p>Futures can now be mapped like this:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">let</span> <span class="n">createRequest</span> <span class="n">url</span> <span class="p">=</span> <span class="o">...</span>   <span class="c1">//String -&gt; Future&lt;HttpWebRequest&gt;</span>
<span class="k">let</span> <span class="n">parseResponse</span> <span class="n">req</span> <span class="p">=</span> <span class="o">...</span>   <span class="c1">//HttpWebRequest -&gt; Data</span>

<span class="c1">//String -&gt; Future&lt;Data&gt;</span>
<span class="k">let</span> <span class="n">getData</span> <span class="p">=</span> <span class="n">createRequest</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="nn">Future</span><span class="p">.</span><span class="n">flatMap</span> <span class="n">parseRequest</span><span class="p">)</span>
</code></pre></div></div>

<h5 id="map">map</h5>

<p>This function allows us to perform simpler mappings on futures, and is similar to <code class="highlighter-rouge">flatMap</code> but instead of using a mapping function with 
signature <code class="highlighter-rouge">'a -&gt; Future&lt;'b&gt;</code> we use one that has signature <code class="highlighter-rouge">'a -&gt; 'b</code>.</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//('a -&gt; 'b) -&gt; Future&lt;'a&gt; -&gt; Future&lt;'b&gt;</span>
<span class="k">let</span> <span class="n">map</span> <span class="n">f</span> <span class="p">=</span> 
	<span class="k">let</span> <span class="n">f'</span> <span class="n">value</span> <span class="p">=</span> <span class="n">wrap</span> <span class="p">(</span><span class="n">async</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="n">f</span> <span class="n">value</span><span class="p">)</span> <span class="o">})</span>
	<span class="k">in</span> <span class="n">flatMap</span> <span class="n">f'</span>
</code></pre></div></div>

<p>This function creates an asychronous version of <code class="highlighter-rouge">f</code> and then uses <code class="highlighter-rouge">wrap</code> to convert its application to a future. We can now perform simple mappings on futures:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">getOrder</span> <span class="n">orderId</span> <span class="p">=</span> <span class="o">...</span>     <span class="c1">//Int32 -&gt; Future&lt;Order&gt;</span>
<span class="k">let</span> <span class="n">getTotalCost</span> <span class="n">order</span> <span class="p">=</span> <span class="o">...</span>   <span class="c1">//Order -&gt; Decimal</span>

<span class="c1">//Int32 -&gt; Future&lt;Decimal&gt;</span>
<span class="k">let</span> <span class="n">getOrderCost</span> <span class="p">=</span> <span class="n">getOrder</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="nn">Future</span><span class="p">.</span><span class="n">map</span> <span class="n">getTotalCost</span><span class="p">)</span>
</code></pre></div></div>

<h5 id="rescue">rescue</h5>

<p>As described in the <a href="https://engineering.twitter.com/research/publication/your-server-as-a-function">Twitter paper</a> it is sometimes possible to recover from a failure in a future and to continue as normal. The <code class="highlighter-rouge">rescue</code> functions works in a similar
way to the <code class="highlighter-rouge">flatMap</code> function, allowing us to map a <code class="highlighter-rouge">Failure</code> outcome:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//(Exception -&gt; Future&lt;'a&gt;) -&gt; Future&lt;'a&gt; -&gt; Future&lt;'a&gt;</span>
<span class="k">let</span> <span class="n">rescue</span> <span class="n">f</span> <span class="n">future</span> <span class="p">=</span> 
	<span class="n">async</span> <span class="p">{</span>
	
		<span class="k">let</span><span class="o">!</span> <span class="n">outcome</span> <span class="p">=</span> <span class="n">future</span>
	
		<span class="k">match</span> <span class="n">outcome</span> <span class="k">with</span>
		<span class="p">|</span> <span class="nc">Success</span> <span class="n">value</span> <span class="p">-&gt;</span> <span class="k">return</span> <span class="p">(</span><span class="nc">Success</span> <span class="n">value</span><span class="p">)</span>
		<span class="p">|</span> <span class="nc">Failure</span> <span class="n">e</span> <span class="p">-&gt;</span> <span class="k">return</span><span class="o">!</span> <span class="p">(</span><span class="n">f</span> <span class="n">e</span><span class="p">)</span>
	<span class="p">}</span>
</code></pre></div></div>

<p>In use <code class="highlighter-rouge">rescue</code> looks like this:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">createRequest</span> <span class="n">url</span> <span class="p">=</span> <span class="o">...</span>     <span class="c1">//String -&gt; Future&lt;HttpWebRequest&gt;</span>
<span class="k">let</span> <span class="n">getResponse</span> <span class="n">req</span> <span class="p">=</span> <span class="o">...</span>       <span class="c1">//HttpWebRequest -&gt; Future&lt;HttpWebResponse&gt;</span>
<span class="k">let</span> <span class="n">handleWebException</span> <span class="n">e</span> <span class="p">=</span> <span class="o">...</span>  <span class="c1">//Exception -&gt; Future&lt;HttpWebResponse&gt;</span>

<span class="c1">//String -&gt; Future&lt;HttpWebResponse&gt;</span>
<span class="k">let</span> <span class="n">getData</span> <span class="p">=</span> 
	<span class="n">createRequest</span> 
	<span class="o">&gt;&gt;</span> <span class="p">(</span><span class="nn">Future</span><span class="p">.</span><span class="n">flatMap</span> <span class="n">getResponse</span><span class="p">)</span> 
	<span class="o">&gt;&gt;</span> <span class="p">(</span><span class="nn">Future</span><span class="p">.</span><span class="n">rescue</span> <span class="n">handleWebException</span><span class="p">)</span>
</code></pre></div></div>

<p>Here, if <code class="highlighter-rouge">getResponse</code> results in a <code class="highlighter-rouge">Failure</code> outcome then <code class="highlighter-rouge">handleWebException</code> will be used to attempt to recover.</p>

<h5 id="bind">bind</h5>

<p>The <code class="highlighter-rouge">bind</code> function allows us to combine two functions which return futures:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//('a -&gt; Future&lt;'b&gt;) -&gt; ('b -&gt; Future&lt;'c&gt;) -&gt; ('a -&gt; Future&lt;'c&gt;)</span>
<span class="k">let</span> <span class="n">bind</span> <span class="n">f</span> <span class="n">g</span> <span class="p">=</span> <span class="n">f</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">flatMap</span> <span class="n">g</span><span class="p">)</span>
</code></pre></div></div>

<p>You will notice that I have used the <code class="highlighter-rouge">&gt;&gt; (flatMap g)</code> pattern in several examples already. This can now be replaced with <code class="highlighter-rouge">bind</code>, for example using the code from
the section on <code class="highlighter-rouge">flatMap</code>:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//String -&gt; Future&lt;Data&gt;</span>
<span class="k">let</span> <span class="n">getData</span> <span class="p">=</span> <span class="nn">Future</span><span class="p">.</span><span class="n">bind</span> <span class="n">createRequest</span> <span class="n">parseResponse</span>
</code></pre></div></div>

<h5 id="chain">chain</h5>

<p>The <code class="highlighter-rouge">chain</code> function simply extends <code class="highlighter-rouge">bind</code> to accept any number of futures operating on the same type. This can be handy for creating
piplines. In order to do this I use <code class="highlighter-rouge">List.fold</code> and <code class="highlighter-rouge">bind</code> to combine futures, with the <code class="highlighter-rouge">value</code> function being used as the starting point to accept
the starting value.</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//('a -&gt; Future&lt;'a&gt;) list -&gt; ('a -&gt; Future&lt;'a&gt;)</span>
<span class="k">let</span> <span class="n">chain</span> <span class="n">futures</span> <span class="p">=</span> 
	<span class="n">futures</span>
	<span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">fold</span> <span class="n">bind</span> <span class="n">value</span>
</code></pre></div></div>

<p><strong>Note</strong> that writing this as simply <code class="highlighter-rouge">let chain = List.fold bind value</code> causes the compiler to prompt for type annotations which are more verbose than explicitly adding the <code class="highlighter-rouge">futures</code>
parameter.</p>

<p>An example of using <code class="highlighter-rouge">chain</code>:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">setAuthenticationHeader</span> <span class="n">req</span> <span class="p">=</span> <span class="o">...</span>   <span class="c1">//HttpWebRequest -&gt; Future&lt;HttpWebRequest&gt;</span>
<span class="k">let</span> <span class="n">setContentTypes</span> <span class="n">req</span> <span class="p">=</span> <span class="o">...</span>           <span class="c1">//HttpWebRequest -&gt; Future&lt;HttpWebRequest&gt;</span>
<span class="k">let</span> <span class="n">writeBody</span> <span class="n">body</span> <span class="n">req</span> <span class="p">=</span> <span class="o">...</span>            <span class="c1">//object -&gt; HttpWebRequest -&gt; Future&lt;HttpWebRequest&gt;</span>

<span class="c1">//object -&gt; HttpWebRequest -&gt; Future&lt;HttpWebRequest&gt;</span>
<span class="k">let</span> <span class="n">configureRequest</span> <span class="n">body</span> <span class="p">=</span> 
	<span class="k">let</span> <span class="n">writeBody'</span> <span class="p">=</span> <span class="n">writeBody</span> <span class="n">body</span>	
	<span class="k">in</span> <span class="nn">Future</span><span class="p">.</span><span class="n">chain</span> <span class="p">[</span>
		<span class="n">setAuthenticationHeader</span><span class="p">;</span>
		<span class="n">setContentTypes</span><span class="p">;</span>
		<span class="n">writeBody'</span><span class="p">;</span>
	<span class="p">]</span>
</code></pre></div></div>

<h4 id="operators">Operators</h4>

<p>We can make our futures easier to use and more elegant by defining a few <a href="http://www.readcopyupdate.com/blog/2014/09/10/custom-ops-associativity-precedence.html">custom operators</a> for <code class="highlighter-rouge">bind</code>, <code class="highlighter-rouge">map</code> and <code class="highlighter-rouge">rescue</code>:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
	<span class="c1">//('a -&gt; Future&lt;'b&gt;) -&gt; ('b -&gt; Future&lt;'c&gt;) -&gt; (a' -&gt; Future&lt;'c&gt;)</span>
	<span class="k">let</span> <span class="o">(-&gt;&gt;)</span> <span class="p">=</span> <span class="n">bind</span>
	
	<span class="c1">//('a -&gt; Future&lt;'b&gt;) -&gt; ('b -&gt; 'c) -&gt; ('a -&gt; Future&lt;'c&gt;)</span>
	<span class="k">let</span> <span class="o">(--&gt;)</span> <span class="n">f</span> <span class="n">g</span> <span class="p">=</span> <span class="n">f</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">map</span> <span class="n">g</span><span class="p">)</span>
	
	<span class="c1">//('a -&gt; Future&lt;'b&gt;) -&gt; (Exception -&gt; Future&lt;'b&gt;) -&gt; ('a -&gt; Future&lt;'b&gt;)</span>
	<span class="k">let</span> <span class="o">(--|)</span> <span class="n">f</span> <span class="n">g</span> <span class="p">=</span> <span class="n">f</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">rescue</span> <span class="n">g</span><span class="p">)</span>
</code></pre></div></div>

<p>These three operators let us build complex functions that return futures by composing several smaller functions that also return futures. This allows us to keep 
each function small and concise, as well as individually testable.</p>

<p>An example:</p>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">createRequest</span> <span class="n">url</span> <span class="p">=</span> <span class="o">...</span>     <span class="c1">//String -&gt; Future&lt;HttpWebRequest&gt;</span>
<span class="k">let</span> <span class="n">configureRequest</span> <span class="n">req</span> <span class="p">=</span> <span class="o">...</span>  <span class="c1">//HttpWebRequest -&gt; Future&lt;HttpWebRequest&gt;</span>
<span class="k">let</span> <span class="n">getResponse</span> <span class="n">req</span> <span class="p">=</span> <span class="o">...</span>       <span class="c1">//HttpWebRequest -&gt; Future&lt;HttpWebResponse&gt;</span>
<span class="k">let</span> <span class="n">handleException</span> <span class="n">e</span> <span class="p">=</span> <span class="o">...</span>     <span class="c1">//Exception -&gt; Future&lt;HttpWebResponse&gt;</span>
<span class="k">let</span> <span class="n">verifyStatus</span> <span class="n">res</span> <span class="p">=</span> <span class="o">...</span>      <span class="c1">//HttpWebResponse -&gt; Future&lt;HttpWebResponse&gt;</span>
<span class="k">let</span> <span class="n">parseResponse</span> <span class="n">res</span> <span class="p">=</span> <span class="o">...</span>     <span class="c1">//HttpWebResponse -&gt; Future&lt;Json&gt;</span>
<span class="k">let</span> <span class="n">extractData</span> <span class="n">json</span> <span class="p">=</span> <span class="o">...</span>      <span class="c1">//Json -&gt; Data</span>

<span class="c1">//String -&gt; Future&lt;Data&gt;</span>
<span class="k">let</span> <span class="n">getData</span> <span class="p">=</span> 
	<span class="n">createRequest</span>				<span class="c1">//Create the request</span>
	<span class="o">-&gt;&gt;</span> <span class="n">configureRequest</span>		<span class="c1">//Set headers etc.</span>
	<span class="o">-&gt;&gt;</span> <span class="n">getResponse</span>				<span class="c1">//Get the response</span>
	<span class="o">--|</span> <span class="n">handleException</span>		    <span class="c1">//Handle exceptions</span>
	<span class="o">-&gt;&gt;</span> <span class="n">verifyStatus</span>            <span class="c1">//Verify the status code</span>
	<span class="o">-&gt;&gt;</span> <span class="n">parseResponse</span>			<span class="c1">//Parse the response to JSON</span>
	<span class="o">--&gt;</span> <span class="n">extractData</span>				<span class="c1">//Extract the pertinent data from the JSON</span>
</code></pre></div></div>

<p>Here we create a future returning function by binding, rescuing and mapping using our three operators. A working example using the GitHub API can be found <a href="https://github.com/wattsm/fsharp-futures">here on GitHub</a>.</p>

<h4 id="conclusions">Conclusions</h4>

<p>Futures are a useful programming tool, and in this post I have outlined how I have implemented futures in F#, taking inspiration from Scala’s 
<code class="highlighter-rouge">Future[T]</code> type. A small set of utility functions and operators then allow you to create complex functions by composing smaller, more consise functions.</p>

<p>All of the code is available <a href="https://github.com/wattsm/fsharp-futures">here on GitHub</a>.</p>


    



<div class="post-tags">
  
    
    <a href="/tags/#fsharp">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">fsharp</span>
    </a>
  
    
    <a href="/tags/#dotnet">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">dotnet</span>
    </a>
  
</div>
  </div>

  
  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/programming/fsharp/2016/01/19/optimising-civ5-cities-using-genetic-algorithms/">
            Optimising Civ 5 cities using genetic algorithms
            <small>19 Jan 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/programming/fsharp/2015/05/20/modeling-historical-dates/">
            Modeling historical dates
            <small>20 May 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/programming/fsharp/2015/11/13/stateful-akka-actors-with-fsharp/">
            Stateful Akka.NET actors with F#
            <small>13 Nov 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>

    <!-- Optional footer content -->

  </body>
</html>
