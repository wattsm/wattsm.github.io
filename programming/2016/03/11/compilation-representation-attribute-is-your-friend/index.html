<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>    
	Usermaatre &middot; Why CompilationRepresentationAttribute is your friend    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  
  <style type="text/css">
	
	.left-align {
		text-align:left;
	}
	
	.header-bug {
		font-size:0px;
	}
	
  </style>
  
  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  
  
  <!-- Google analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-56516871-1', 'auto');
    ga('send', 'pageview');

  </script>
  
</head>


  <body class="theme-base-0b">
  
    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Usermaatre
        </a>
      </h1>
      <p class="lead">Programming, science, history and gaming. Not necessarily in that order.</p>
    </div>

    <nav class="sidebar-nav">
	  <a class="sidebar-nav-item" href="/">Home</a>
	  <a class="sidebar-nav-item" href="/about">About</a>
	  <a class="sidebar-nav-item" href="/archive">Archive</a>
      <a class="sidebar-nav-item" href="https://twitter.com/m_d_watts" target="_blank">Twitter</a>	  
      <a class="sidebar-nav-item" href="https://github.com/wattsm" target="_blank">GitHub</a>      
    </nav>
	
	<p>&copy; 2016. All rights reserved.</p>
	
	
  </div>
</div>


    <div class="content container">	
      <div class="post">
  <h1 class="post-title">Why CompilationRepresentationAttribute is your friend</h1>
  <span class="post-date">
	11 Mar 2016
&middot;
Programming 

	&middot;
	<a href="/tags/fsharp">F#</a>	

&middot;
<a data-disqus-identifier="Why CompilationRepresentationAttribute is your friend" href="/programming/2016/03/11/compilation-representation-attribute-is-your-friend/#disqus_thread">0 Comments</a>	
  </span>
  <p>In this short post I show why <code>CompilationRepresentationAttribute</code> is your friend if you like the &quot;union/struct plus module&quot; way of 
organising code as seen in core language features like <code>Option&lt;&#39;T&gt;</code> and the <code>Option</code> module.</p>

<!-- more -->

<h3>Introduction</h3>

<p>Dividing a piece of functionality between a struct or discriminated union representing the data and a module of the same name containing associated functions is a fairly 
common practice in F#. Good examples are the <code>Option&lt;&#39;T&gt;</code> and <code>Async&lt;&#39;T&gt;</code> types and associated <code>Option</code> and <code>Async</code> modules from F#&#39;s core language features.</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">type</span> <span class="nc">Option</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">=</span> 
    <span class="o">|</span> <span class="n">Some</span> <span class="k">of</span> <span class="k">&#39;</span><span class="n">T</span>
    <span class="o">|</span> <span class="n">None</span>

<span class="k">module</span> <span class="nn">Option</span> <span class="o">=</span>
    <span class="o">...</span>
</code></pre></div>
<p>This style helps keep your code both tidy and readable, particularly when piping or composing multiple functions.</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="nv">runParallel</span> <span class="o">=</span> 
    <span class="nn">Async</span><span class="p">.</span><span class="n">Parallel</span>
    <span class="o">&gt;&gt;</span> <span class="nn">Async</span><span class="p">.</span><span class="n">Catch</span>
    <span class="o">&gt;&gt;</span> <span class="nn">Async</span><span class="p">.</span><span class="n">RunSynchronously</span>
</code></pre></div>
<h3>CompilationRepresentationFlags</h3>

<p>Writing F# in this style is straight forward if your union or record type is generic.</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">type</span> <span class="nc">Widget</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">Value</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">T</span><span class="o">;</span>
    <span class="n">Keywords</span> <span class="o">:</span> <span class="n">String</span> <span class="kt">list</span><span class="o">;</span>
<span class="o">}</span>   

<span class="k">module</span> <span class="nn">Widget</span> <span class="o">=</span> 
    <span class="k">let</span> <span class="nv">create</span> <span class="n">value</span> <span class="o">=</span> <span class="o">...</span>
    <span class="k">let</span> <span class="nv">add</span> <span class="n">keyword</span> <span class="n">value</span> <span class="o">=</span> <span class="o">...</span>
</code></pre></div>
<p>The compiler will happily compile this code. When viewed in the object browser or from C# you can see that this code results in two types with different names - <code>Widget&lt;T&gt;</code> for 
the record type and <code>Widget</code> for the module, with the functions compiling to static methods.</p>

<p>However, you will run into problems if your union or record type is not generic.</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">type</span> <span class="nc">Widget</span> <span class="o">=</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
<span class="k">module</span> <span class="nn">Widget</span> <span class="o">=</span> <span class="o">...</span>
</code></pre></div>
<p>This is because now the compiled representations of the record and module have the same name.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">Duplicate definition of type, exception or module `Widget`
</code></pre></div>
<p>One way to avoid this is to simply change your naming convention - e.g. perhaps use <code>Widget</code> for the record/struct and <code>Widgets</code> for the module. However, if you prefer the names
to match then F# lets you have your cake and eat it.</p>

<p>Enter <a href="https://msdn.microsoft.com/en-us/library/ee353574.aspx">CompilationRepresentationAttribute</a>. This is an attribute that can be added to language elements to tell the F# compiler how they should be represented when compiled using the
<a href="https://msdn.microsoft.com/en-us/library/ee370528.aspx">CompilationRepresentationFlags</a> enumation. </p>

<p>Of relevance to this discussion is the <code>ModuleSuffix</code> value of the flags enumeration. When applied to a module this tells the F#
compiler to add &quot;Module&quot; to the end of the type name.</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">type</span> <span class="nc">Widget</span> <span class="o">=</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>

<span class="o">[&lt;</span><span class="n">CompilationRepresentation</span> <span class="o">(</span><span class="nn">CompilationRepresentationFlags</span><span class="p">.</span><span class="n">ModuleSuffix</span><span class="o">)&gt;]</span>
<span class="k">module</span> <span class="nn">Widget</span> <span class="o">=</span> <span class="o">...</span>
</code></pre></div>
<p>In the example above this would mean that the <code>Widget</code> module compiles to a type called <code>WidgetModule</code>, thus resolving our type name problems. The module is still accessible
as <code>Widget</code> within F#, but in C# it would appear as <code>WidgetModule</code>. This allows us to continue to use the record/union plus module style despite the
record and module having the same name.</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="nv">init</span> <span class="o">=</span>
    <span class="nn">Widget</span><span class="p">.</span><span class="n">create</span>
    <span class="o">&gt;&gt;</span> <span class="nn">Widget</span><span class="p">.</span><span class="n">add</span> <span class="s">&quot;Key&quot;</span>
    <span class="o">&gt;&gt;</span> <span class="nn">Widget</span><span class="p">.</span><span class="n">add</span> <span class="s">&quot;Words&quot;</span>
</code></pre></div>
</div>

<div class="comments">
	<h3>Comments</h3>

	<div id="disqus_thread"></div>
	<script type="text/javascript">
		/* * * CONFIGURATION VARIABLES * * */
		var disqus_shortname = 'usermaatre';
		var disqus_title = "Why CompilationRepresentationAttribute is your friend";
		var disqus_identifier = "Why CompilationRepresentationAttribute is your friend";
		
		/* * * DON'T EDIT BELOW THIS LINE * * */
		(function() {
			var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
    
      <li>
        <h5>
          <a href="/programming/2016/01/19/optimising-civ5-cities-using-genetic-algorithms/">
            Optimising Civ 5 cities using genetic algorithms
            <small>19 Jan 2016</small>
          </a>
        </h5>
      </li>
    
      <li>
        <h5>
          <a href="/programming/2015/11/20/constructing-lenses-using-quotations/">
            Constructing lenses using quotations
            <small>20 Nov 2015</small>
          </a>
        </h5>
      </li>
    
      <li>
        <h5>
          <a href="/programming/2015/11/13/stateful-akka-actors-with-fsharp/">
            Stateful Akka.NET actors with F#
            <small>13 Nov 2015</small>
          </a>
        </h5>
      </li>
    
  </ul>
</div>
    </div>

	
	<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'usermaatre';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
  </body>
</html>
