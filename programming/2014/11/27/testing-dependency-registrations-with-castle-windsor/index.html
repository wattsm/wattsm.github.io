<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>    
	Usermaatre &middot; Testing dependency registrations with Castle Windsor    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  
  <style type="text/css">
	
	.left-align {
		text-align:left;
	}
	
	.header-bug {
		font-size:0px;
	}
	
  </style>
  
  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  
  
</head>


  <body class="theme-base-0b">
  
    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Usermaatre
        </a>
      </h1>
      <p class="lead">Programming, science, history and gaming. Not necessarily in that order.</p>
    </div>

    <nav class="sidebar-nav">
	  <a class="sidebar-nav-item" href="/">Home</a>
	  <a class="sidebar-nav-item" href="/about">About</a>
	  <a class="sidebar-nav-item" href="/archive">Archive</a>
      <a class="sidebar-nav-item" href="https://twitter.com/m_d_watts" target="_blank">Twitter</a>	  
      <a class="sidebar-nav-item" href="https://github.com/wattsm" target="_blank">GitHub</a>      
    </nav>
	
	<p>&copy; 2015. All rights reserved.</p>
	
	
  </div>
</div>


    <div class="content container">	
      <div class="post">
  <h1 class="post-title">Testing dependency registrations with Castle Windsor</h1>
  <span class="post-date">
	27 Nov 2014
&middot;
Programming 

	&middot;
	<a href="/tags/castle-windsor">Castle Windsor</a>, 	

	
	<a href="/tags/xunit">xUnit</a>, 	

	
	<a href="/tags/unit-testing">Unit Testing</a>	

&middot;
<a data-disqus-identifier="Testing dependency registrations with Castle Windsor" href="/programming/2014/11/27/testing-dependency-registrations-with-castle-windsor/#disqus_thread">0 Comments</a>	
  </span>
  <p>Until recently one of the most frustrating bugs I have routinely found in my own code is incomplete dependency registrations. </p>

<p>It&#39;s a scenario I&#39;m sure everyone is familiar with - you&#39;ve just written some new components and got the unit tests passing, so now it&#39;s time to fire up the 
application and see your creations in action. Then as soon as the application starts it falls over because you forgot to add your new components to the <a href="http://en.wikipedia.org/wiki/Inversion_of_control">IOC</a> container,
leaving you with unresolvable dependencies.</p>

<p>I would curse my own forgetfulness as I fixed the problem and would often think to myself that it would be really handy if there was a way to test your dependency registrations.
I was pleasantly surprised then to find out that <a href="http://docs.castleproject.org/Default.aspx?Page=MainPage&amp;NS=Windsor&amp;AspxAutoDetectCookieSupport=1">Castle Windsor</a> supports exactly these kinds of tests.</p>

<!-- more -->

<p>The code below is an example unit test using <a href="http://xunit.github.io/">xUnit</a> which will fail if your dependency registrations are not complete - i.e. if one or more component has dependencies which cannot be
resolved. I have used <a href="http://docs.castleproject.org/Windsor.Installers.ashx">Windsor&#39;s installer functionality</a> to group my registrations together which helps break up potentially large numbers of dependency registrations into logical groups,
as well helping to keep the code <a href="http://en.wikipedia.org/wiki/Don%27t_repeat_yourself">DRY</a> when writing these tests.</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="na">[Fact]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">all_dependencies_are_correctly_registered</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">using</span><span class="p">(</span><span class="kt">var</span> <span class="n">container</span> <span class="p">=</span> <span class="k">new</span> <span class="n">WindsorContainer</span><span class="p">())</span> <span class="p">{</span>     

        <span class="c1">//Setup the container</span>
        <span class="n">container</span><span class="p">.</span><span class="n">Install</span><span class="p">(</span>
            <span class="k">new</span> <span class="nf">InstallerOne</span><span class="p">(),</span>
            <span class="k">new</span> <span class="nf">InstallerTwo</span><span class="p">(),</span>
            <span class="k">new</span> <span class="nf">InstallerThree</span><span class="p">()</span>
        <span class="p">);</span>

        <span class="c1">//Inspect the container for problems</span>
        <span class="kt">var</span> <span class="n">key</span> <span class="p">=</span> <span class="n">SubSystemConstants</span><span class="p">.</span><span class="n">DiagnosticsKey</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">host</span> <span class="p">=</span> <span class="p">(</span><span class="n">IDiagnosticsHost</span><span class="p">)</span><span class="n">container</span><span class="p">.</span><span class="n">Kernel</span><span class="p">.</span><span class="n">GetSubSystem</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">diagnostic</span> <span class="p">=</span> <span class="n">host</span><span class="p">.</span><span class="n">GetDiagnostic</span><span class="p">&lt;</span><span class="n">IPotentiallyMisconfiguredComponentsDiagnostic</span><span class="p">&gt;();</span>
        <span class="kt">var</span> <span class="n">problems</span> <span class="p">=</span> <span class="n">diagnostic</span><span class="p">.</span><span class="n">Inspect</span><span class="p">();</span>

        <span class="c1">//Iterate over the problems, writing messages to the console</span>
        <span class="k">foreach</span><span class="p">(</span><span class="n">IExposeDependencyInfo</span> <span class="n">problem</span> <span class="k">in</span> <span class="n">problems</span><span class="p">)</span> <span class="p">{</span>

            <span class="kt">var</span> <span class="n">message</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">();</span>
            <span class="kt">var</span> <span class="n">inspector</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DependencyInspector</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>

            <span class="n">problem</span><span class="p">.</span><span class="n">ObtainDependencyDetails</span><span class="p">(</span><span class="n">inspector</span><span class="p">);</span>

            <span class="n">Console</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
        <span class="p">}</span>

        <span class="c1">//Fail the test if there are any problems</span>
        <span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">problems</span><span class="p">.</span><span class="n">Count</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>This test creates a <code>WindsorContainer</code>, configures dependencies via installers, then looks for problems using <code>IDiagnosticHost</code>. Here I have chosen to write individual error messages
to the console before failing the test if there are problems but you could just as easily concatenate the messages together and fail the test with that message. The only potential
downside of that approach is that if you have multiple missing dependencies the message is going to be quite wordy (and also more informative).</p>

<p>It may not save a huge amount of time, but having a test like this in place removes one more small but annoying gotcha in the development process.</p>

</div>

<div class="comments">
	<h3>Comments</h3>

	<div id="disqus_thread"></div>
	<script type="text/javascript">
		/* * * CONFIGURATION VARIABLES * * */
		var disqus_shortname = 'usermaatre';
		var disqus_title = "Testing dependency registrations with Castle Windsor";
		var disqus_identifier = "Testing dependency registrations with Castle Windsor";
		
		/* * * DON'T EDIT BELOW THIS LINE * * */
		(function() {
			var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
    
      <li>
        <h5>
          <a href="/programming/2014/02/03/tfs-2010-xunit/">
            Running xUnit tests as a part of a TFS 2010 build
            <small>03 Feb 2014</small>
          </a>
        </h5>
      </li>
    
      <li>
        <h5>
          <a href="/programming/2015/05/20/modeling-historical-dates/">
            Modeling historical dates
            <small>20 May 2015</small>
          </a>
        </h5>
      </li>
    
      <li>
        <h5>
          <a href="/programming/2014/12/12/testing-web-api-odata-controllers/">
            Testing Web API OData controllers
            <small>12 Dec 2014</small>
          </a>
        </h5>
      </li>
    
  </ul>
</div>
    </div>

	
	<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'usermaatre';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
  </body>
</html>
