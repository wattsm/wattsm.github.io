<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>    
	Usermaatre &middot; Modeling Mars rovers with F#    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  
  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  
  <!-- Google analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-56516871-1', 'auto');
    ga('send', 'pageview');

  </script>
</head>


  <body class="theme-base-0b">
  
    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Usermaatre
        </a>
      </h1>
      <p class="lead">Programming, science, history and gaming. Not necessarily in that order.</p>
    </div>

    <nav class="sidebar-nav">
	  <a class="sidebar-nav-item" href="/">Home</a>
	  <a class="sidebar-nav-item" href="/about">About</a>
	  <a class="sidebar-nav-item" href="/archive">Archive</a>
      <a class="sidebar-nav-item" href="https://twitter.com/m_d_watts" target="_blank">Twitter</a>	  
      <a class="sidebar-nav-item" href="https://github.com/wattsm" target="_blank">GitHub</a>      
    </nav>
	
	<p>&copy; 2015. All rights reserved.</p>
	
	<hr />
	
	<p style="font-size:80%;">
		<a style='font-size: 70%' href='/tags/beyond-earth'>Beyond Earth</a>
<a style='font-size: 70%' href='/tags/castle-windsor'>Castle Windsor</a>
<a style='font-size: 70%' href='/tags/ci'>CI</a>
<a style='font-size: 70%' href='/tags/civilization'>Civilization</a>
<a style='font-size: 70%' href='/tags/design'>Design</a>
<a style='font-size: 70%' href='/tags/entity-framework'>Entity Framework</a>
<a style='font-size: 170%' href='/tags/fsharp'>F#</a>
<a style='font-size: 70%' href='/tags/moq'>Moq</a>
<a style='font-size: 70%' href='/tags/odata'>OData</a>
<a style='font-size: 70%' href='/tags/psexec'>PsExec</a>
<a style='font-size: 70%' href='/tags/reflection'>Reflection</a>
<a style='font-size: 113%' href='/tags/tfs'>TFS</a>
<a style='font-size: 138%' href='/tags/unit-testing'>Unit Testing</a>
<a style='font-size: 113%' href='/tags/webapi'>WebAPI</a>
<a style='font-size: 70%' href='/tags/wix'>Wix</a>
<a style='font-size: 138%' href='/tags/xunit'>xUnit</a>

	</p>	
	
  </div>
</div>


    <div class="content container">	
      <div class="post">
  <h1 class="post-title">Modeling Mars rovers with F#</h1>
  <span class="post-date">
	18 Nov 2014
&middot;
Programming 

	&middot;
	<a href="/tags/fsharp">F#</a>, 	

	
	<a href="/tags/design">Design</a>	
	
  </span>
  <p>Although currently somewhat overshadowed by <a href="http://www.esa.int/Our_Activities/Space_Science/Rosetta">ESA&#39;s amazing Rosetta mission</a>, <a href="http://en.wikipedia.org/wiki/Sojourner_(rover)">Mars rovers</a> <a href="http://en.wikipedia.org/wiki/Opportunity_(rover)">are awesome</a> <a href="http://en.wikipedia.org/wiki/Spirit_(rover)">in their</a> <a href="http://en.wikipedia.org/wiki/Curiosity_(rover)">own right</a>. 
So when <a href="http://www.readcopyupdate.com/">a colleague</a> pointed me in the direction of 
<a href="http://www.techinterviewpuzzles.com/2010/09/mars-rovers-thoughtworks-puzzles.html#Mars_Rovers_Puzzle">an interview puzzle about modeling Mars rovers</a>
and mentioned that he was writing an (immutable) F# implementation I decided to follow suit and have a go myself.</p>

<!-- more -->

<h3>The problem</h3>

<p>The basic problem described in the puzzle is modeling the movements of rovers on the surface of Mars. The surface is represented by a simple grid with the point (0,0) being
at the left hand corner. Rovers land at a given point facing a given direction and are then commanded to either move in the direction they are facing or rotate 90&deg; either to
the left or the right.</p>

<p>The program should accept as an input a series of commands. The first defines the planet surface as a maximum value of the X and Y coordinates. Subsequent commands
describe the landing position of rovers followed by their movements.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">5 5
1 2 N
LMLMLMLMM
3 3 E
MMRMMRMRRM
</code></pre></div>
<p>In this example the first line initialises the planet surface to have maximum X and Y coordinates of 5. Then a rover is added to (1,2), facing north. Instructions for this rover follow, with 
L turning the rover 90&deg; to the left, R turning it 90&deg; to the right and M moving it forwards one place in the direction it is facing. The process is then repeated for another rover starting at (3,3) and facing
east.</p>

<p>Once the input has been processed the final position and direction of the rovers should be printed.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">1 3 N
5 1 E
</code></pre></div>
<p>The original problem does not explicitly state error conditions but I think that at a minimum movement out of bounds and rover collisions should be covered. The original problem
also does not state how the input should be processed. There are two possibilities:</p>

<ul>
<li>Initialise the planet surface, place all rovers, circle through the rovers processing one movement instruction at a time.</li>
<li>Initialise the planet surface, place each rover in turn, processing its movement instructions immediately afterwards.</li>
</ul>

<p>I decided to adopt the second approach as it is implied by the format of the input and is simpler.</p>

<p>Finally, for the sake of clarity I gave the rovers names, so the input now becomes:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">5 5
Opportunity 1 2 N
LMLMLMLMM
Curiousity 3 3 E
MMRMMRMRRM
</code></pre></div>
<h3>The solution</h3>

<p>The solution I arrived at <a href="https://github.com/wattsm/mars-rovers">can be found on GitHub</a>, with the majority of the interesting code in <a href="https://github.com/wattsm/mars-rovers/blob/master/MarsRovers/Model.fs">Model.fs</a>.</p>

<h4>Basic design</h4>

<p>I decided to use single case unions when writing my model, as described in <a href="http://fsharpforfunandprofit.com/posts/designing-with-types-single-case-dus/">this 
post over at F# for fun and profit</a>. I really like the elegance of this approach and was interested
to see how it would work in practice. (I did not use <code>.fsi</code> files as described in the post as I found them to be more trouble than they were worth.)</p>

<p>Using this approach is a nice compromise between <a href="http://en.wikipedia.org/wiki/Encapsulation_(object-oriented_programming)">object oriented style encapsulation</a> and a more
functional approach. </p>

<p>The article above defines an <code>apply</code> method which grants a function access to the union&#39;s underlying data. I also defined a <code>mutate</code> function which creates a new
value based on a function which updates the underlying data.</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">module</span> <span class="nn">Rover</span> <span class="o">=</span> 

  <span class="k">type</span> <span class="nc">State</span> <span class="o">=</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>  
  <span class="k">type</span> <span class="nc">Instance</span> <span class="o">=</span> <span class="n">Rover</span> <span class="k">of</span> <span class="n">State</span>

  <span class="k">let</span> <span class="nv">private</span> <span class="n">apply</span> <span class="n">f</span> <span class="o">(</span><span class="n">Rover</span> <span class="n">state</span><span class="o">)</span> <span class="o">=</span> <span class="n">f</span> <span class="n">state</span>  
  <span class="k">let</span> <span class="nv">private</span> <span class="n">mutate</span> <span class="n">f</span> <span class="o">=</span> <span class="n">apply</span> <span class="o">(</span><span class="k">fun</span> <span class="n">state</span> <span class="o">-&gt;</span> <span class="n">Rover</span> <span class="o">(</span><span class="n">f</span> <span class="n">state</span><span class="o">))</span>
</code></pre></div>
<p>This function can then be used to create new values.</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="c1">//Rover.Instance -&gt; Rover.Instance</span>
<span class="k">let</span> <span class="nv">move</span> <span class="o">=</span> <span class="n">mutate</span> <span class="o">(</span><span class="k">fun</span> <span class="n">state</span> <span class="o">-&gt;</span>
  <span class="k">let</span> <span class="nv">location</span> <span class="o">=</span> <span class="o">...</span>
  <span class="k">in</span> <span class="o">{</span> <span class="n">state</span> <span class="k">with</span> <span class="n">Location</span> <span class="o">=</span> <span class="n">location</span><span class="o">;</span> <span class="o">}</span>
<span class="o">)</span>
</code></pre></div>
<h4>Errors</h4>

<p>In order to represent the success/failure of an operation I created a new union type, <code>Outcome&lt;&#39;T&gt;</code>. This is essentially the same as <code>Choice&lt;&#39;T,String&gt;</code> but with nicer
semantics and syntax.</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="c1">//Using Choice&lt;&#39;T,String&gt;</span>
<span class="k">match</span> <span class="n">value</span> <span class="k">with</span>
<span class="o">|</span> <span class="n">Choice1Of2</span> <span class="n">result</span> <span class="o">-&gt;</span> <span class="o">...</span>
<span class="o">|</span> <span class="n">Choice2Of2</span> <span class="n">message</span> <span class="o">-&gt;</span> <span class="o">...</span>

<span class="c1">//Using Outcome&lt;&#39;T&gt;</span>
<span class="k">match</span> <span class="n">value</span> <span class="k">with</span>
<span class="o">|</span> <span class="n">Success</span> <span class="n">result</span> <span class="o">-&gt;</span> <span class="o">...</span>
<span class="o">|</span> <span class="n">Problem</span> <span class="n">message</span> <span class="o">-&gt;</span> <span class="o">...</span>
</code></pre></div>
<p>Using the <code>Outcome&lt;&#39;T&gt;</code> type I could represent errors without the need for exceptions.</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="nv">create</span> <span class="n">name</span> <span class="n">location</span> <span class="n">orientation</span> <span class="o">=</span> 
  <span class="k">if</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">IsNullEmptyOrWhitespace</span> <span class="n">name</span><span class="o">)</span> <span class="k">then</span>
    <span class="n">Problem</span> <span class="o">(</span><span class="s">&quot;The rover name cannot be null, empty or whitespace.&quot;</span><span class="o">)</span>
  <span class="k">else</span>
    <span class="n">Success</span> <span class="o">(...)</span>
</code></pre></div>
<h4>Composing functions</h4>

<p>In order to be able to compose multiple functions of the form <code>&#39;a -&gt; Outcome&lt;&#39;b&gt;</code> I created a <code>bind</code> function and gave it an alias, <code>--&gt;</code>, as a custom
operator.</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="nv">bind</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">Outcome</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">b</span><span class="o">&gt;)</span> <span class="o">(</span><span class="n">g</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="n">Outcome</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">c</span><span class="o">&gt;)</span> <span class="o">=</span> 
  <span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
    <span class="k">match</span> <span class="o">(</span><span class="n">f</span> <span class="n">x</span><span class="o">)</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Success</span> <span class="n">x&#39;</span> <span class="o">-&gt;</span> <span class="n">g</span> <span class="n">x&#39;</span>
    <span class="o">|</span> <span class="n">Problem</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="n">Problem</span> <span class="n">msg</span>

<span class="k">let</span> <span class="o">(--&gt;)</span> <span class="o">=</span> <span class="n">bind</span>
</code></pre></div>
<p>This allowed me to create composite functions where each component function was only called if the previous one had been successful, with error messages
being propogated otherwise. A good example of this is the <code>validatedAdd</code> function in <code>Planet.MissionControl</code>.</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="c1">//(Planet.State * Rover.Instance) -&gt; Outcome&lt;Planet.Instance&gt;</span>
<span class="k">let</span> <span class="nv">private</span> <span class="n">validatedAdd</span> <span class="o">=</span> 
  <span class="nn">State</span><span class="p">.</span><span class="n">checkBounds</span>
  <span class="o">--&gt;</span> <span class="nn">State</span><span class="p">.</span><span class="n">checkCollissions</span>
  <span class="o">--&gt;</span> <span class="nn">Rover</span><span class="p">.</span><span class="n">add</span>
  <span class="o">--&gt;</span> <span class="nn">State</span><span class="p">.</span><span class="n">toPlanet</span>
</code></pre></div>
<p>(This is an example of a monad. There are <a href="https://www.haskell.org/haskellwiki/Monad_tutorials_timeline">a lot of monad tutorials out there</a> if you are interested in finding out more.)</p>

<h4>Issuing instructions</h4>

<p>Once the planet surface has been initialised there are two types of command:</p>

<ul>
<li>Add a new rover.</li>
<li>Move an existing rover.</li>
</ul>

<p>These commands share two validation rules regarding the state of the planet surface:</p>

<ul>
<li>No rover should be out of bounds.</li>
<li>No rover should occupy the same position as another.</li>
</ul>

<p>The model of the planet surface is fairly straight forward.</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">module</span> <span class="nn">Planet</span> <span class="o">=</span> 
  <span class="k">type</span> <span class="nc">State</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">Width</span> <span class="o">:</span> <span class="n">int</span><span class="o">;</span>
    <span class="n">Height</span> <span class="o">:</span> <span class="n">int</span><span class="o">;</span>
    <span class="n">Rovers</span> <span class="o">:</span> <span class="nn">Rover</span><span class="p">.</span><span class="n">Instance</span> <span class="kt">list</span><span class="o">;</span>
  <span class="o">}</span>
</code></pre></div>
<p>Rovers are responsible for keeping track of their current position.</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">module</span> <span class="nn">Rover</span> <span class="o">=</span>
  <span class="k">type</span> <span class="nc">State</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">Name</span> <span class="o">:</span> <span class="n">String</span><span class="o">;</span>
    <span class="n">Location</span> <span class="o">:</span> <span class="nn">Location</span><span class="p">.</span><span class="n">Instance</span><span class="o">;</span> <span class="c1">//X and Y coordinates</span>
    <span class="n">Orientation</span> <span class="o">:</span> <span class="nn">Orientation</span><span class="p">.</span><span class="n">Instance</span><span class="o">;</span> <span class="c1">//Direction the rover is facing</span>
  <span class="o">}</span>
</code></pre></div>
<p>In order make my solution as simple as possible I made the second command, moving a rover, a case of the new rover command. When modeling a move command
a new planet <code>State</code> is created minus the moving rover, the rover&#39;s position is then updated and the rover re-added to the <code>State</code> as if it were a new rover. This
can be seen in the functions <code>touchdown</code> and <code>instruct</code> in the <code>Planet.MissionControl</code> module.</p>
<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="k">let</span> <span class="nv">private</span> <span class="n">validatedAdd</span> <span class="o">=</span>   
  <span class="nn">State</span><span class="p">.</span><span class="n">checkBounds</span>           <span class="c1">//Ensure within bounds</span>
  <span class="o">--&gt;</span> <span class="nn">State</span><span class="p">.</span><span class="n">checkCollissions</span>  <span class="c1">//Ensure not at same location as another</span>
  <span class="o">--&gt;</span> <span class="nn">Rovers</span><span class="p">.</span><span class="n">add</span>              <span class="c1">//Add to the surface</span>
  <span class="o">--&gt;</span> <span class="nn">State</span><span class="p">.</span><span class="n">toPlanet</span> 

<span class="sd">///Rover.Instance -&gt; Planet.Instance -&gt; Outcome&lt;Planet.Instance&gt;</span>
<span class="k">let</span> <span class="nv">touchdown</span> <span class="n">rover</span> <span class="o">(</span><span class="n">Planet</span> <span class="n">state</span><span class="o">)</span> <span class="o">=</span>
  <span class="n">validatedAdd</span> <span class="o">(</span><span class="n">state</span><span class="o">,</span> <span class="n">rover</span><span class="o">)</span>

<span class="sd">///String -&gt; (Rover.Instance -&gt; Rover.Instance) -&gt; Planet.Instance -&gt; Outcome&lt;Planet.Instance&gt;</span>
<span class="k">let</span> <span class="nv">instruct</span> <span class="n">name</span> <span class="n">instruction</span> <span class="o">(</span><span class="n">Planet</span> <span class="n">state</span><span class="o">)</span> <span class="o">=</span> 
  <span class="k">let</span> <span class="nv">f</span> <span class="o">=</span> 
    <span class="nn">Rovers</span><span class="p">.</span><span class="n">find</span>                    <span class="c1">//Find by name</span>
    <span class="o">--&gt;</span> <span class="nn">Rovers</span><span class="p">.</span><span class="n">extract</span>             <span class="c1">//Remove from planet surface</span>
    <span class="o">--&gt;</span> <span class="nn">Rovers</span><span class="p">.</span><span class="n">update</span> <span class="n">instruction</span>  <span class="c1">//Issue the instruction</span>
    <span class="o">--&gt;</span> <span class="n">validatedAdd</span>               <span class="c1">//Re-add to the planet surface</span>
  <span class="k">in</span> <span class="n">f</span> <span class="o">(</span><span class="n">state</span><span class="o">,</span> <span class="n">name</span><span class="o">)</span>
</code></pre></div>
<p>Processing the input defined in the puzzle is now a case of simply creating the initial, empty, model of the planet and then folding over a list
of instructions.</p>

<h3>Conclusion</h3>

<p>You can see the model in action in <a href="https://github.com/wattsm/mars-rovers/blob/master/MarsRovers/Program.fs">Program.fs</a>, which is somewhat less elegant. I think that although the model could certainly be polished and expanded 
it is a good solution to the problem. </p>

<p>Running the program with the standard input will give the following response.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">Rovers:
Curiousity | (5, 1) | Facing East
Opportunity | (1, 3) | Facing North
</code></pre></div>
<p>One of the things that really impressed me when writing this was how easy it is in F# to create a viable working solution without the missteps and gotchas 
that you tend to associated with the same process in languages like C#. The single case union model also worked really well and allowed me to think broadly in
terms of real world objects while using a functional style.</p>

</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
    
      <li>
        <h5>
          <a href="/programming/2015/01/19/futures-in-fsharp/">
            Futures in F#
            <small>19 Jan 2015</small>
          </a>
        </h5>
      </li>
    
      <li>
        <h5>
          <a href="/programming/2014/12/12/testing-web-api-odata-controllers/">
            Testing Web API OData controllers
            <small>12 Dec 2014</small>
          </a>
        </h5>
      </li>
    
      <li>
        <h5>
          <a href="/programming/2013/11/19/fsharp-serialising-option/">
            Serialising F#'s Option type using DataContractSerialiser
            <small>19 Nov 2013</small>
          </a>
        </h5>
      </li>
    
  </ul>
</div>
    </div>

  </body>
</html>
