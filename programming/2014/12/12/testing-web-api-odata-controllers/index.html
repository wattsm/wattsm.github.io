<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>    
	Usermaatre &middot; Testing Web API OData controllers    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  
  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  
  <!-- Google analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-56516871-1', 'auto');
    ga('send', 'pageview');

  </script>
</head>


  <body class="theme-base-0b">
  
    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Usermaatre
        </a>
      </h1>
      <p class="lead">Programming, science, history and gaming. Not necessarily in that order.</p>
    </div>

    <nav class="sidebar-nav">
	  <a class="sidebar-nav-item" href="/">Home</a>
	  <a class="sidebar-nav-item" href="/about">About</a>
	  <a class="sidebar-nav-item" href="/archive">Archive</a>
      <a class="sidebar-nav-item" href="https://twitter.com/m_d_watts" target="_blank">Twitter</a>	  
      <a class="sidebar-nav-item" href="https://github.com/wattsm" target="_blank">GitHub</a>      
    </nav>
	
	<hr />
	
	<p style="font-size:80%;text-align:center;">
		<a style='font-size: 70%' href='/tags/beyond-earth'>Beyond Earth</a>
<a style='font-size: 70%' href='/tags/castle-windsor'>Castle Windsor</a>
<a style='font-size: 70%' href='/tags/ci'>CI</a>
<a style='font-size: 70%' href='/tags/civilization'>Civilization</a>
<a style='font-size: 70%' href='/tags/design'>Design</a>
<a style='font-size: 70%' href='/tags/entity-framework'>Entity Framework</a>
<a style='font-size: 170%' href='/tags/fsharp'>F#</a>
<a style='font-size: 70%' href='/tags/moq'>Moq</a>
<a style='font-size: 70%' href='/tags/odata'>OData</a>
<a style='font-size: 70%' href='/tags/psexec'>PsExec</a>
<a style='font-size: 70%' href='/tags/reflection'>Reflection</a>
<a style='font-size: 120%' href='/tags/tfs'>TFS</a>
<a style='font-size: 149%' href='/tags/unit-testing'>Unit Testing</a>
<a style='font-size: 120%' href='/tags/webapi'>WebAPI</a>
<a style='font-size: 70%' href='/tags/wix'>Wix</a>
<a style='font-size: 149%' href='/tags/xunit'>xUnit</a>

	</p>
	
	<hr />
	
	<p>&copy; 2014. All rights reserved.</p>
  </div>
</div>


    <div class="content container">	
      <div class="post">
  <h1 class="post-title">Testing Web API OData controllers</h1>
  <span class="post-date">
	12 Dec 2014
&middot;
Programming 

	&middot;
	<a href="/tags/entity-framework">Entity Framework</a>, 	

	
	<a href="/tags/webapi">WebAPI</a>, 	

	
	<a href="/tags/unit-testing">Unit Testing</a>, 	

	
	<a href="/tags/moq">Moq</a>, 	

	
	<a href="/tags/xunit">xUnit</a>, 	

	
	<a href="/tags/odata">OData</a>	
	
  </span>
  <p>Microsoft&#39;s <a href="http://msdn.microsoft.com/en-us/data/ef.aspx">Entity Framework</a> is an occasionally handy <a href="https://en.wikipedia.org/wiki/Object-relational_mapping">ORM</a> framework that allows you to query database entities using LINQ and to easily add, update and delete entities via
a variety of helper classes.</p>

<p>Recently I wrote a set of <a href="http://www.asp.net/web-api">WebAPI</a> controllers to expose an Entity Framework model as <a href="http://www.odata.org/">OData</a> endpoints. Exposing an Entity Framework model as OData using WebAPI is <a href="http://www.asp.net/web-api/overview/odata-support-in-aspnet-web-api/odata-v4/create-an-odata-v4-endpoint">incredibly easy</a>.
However, when it came to testing my controllers I found that mocking Entity Framework is tricky, due to a combination of erratic use of interfaces and the apparent complexity of <code>IQueryable&lt;T&gt;</code>. </p>

<p>Luckily my controllers only used a few parts of the EF API, so I decided to write some lightweight wrappers to make testing easier. This had the bonus of also removing dependencies
on EF from my controllers.</p>

<!-- more -->

<h3>OData controller structure</h3>

<p>My original OData controllers all inherited from a common base class which was a tweaked version of the implementation given in this <a href="http://www.asp.net/web-api/overview/odata-support-in-aspnet-web-api/odata-v4/create-an-odata-v4-endpoint">ASP.net article on creating ODAta services using
WebAPI</a>. (This is very similar to the <code>EntitySetController&lt;TEntity, TKey&gt;</code> defined in <code>System.Web.Http.OData</code> assembly, but somewhat simpler - <a href="http://msdn.microsoft.com/en-us/library/jj890573(v=vs.118).aspx">you can find information about that type here</a>.)</p>

<p>The common base class has two generic parameters, one specifying the type of the entity and another specifying the type of the entity&#39;s key. It accepted a <code>DerivedContext</code> in its constructor
and used the <code>Set&lt;T&gt;</code> method of <code>DbContext</code> to get a reference to the set of entities it was exposing as OData.</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="k">readonly</span> <span class="n">DerivedContext</span> <span class="n">_context</span><span class="p">;</span>
<span class="k">private</span> <span class="k">readonly</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="n">_set</span><span class="p">;</span>

<span class="k">public</span> <span class="nf">EntityControllerBase</span><span class="p">(</span><span class="n">DerivedContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">_context</span> <span class="p">=</span> <span class="n">context</span><span class="p">;</span>
  <span class="n">_set</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Set</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;();</span>
<span class="p">}</span>
</code></pre></div>
<p>You can see the <a href="https://github.com/wattsm/ODataTests/blob/master/ODataTests.Before/Controllers/EntityControllerBase.cs">full source of the controller here</a>. Looking over the controller&#39;s actions we can see that to test it we need to be able to mock the following:</p>

<ol>
<li><code>DbContext.SaveChanges()</code></li>
<li><code>DbContext.Set&lt;T&gt;()</code></li>
<li><code>DbSet&lt;T&gt;.Find(Object[])</code></li>
<li><code>DbSet&lt;T&gt;.Add(T)</code></li>
<li><code>DbSet&lt;T&gt;.Remove(T)</code></li>
<li>The <code>IQueryable&lt;T&gt;</code> members of <code>DbSet&lt;T&gt;</code></li>
</ol>

<p>We can now define two simple interfaces that will allow us to mock this functionality and remove our controller&#39;s dependency on EF types.</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">interface</span> <span class="n">IBasicSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span> <span class="err">{</span>
  <span class="n">T</span> <span class="nf">Add</span><span class="p">(</span><span class="n">T</span> <span class="n">entity</span><span class="p">);</span>
  <span class="n">T</span> <span class="nf">Remove</span><span class="p">(</span><span class="n">T</span> <span class="n">entity</span><span class="p">);</span>
  <span class="n">T</span> <span class="nf">Find</span><span class="p">(</span><span class="k">params</span> <span class="n">Object</span><span class="p">[]</span> <span class="n">keyValues</span><span class="p">);</span>  
<span class="p">}</span>

<span class="k">public</span> <span class="k">interface</span> <span class="n">IBasicContext</span> <span class="p">:</span> <span class="n">IDisposable</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="nf">SaveChanges</span><span class="p">();</span>
  <span class="n">IBasicSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">GetSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">class</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3>Interface implementations</h3>

<p>Both of these interfaces are easy to implement. First, we can simply wrap <code>DbSet&lt;T&gt;</code> for <code>IBasicSet&lt;T&gt;</code>.</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">BasicSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IBasicSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span> <span class="err">{</span>

  <span class="k">private</span> <span class="k">readonly</span> <span class="n">IDbSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">_wrapped</span><span class="p">;</span>

  <span class="k">public</span> <span class="nf">BasicSet</span><span class="p">(</span><span class="n">IDbSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">wrapped</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">_wrapped</span> <span class="p">=</span> <span class="n">wrapped</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="n">T</span> <span class="nf">Add</span><span class="p">(</span><span class="n">T</span> <span class="n">entity</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">_wrapped</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// And so on for the other members of IBasicSet&lt;T&gt;</span>
<span class="p">}</span>
</code></pre></div>
<p>Then, add an extension method to <code>IDbSet&lt;T&gt;</code> for ease of use.</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">static</span> <span class="n">IBasicSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">Wrap</span><span class="p">(</span><span class="k">this</span> <span class="n">IDbSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="k">set</span><span class="p">)</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span> <span class="err">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="n">BasicSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">set</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>As <code>DerivedContext</code> inherits from <code>DbContext</code> it already has implementations for <code>Dispose</code> and <code>SaveChanges</code>, so when implementing <code>IBasicContext</code> the only member 
we need to explicitly implement is <code>GetSet&lt;T&gt;</code>, which is trivial:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">DerivedContext</span> <span class="p">:</span> <span class="n">DbContext</span><span class="p">,</span> <span class="n">IBasicContext</span> <span class="p">{</span>

  <span class="k">public</span> <span class="n">IBasicSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">GetSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span> <span class="err">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">Set</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;().</span><span class="n">Wrap</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">// Snip...</span>
<span class="p">}</span>
</code></pre></div>
<p>Now our controllers can be updated to use these interfaces instead of <code>DerivedContext</code> and <code>DbSet&lt;T&gt;</code>:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="k">readonly</span> <span class="n">IBasicContext</span> <span class="n">_context</span><span class="p">;</span>
<span class="k">private</span> <span class="k">readonly</span> <span class="n">IBasicSet</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="n">_set</span><span class="p">;</span>

<span class="k">public</span> <span class="nf">EntityControllerBase</span><span class="p">(</span><span class="n">IBasicContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">_context</span> <span class="p">=</span> <span class="n">context</span><span class="p">;</span>
  <span class="n">_set</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">GetSet</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;();</span>
<span class="p">}</span>
</code></pre></div>
<p>As our new interfaces expose methods with the same signatures as those that the controller was using previously this is the only change required. The full source of the controllers
after refactoring <a href="https://github.com/wattsm/ODataTests/blob/master/ODataTests.After/Controllers/EntityControllerBase.cs">can be seen here</a>.</p>

<h3>Testing the controllers</h3>

<p>For most scenarios testing our controllers now involves creating a few simple mocks - for example here I use <a href="https://github.com/Moq/moq4">Moq</a> to create mocks of <code>IBasicContext</code> and <code>IBasicSet&lt;T&gt;</code> to test that
entities are added to the correct set in the controller&#39;s <code>Post</code> action.</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="na">[Fact]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">entity_is_added_to_set</span><span class="p">()</span> <span class="p">{</span>

    <span class="kt">var</span> <span class="k">set</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IBasicSet</span><span class="p">&lt;</span><span class="n">Entity</span><span class="p">&gt;&gt;();</span>

    <span class="kt">var</span> <span class="n">context</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IBasicContext</span><span class="p">&gt;();</span>
    <span class="n">context</span><span class="p">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">GetSet</span><span class="p">&lt;</span><span class="n">Entity</span><span class="p">&gt;()).</span><span class="n">Returns</span><span class="p">(</span><span class="k">set</span><span class="p">.</span><span class="n">Object</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">entity</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Entity</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">controller</span> <span class="p">=</span> <span class="n">Helpers</span><span class="p">.</span><span class="n">CreateController</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">Object</span><span class="p">);</span>

    <span class="n">controller</span><span class="p">.</span><span class="n">Post</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>

    <span class="k">set</span><span class="p">.</span><span class="n">Verify</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">entity</span><span class="p">),</span> <span class="n">Times</span><span class="p">.</span><span class="n">Once</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div>
<p><a href="https://github.com/wattsm/ODataTests/blob/master/ODataTests.After.Tests/Controllers/EntitiesControllerFacts.cs">You can see all of the controller tests here.</a></p>

<p>Some tests require slightly more complicated mocks and are worth discussing.</p>

<h4>Mocking <code>IQueryable&lt;T&gt;</code></h4>

<p>At some point in your controller tests you will want to check that the data returned is correct, and to do this you will need to provide your controller with a mock of <code>IBasicSet&lt;T&gt;</code> with a 
working implementation of <code>IQueryable&lt;T&gt;</code>. Thankfully the vast majority of the functionality of <code>IQueryable&lt;T&gt;</code> is provided via extension methods, and 
<a href="http://msdn.microsoft.com/en-us/library/vstudio/bb337580(v=vs.90).aspx">the interface itself is actually very simple</a>, consisting of 3 properties.</p>

<p>The easiest way I&#39;ve found of mocking <code>IQueryable&lt;T&gt;</code> is to create a simple collection that also implements <code>IQueryable&lt;T&gt;</code> and then use its <code>ElementType</code>, <code>Expression</code> and <code>Provider</code> properties
in my mock.</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">entities</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Entity</span><span class="p">&gt;();</span>
<span class="n">entities</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">Entity</span><span class="p">()</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="m">1</span> <span class="p">});</span>
<span class="n">entities</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">Entity</span><span class="p">()</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="m">2</span> <span class="p">});</span>

<span class="kt">var</span> <span class="n">queryable</span> <span class="p">=</span> <span class="n">entities</span><span class="p">.</span><span class="n">AsQueryable</span><span class="p">();</span>

<span class="kt">var</span> <span class="k">set</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IBasicSet</span><span class="p">&lt;</span><span class="n">Entity</span><span class="p">&gt;&gt;();</span>
<span class="k">set</span><span class="p">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">ElementType</span><span class="p">).</span><span class="n">Returns</span><span class="p">(</span><span class="n">queryable</span><span class="p">.</span><span class="n">ElementType</span><span class="p">);</span>
<span class="k">set</span><span class="p">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Expression</span><span class="p">).</span><span class="n">Returns</span><span class="p">(</span><span class="n">queryable</span><span class="p">.</span><span class="n">Expression</span><span class="p">);</span>
<span class="k">set</span><span class="p">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Provider</span><span class="p">).</span><span class="n">Returns</span><span class="p">(</span><span class="n">queryable</span><span class="p">.</span><span class="n">Provider</span><span class="p">);</span>
</code></pre></div>
<p>This gives your mock of <code>IBasicSet&lt;T&gt;</code> a working implementation of <code>IQueryable&lt;T&gt;</code> (essentially pointing at the collection you borrowed the 3 properties from). It has the added benefit of allowing you to manipulate the contents of the <code>IBasicSet&lt;T&gt;</code> during the test, meaning
you can simulate concurrency issues. </p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="na">[Fact]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">concurrency_exception_returns_not_found_if_entity_no_longer_exists</span><span class="p">()</span> <span class="p">{</span>

  <span class="kt">var</span> <span class="n">entities</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Entity</span><span class="p">&gt;(</span><span class="k">new</span> <span class="n">Entity</span><span class="p">[]</span> <span class="p">{</span>
    <span class="k">new</span> <span class="nf">Entity</span><span class="p">()</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="m">1</span> <span class="p">}</span>
  <span class="p">});</span>

  <span class="kt">var</span> <span class="n">context</span> <span class="p">=</span> <span class="n">Helpers</span><span class="p">.</span><span class="n">CreateContext</span><span class="p">(</span><span class="n">entities</span><span class="p">);</span>

  <span class="n">context</span><span class="p">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">SaveChanges</span><span class="p">()).</span><span class="n">Callback</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>

    <span class="c1">//Simulate another process deleting the entity by removing it</span>
    <span class="c1">//from the list used as the basis for the DbSet.</span>
    <span class="n">entities</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>

    <span class="c1">//Now tell the controller there was a concurrency error.</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">DbUpdateConcurrencyException</span><span class="p">();</span>
  <span class="p">});</span>

  <span class="kt">var</span> <span class="n">controller</span> <span class="p">=</span> <span class="n">Helpers</span><span class="p">.</span><span class="n">CreateController</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">Object</span><span class="p">);</span>

  <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">controller</span><span class="p">.</span><span class="n">Patch</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="k">new</span> <span class="n">Delta</span><span class="p">&lt;</span><span class="n">Entity</span><span class="p">&gt;());</span>

  <span class="n">Assert</span><span class="p">.</span><span class="n">NotNull</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
  <span class="n">Assert</span><span class="p">.</span><span class="n">IsType</span><span class="p">&lt;</span><span class="n">NotFoundResult</span><span class="p">&gt;(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>In this test we want to test that the controller correctly handles the case where an entity is deleted by another process while we are in the process of updating it. We create a collection of
entities and then when <code>SaveChanges</code> is called we remove everything from the collection and throw an exception. To the controller it will appear as if the entity that it was attempting to update
has been deleted by another process.</p>

<h4>Testing <code>Delta&lt;T&gt;</code></h4>

<p>Figuring out how <code>Delta&lt;T&gt;</code> worked too me a while.</p>

<p>I wanted to be able to test that entities were being correctly updated in the controller&#39;s <code>Patch</code> action - unfortunately the <code>Patch</code> method of <code>Delta&lt;T&gt;</code> is not virtual so frameworks like 
Moq cannot override or verify its behaviour. </p>

<p>Instead I started looking at simply constructing an instance of <code>Delta&lt;T&gt;</code>, populating it with changes and then checking the state of the entity to verify that the update had been performed. 
It was some time before I realised that <code>Delta&lt;T&gt;</code> is created using <code>dynamic</code> by WebAPI and updated properties are &quot;tacked on&quot; rather than there being methods to add changes to the delta. 
This is best illustrated by an example:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">entity</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Entity</span><span class="p">()</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">Value</span> <span class="p">=</span> <span class="s">&quot;X&quot;</span> <span class="p">};</span>

<span class="kt">dynamic</span> <span class="n">delta</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Delta</span><span class="p">&lt;</span><span class="n">Entity</span><span class="p">&gt;();</span>
<span class="n">delta</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="s">&quot;Y&quot;</span><span class="p">;</span> <span class="c1">//Dynamic property, Delta&lt;T&gt; does not contain a Value property</span>

<span class="n">delta</span><span class="p">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>

<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">entity</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span> <span class="c1">//Y</span>
</code></pre></div>
<p>This makes testing quite easy, if nothing else.</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="na">[Fact]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">entity_is_patched</span><span class="p">()</span> <span class="p">{</span>

  <span class="kt">var</span> <span class="n">entities</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Entity</span><span class="p">[]</span> <span class="p">{</span> 
    <span class="k">new</span> <span class="nf">Entity</span><span class="p">()</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&quot;Original&quot;</span> <span class="p">}</span>
  <span class="p">};</span>

  <span class="kt">var</span> <span class="n">controller</span> <span class="p">=</span> <span class="n">Helpers</span><span class="p">.</span><span class="n">CreateController</span><span class="p">(</span><span class="n">entities</span><span class="p">);</span>

  <span class="kt">dynamic</span> <span class="n">delta</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Delta</span><span class="p">&lt;</span><span class="n">Entity</span><span class="p">&gt;();</span>
  <span class="n">delta</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="s">&quot;Updated&quot;</span><span class="p">;</span>

  <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">controller</span><span class="p">.</span><span class="n">Patch</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="n">delta</span><span class="p">);</span>

  <span class="n">Assert</span><span class="p">.</span><span class="n">Equal</span><span class="p">(</span><span class="s">&quot;Updated&quot;</span><span class="p">,</span> <span class="n">_entities</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Name</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3>Conclusion</h3>

<p>In this post I&#39;ve shown that it&#39;s possible to take a simple Entity Framework / Web API OData service controller and make it testable by creating some simple wrappers for the EF components. 
If your project is a simple database-as-OData affair then this allows you to get high test coverage without having to introduce too many new layers or abstractions on top of the basic 
controller structure set out in the original ASP.Net article.</p>

<p>You can see the full source code for the before and after versions of the controller as well as the tests <a href="https://github.com/wattsm/ODataTests">in this GitHub repository</a>.</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/programming/2014/11/07/implementing-a-simple-ihttpactionresult/">
            Implementing a simple IHttpActionResult
            <small>07 Nov 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/programming/2014/11/18/modeling-mars-rovers-with-fsharp/">
            Modeling Mars rovers with F#
            <small>18 Nov 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/programming/2013/11/19/fsharp-serialising-option/">
            Serialising F#'s Option type using DataContractSerialiser
            <small>19 Nov 2013</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

  </body>
</html>
