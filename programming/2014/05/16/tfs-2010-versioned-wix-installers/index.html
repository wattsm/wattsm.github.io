<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>    
	Usermaatre &middot; Creating versioned installers using Wix and TFS 2010    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  
  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  
  <!-- Google analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-56516871-1', 'auto');
    ga('send', 'pageview');

  </script>
</head>


  <body class="theme-base-0b">
  
    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Usermaatre
        </a>
      </h1>
      <p class="lead">Programming, science, history and gaming. Not necessarily in that order.</p>
    </div>

    <nav class="sidebar-nav">
	  <a class="sidebar-nav-item" href="/">Home</a>
	  <a class="sidebar-nav-item" href="/about">About</a>
	  <a class="sidebar-nav-item" href="/archive">Archive</a>
      <a class="sidebar-nav-item" href="https://twitter.com/m_d_watts" target="_blank">Twitter</a>	  
      <a class="sidebar-nav-item" href="https://github.com/wattsm" target="_blank">GitHub</a>      
    </nav>
	
	<p>&copy; 2014. All rights reserved.</p>
	
	<hr />
	
	<p style="font-size:80%;">
		<a style='font-size: 70%' href='/tags/beyond-earth'>Beyond Earth</a>
<a style='font-size: 70%' href='/tags/castle-windsor'>Castle Windsor</a>
<a style='font-size: 70%' href='/tags/ci'>CI</a>
<a style='font-size: 70%' href='/tags/civilization'>Civilization</a>
<a style='font-size: 70%' href='/tags/design'>Design</a>
<a style='font-size: 70%' href='/tags/entity-framework'>Entity Framework</a>
<a style='font-size: 170%' href='/tags/fsharp'>F#</a>
<a style='font-size: 70%' href='/tags/moq'>Moq</a>
<a style='font-size: 70%' href='/tags/odata'>OData</a>
<a style='font-size: 70%' href='/tags/psexec'>PsExec</a>
<a style='font-size: 70%' href='/tags/reflection'>Reflection</a>
<a style='font-size: 120%' href='/tags/tfs'>TFS</a>
<a style='font-size: 149%' href='/tags/unit-testing'>Unit Testing</a>
<a style='font-size: 120%' href='/tags/webapi'>WebAPI</a>
<a style='font-size: 70%' href='/tags/wix'>Wix</a>
<a style='font-size: 149%' href='/tags/xunit'>xUnit</a>

	</p>	
	
  </div>
</div>


    <div class="content container">	
      <div class="post">
  <h1 class="post-title">Creating versioned installers using Wix and TFS 2010</h1>
  <span class="post-date">
	16 May 2014
&middot;
Programming 

	&middot;
	<a href="/tags/tfs">TFS</a>, 	

	
	<a href="/tags/wix">Wix</a>	
	
  </span>
  <p>Recently I created a Wix installer for a product and wanted to include the version number in the installer name – e.g. “My Product.1.2.3.msi”. 
I found this post which describes how to edit the .wixproj file to add a pre-build task to update the output filename to include a version. 
This worked perfectly when building the project locally, but not as a part of our TFS 2010 automated build. The reason for this is that TFS 2010 
outputs builds to the /Binaries/ directory rather than their local /bin/, so the relative paths in the solution given break. In this post I describe how I 
edited the .wixproj file to work both locally and as a part of a TFS 2010 automated build.</p>

<p>I also wanted my MSI  to use a three part version number rather than the default four part used.</p>

<!-- more -->

<h2>The existing solution</h2>

<p>Firstly, let’s take a look at the a solution based on the Tentacle Software blog post. Right click on your installer project, select “Unload” and 
then right click again and select “Edit X.wixproj”. Then modify the BeforeBuild target found at the bottom of the file.</p>
<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;Target</span> <span class="na">Name=</span><span class="s">&quot;BeforeBuild&quot;</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- Get version info from an assembly and store it in AssemblyVersions --&gt;</span>
  <span class="nt">&lt;GetAssemblyIdentity</span> <span class="na">AssemblyFiles=</span><span class="s">&quot;$(SolutionDir)MyProduct\bin\$(Platform)\$(Configuration)\MyProduct.dll&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;Output</span> <span class="na">TaskParameter=</span><span class="s">&quot;Assemblies&quot;</span> <span class="na">ItemName=</span><span class="s">&quot;AssemblyVersions&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/GetAssemblyIdentity&gt;</span>

  <span class="c">&lt;!-- Append the version to the filename - e.g. MyProduct.1.2 - and store in TargetName --&gt;</span>
  <span class="nt">&lt;CreateProperty</span> <span class="na">Value=</span><span class="s">&quot;$(OutputName).%(AssemblyVersions.Version)&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;Output</span> <span class="na">TaskParameter=</span><span class="s">&quot;Value&quot;</span> <span class="na">PropertyName=</span><span class="s">&quot;TargetName&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/CreateProperty&gt;</span>

  <span class="c">&lt;!-- Append the extension to the filename and store in TargetFileName --&gt;</span>
  <span class="nt">&lt;CreateProperty</span> <span class="na">Value=</span><span class="s">&quot;$(TargetName)$(TargetExt)&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;Output</span> <span class="na">TaskParameter=</span><span class="s">&quot;Value&quot;</span> <span class="na">PropertyName=</span><span class="s">&quot;TargetFileName&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/CreateProperty&gt;</span>

  <span class="c">&lt;!-- Finally, create a fully qualified path and update the TargetPath property used by MSBuild --&gt;</span>
  <span class="nt">&lt;CreateProperty</span> <span class="na">Value=</span><span class="s">&quot;$(TargetDir)$(TargetFileName)&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;Output</span> <span class="na">TaskParameter=</span><span class="s">&quot;Value&quot;</span> <span class="na">PropertyName=</span><span class="s">&quot;TargetPath&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/CreateProperty&gt;</span>
<span class="nt">&lt;/Target&gt;</span>
</code></pre></div>
<p>When a build is run in TFS 2010 it uses two folders – /Binaries and /Sources. The /Binaries folder is used as the output directory for all projects, while 
your solution files are kept in the /Sources folder. This means that the relative path between your installer project and MyProduct.dll will change, meaning 
the GetAssemblyIdentity task will not work. Using this approach it is not possible to create a solution that works both locally and as part of an automated build.</p>

<h2>An updated solution</h2>

<p>In order to get around this problem I simply defined two relative paths in my BeforeBuild target and used conditions to get the assembly version based on which 
path actually existed. This is a fairly crude approach but works locally and as a part of the automated build.</p>
<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;Target</span> <span class="na">Name=</span><span class="s">&quot;BeforeBuild&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- Relative paths to the DLL locally and on the CI server --&gt;</span>
    <span class="nt">&lt;PropertyGroup&gt;</span>
      <span class="nt">&lt;LocalAssembly&gt;</span>..\..\MyProduct\bin\$(Configuration)\MyProduct.dll<span class="nt">&lt;/LocalAssemvly&gt;</span>
      <span class="nt">&lt;TfsAssembly&gt;</span>..\..\..\..\..\..\Binaries\MyProduct.dll<span class="nt">&lt;/TfsAssembly&gt;</span>
    <span class="nt">&lt;/PropertyGroup&gt;</span>

    <span class="c">&lt;!-- Get the version number from whichever assembly exists--&gt;</span>
    <span class="nt">&lt;GetAssemblyIdentity</span> <span class="na">Condition=</span><span class="s">&quot;Exists($(LocalAssembly))&quot;</span> <span class="na">AssemblyFiles=</span><span class="s">&quot;$(LocalAssembly)&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;Output</span> <span class="na">TaskParameter=</span><span class="s">&quot;Assemblies&quot;</span> <span class="na">ItemName=</span><span class="s">&quot;ProductAssembly&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/GetAssemblyIdentity&gt;</span>
    <span class="nt">&lt;GetAssemblyIdentity</span> <span class="na">Condition=</span><span class="s">&quot;Exists($(TfsAssembly))&quot;</span> <span class="na">AssemblyFiles=</span><span class="s">&quot;$(TfsAssembly)&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;Output</span> <span class="na">TaskParameter=</span><span class="s">&quot;Assemblies&quot;</span> <span class="na">ItemName=</span><span class="s">&quot;ProductAssembly&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/GetAssemblyIdentity&gt;</span>

      <span class="c">&lt;!-- Append the version to the filename - e.g. MyProduct.1.2 - and store in TargetName --&gt;</span>
    <span class="nt">&lt;CreateProperty</span> <span class="na">Value=</span><span class="s">&quot;$(OutputName).%(ProductAssembly.Version)&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;Output</span> <span class="na">TaskParameter=</span><span class="s">&quot;Value&quot;</span> <span class="na">PropertyName=</span><span class="s">&quot;TargetName&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/CreateProperty&gt;</span>

    <span class="c">&lt;!-- Append the extension to the filename and store in TargetFileName --&gt;</span>
    <span class="nt">&lt;CreateProperty</span> <span class="na">Value=</span><span class="s">&quot;$(TargetName)$(TargetExt)&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;Output</span> <span class="na">TaskParameter=</span><span class="s">&quot;Value&quot;</span> <span class="na">PropertyName=</span><span class="s">&quot;TargetFileName&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/CreateProperty&gt;</span>

    <span class="c">&lt;!-- Finally, create a fully qualified path and update the TargetPath property used by MSBuild --&gt;</span>
    <span class="nt">&lt;CreateProperty</span> <span class="na">Value=</span><span class="s">&quot;$(TargetDir)$(TargetFileName)&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;Output</span> <span class="na">TaskParameter=</span><span class="s">&quot;Value&quot;</span> <span class="na">PropertyName=</span><span class="s">&quot;TargetPath&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/CreateProperty&gt;</span>
<span class="nt">&lt;/Target&gt;</span>
</code></pre></div>
<p>I have used relative paths for both local and TFS scenarios, but you could still use the $(SolutionDir) based approach from the 
original solution for $(LocalAssembly) if you wanted.</p>

<h2>Using a three part version number</h2>

<p>As MSIs essentially ignore the fourth part of versions numbers we tend to use three part version numbers and I wanted our installer to use a 
three part version too, whereas our current solution will include a four part version number (the last digit always being zero). So my final tweak was 
to remove that final zero. Handily in MSBuild versions greater than four properties can be manipulated like instances of the String class, meaning we have 
access to methods like IndexOf and Substring.</p>
<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;Target</span> <span class="na">Name=</span><span class="s">&quot;BeforeBuild&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- Relative paths to the DLL locally and on the CI server --&gt;</span>
    <span class="nt">&lt;PropertyGroup&gt;</span>
      <span class="nt">&lt;LocalAssembly&gt;</span>..\..\MyProduct\bin\$(Configuration)\MyProduct.dll<span class="nt">&lt;/LocalAssemvly&gt;</span>
      <span class="nt">&lt;TfsAssembly&gt;</span>..\..\..\..\..\..\Binaries\MyProduct.dll<span class="nt">&lt;/TfsAssembly&gt;</span>
    <span class="nt">&lt;/PropertyGroup&gt;</span>

    <span class="c">&lt;!-- Get the version number from whichever assembly exists--&gt;</span>
    <span class="nt">&lt;GetAssemblyIdentity</span> <span class="na">Condition=</span><span class="s">&quot;Exists($(LocalAssembly))&quot;</span> <span class="na">AssemblyFiles=</span><span class="s">&quot;$(LocalAssembly)&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;Output</span> <span class="na">TaskParameter=</span><span class="s">&quot;Assemblies&quot;</span> <span class="na">ItemName=</span><span class="s">&quot;ProductAssembly&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/GetAssemblyIdentity&gt;</span>
    <span class="nt">&lt;GetAssemblyIdentity</span> <span class="na">Condition=</span><span class="s">&quot;Exists($(TfsAssembly))&quot;</span> <span class="na">AssemblyFiles=</span><span class="s">&quot;$(TfsAssembly)&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;Output</span> <span class="na">TaskParameter=</span><span class="s">&quot;Assemblies&quot;</span> <span class="na">ItemName=</span><span class="s">&quot;ProductAssembly&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/GetAssemblyIdentity&gt;</span>

    <span class="c">&lt;!-- Remove the fourth part of the version number --&gt;</span>
    <span class="nt">&lt;CreateProperty</span> <span class="na">Value=</span><span class="s">&quot;%(ProductAssembly.Version)&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;Output</span> <span class="na">TaskParameter=</span><span class="s">&quot;Value&quot;</span> <span class="na">PropertyName=</span><span class="s">&quot;RawTargetVersion&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/CreateProperty&gt;</span>
    <span class="nt">&lt;CreateProperty</span> <span class="na">Value=</span><span class="s">&quot;$(RawTargetVersion.Substring(0, $(RawTargetVersion.LastIndexOf(&#39;.&#39;)) ))&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;Output</span> <span class="na">TaskParameter=</span><span class="s">&quot;Value&quot;</span> <span class="na">PropertyName=</span><span class="s">&quot;TargetVersion&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/CreateProperty&gt;</span>

      <span class="c">&lt;!-- Append the version to the filename - e.g. MyProduct.1.2 - and store in TargetName --&gt;</span>
    <span class="nt">&lt;CreateProperty</span> <span class="na">Value=</span><span class="s">&quot;$(OutputName).$(TargetVersion)&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;Output</span> <span class="na">TaskParameter=</span><span class="s">&quot;Value&quot;</span> <span class="na">PropertyName=</span><span class="s">&quot;TargetName&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/CreateProperty&gt;</span>

    <span class="c">&lt;!-- Append the extension to the filename and store in TargetFileName --&gt;</span>
    <span class="nt">&lt;CreateProperty</span> <span class="na">Value=</span><span class="s">&quot;$(TargetName)$(TargetExt)&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;Output</span> <span class="na">TaskParameter=</span><span class="s">&quot;Value&quot;</span> <span class="na">PropertyName=</span><span class="s">&quot;TargetFileName&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/CreateProperty&gt;</span>

    <span class="c">&lt;!-- Finally, create a fully qualified path and update the TargetPath property used by MSBuild --&gt;</span>
    <span class="nt">&lt;CreateProperty</span> <span class="na">Value=</span><span class="s">&quot;$(TargetDir)$(TargetFileName)&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;Output</span> <span class="na">TaskParameter=</span><span class="s">&quot;Value&quot;</span> <span class="na">PropertyName=</span><span class="s">&quot;TargetPath&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/CreateProperty&gt;</span>
<span class="nt">&lt;/Target&gt;</span>
</code></pre></div>
<p>This update adds two new targets which take the assembly version and then use IndexOf and Substring to remove the final, redundant zero from the version number.</p>

<p>With these changes made our product installers now include a three part version number in the filename when built both locally and as a part of our automated build.</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/programming/2014/05/16/tfs-2010-versioned-wix-installers/">
            Creating versioned installers using Wix and TFS 2010
            <small>16 May 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/programming/2014/02/03/tfs-2010-xunit/">
            Running xUnit tests as a part of a TFS 2010 build
            <small>03 Feb 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/programming/2014/12/12/testing-web-api-odata-controllers/">
            Testing Web API OData controllers
            <small>12 Dec 2014</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

  </body>
</html>
