<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>    
	Usermaatre &middot; Serialising F#'s Option type using DataContractSerialiser    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  
  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  
  <!-- Google analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-56516871-1', 'auto');
    ga('send', 'pageview');

  </script>
</head>


  <body class="theme-base-0b">
  
    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Usermaatre
        </a>
      </h1>
      <p class="lead">Programming, science, history and gaming. Not necessarily in that order.</p>
    </div>

    <nav class="sidebar-nav">
	  <a class="sidebar-nav-item" href="/">Home</a>
	  <a class="sidebar-nav-item" href="/about">About</a>
	  <a class="sidebar-nav-item" href="/archive">Archive</a>
      <a class="sidebar-nav-item" href="https://twitter.com/m_d_watts" target="_blank">Twitter</a>	  
      <a class="sidebar-nav-item" href="https://github.com/wattsm" target="_blank">GitHub</a>      
    </nav>
	
	<p>&copy; 2015. All rights reserved.</p>
	
	<hr />
	
	<p style="font-size:80%;">
		<a style='font-size: 70%' href='/tags/beyond-earth'>Beyond Earth</a>
<a style='font-size: 70%' href='/tags/castle-windsor'>Castle Windsor</a>
<a style='font-size: 70%' href='/tags/ci'>CI</a>
<a style='font-size: 70%' href='/tags/civilization'>Civilization</a>
<a style='font-size: 70%' href='/tags/design'>Design</a>
<a style='font-size: 70%' href='/tags/entity-framework'>Entity Framework</a>
<a style='font-size: 170%' href='/tags/fsharp'>F#</a>
<a style='font-size: 70%' href='/tags/moq'>Moq</a>
<a style='font-size: 70%' href='/tags/odata'>OData</a>
<a style='font-size: 70%' href='/tags/psexec'>PsExec</a>
<a style='font-size: 70%' href='/tags/reflection'>Reflection</a>
<a style='font-size: 113%' href='/tags/tfs'>TFS</a>
<a style='font-size: 138%' href='/tags/unit-testing'>Unit Testing</a>
<a style='font-size: 113%' href='/tags/webapi'>WebAPI</a>
<a style='font-size: 70%' href='/tags/wix'>Wix</a>
<a style='font-size: 138%' href='/tags/xunit'>xUnit</a>

	</p>	
	
  </div>
</div>


    <div class="content container">	
      <div class="post">
  <h1 class="post-title">Serialising F#'s Option type using DataContractSerialiser</h1>
  <span class="post-date">
	19 Nov 2013
&middot;
Programming 

	&middot;
	<a href="/tags/fsharp">F#</a>	
	
  </span>
  <p><a href="http://msdn.microsoft.com/en-us/library/ms733127(v=vs.110).aspx">Data contracts</a> are a quick and relatively easy way of serialising objects to XML (or JSON, but we’ll stick to XML in this post) – e.g. for use as <a href="http://en.wikipedia.org/wiki/Data_transfer_object">DTOs</a>.</p>

<p>Various attributes can be used to control aspects of the generated XML, meaning you can produce clean, simple XML quite easily. Using these attributes it is possible for the DataContractSerializer to serialise and deserialise F# record types, 
which can be really handy when writing web services. However, a few wrinkles arise when using F#’s Option<T> type.</p>

<!-- more -->

<p>For example, take this simple model of a person:</p>

<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="lineno">1</span> <span class="o">[&lt;</span><span class="n">DataContract</span> <span class="o">(</span><span class="n">Name</span> <span class="o">=</span> <span class="s">&quot;person&quot;</span><span class="o">,</span> <span class="n">Namespace</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">)&gt;]</span>
<span class="lineno">2</span> <span class="k">type</span> <span class="nc">Person</span> <span class="o">=</span> <span class="o">{</span>
<span class="lineno">3</span>   <span class="o">[&lt;</span><span class="n">field</span><span class="o">:</span> <span class="n">DataMember</span> <span class="o">(</span><span class="n">Name</span> <span class="o">=</span> <span class="s">&quot;name&quot;</span><span class="o">)&gt;]</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">String</span><span class="o">;</span>
<span class="lineno">4</span> <span class="o">}</span></code></pre></div>

<p>The default XML produced will look like this:</p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="lineno">1</span> <span class="nt">&lt;person</span> <span class="na">xmlns:i=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><span class="nt">&gt;</span>
<span class="lineno">2</span>   <span class="nt">&lt;name&gt;</span>John Smith<span class="nt">&lt;/name&gt;</span>
<span class="lineno">3</span> <span class="nt">&lt;/person&gt;</span></code></pre></div>

<p><em>Notice that the DataMember attribute is applied using the field modifier – this tells .Net to apply the attribute to the backing field used by the property, as the property itself has no setter which is required by the serialiser.</em></p>

<p>So far, so good. However, problems start to appear when we want to represent optional parts of our model, for example take this model:</p>

<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="lineno"> 1</span> <span class="o">[&lt;</span><span class="n">DataContract</span> <span class="o">(</span><span class="n">Name</span> <span class="o">=</span> <span class="s">&quot;department&quot;</span><span class="o">,</span> <span class="n">Namespace</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">)&gt;]</span>
<span class="lineno"> 2</span> <span class="k">type</span> <span class="nc">Department</span> <span class="o">=</span> <span class="o">{</span>
<span class="lineno"> 3</span>     <span class="o">[&lt;</span><span class="n">field</span><span class="o">:</span> <span class="n">DataMember</span> <span class="o">(</span><span class="n">Name</span> <span class="o">=</span> <span class="s">&quot;name&quot;</span><span class="o">)&gt;]</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">String</span><span class="o">;</span>
<span class="lineno"> 4</span> <span class="o">}</span>
<span class="lineno"> 5</span>  
<span class="lineno"> 6</span> <span class="o">[&lt;</span><span class="n">DataContract</span> <span class="o">(</span><span class="n">Name</span> <span class="o">=</span> <span class="s">&quot;team&quot;</span><span class="o">,</span> <span class="n">Namespace</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">)&gt;]</span>
<span class="lineno"> 7</span> <span class="k">type</span> <span class="nc">Team</span> <span class="o">=</span> <span class="o">{</span>
<span class="lineno"> 8</span>     <span class="o">[&lt;</span><span class="n">field</span><span class="o">:</span> <span class="n">DataMember</span> <span class="o">(</span><span class="n">Name</span> <span class="o">=</span> <span class="s">&quot;name&quot;</span><span class="o">)&gt;]</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">String</span><span class="o">;</span>
<span class="lineno"> 9</span>     <span class="o">[&lt;</span><span class="n">field</span><span class="o">:</span> <span class="n">DataMember</span> <span class="o">(</span><span class="n">Name</span> <span class="o">=</span> <span class="s">&quot;dept&quot;</span><span class="o">)&gt;]</span> <span class="n">Department</span> <span class="o">:</span> <span class="n">Department</span> <span class="n">option</span><span class="o">;</span>
<span class="lineno">10</span> <span class="o">}</span>
<span class="lineno">11</span>  
<span class="lineno">12</span> <span class="o">[&lt;</span><span class="n">DataContract</span> <span class="o">(</span><span class="n">Name</span> <span class="o">=</span> <span class="s">&quot;developer&quot;</span><span class="o">,</span> <span class="n">Namespace</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">)&gt;]</span>
<span class="lineno">13</span> <span class="k">type</span> <span class="nc">Developer</span> <span class="o">=</span> <span class="o">{</span>
<span class="lineno">14</span>     <span class="o">[&lt;</span><span class="n">field</span><span class="o">:</span> <span class="n">DataMember</span> <span class="o">(</span><span class="n">Name</span> <span class="o">=</span> <span class="s">&quot;name&quot;</span><span class="o">)&gt;]</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">String</span><span class="o">;</span>
<span class="lineno">15</span>     <span class="o">[&lt;</span><span class="n">field</span><span class="o">:</span> <span class="n">DataMember</span> <span class="o">(</span><span class="n">Name</span> <span class="o">=</span> <span class="s">&quot;team&quot;</span><span class="o">)&gt;]</span> <span class="n">Team</span> <span class="o">:</span> <span class="n">Team</span> <span class="n">option</span><span class="o">;</span>
<span class="lineno">16</span> <span class="o">}</span></code></pre></div>

<p>Here a developer can optionally be associated with a team, which in turn can optionally be associated with a department. The problem is that the DataContractSerializer does not know how to serialise Option<T> and so you end up with ugly XML containing platform specific information. Here’s an example:</p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="lineno"> 1</span> <span class="nt">&lt;developer</span> <span class="na">xmlns:i=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><span class="nt">&gt;</span>
<span class="lineno"> 2</span>   <span class="nt">&lt;name&gt;</span>John Smith<span class="nt">&lt;/name&gt;</span>
<span class="lineno"> 3</span>   <span class="nt">&lt;team</span> <span class="na">xmlns:a=</span><span class="s">&quot;http://schemas.datacontract.org/2004/07/Microsoft.FSharp.Core&quot;</span><span class="nt">&gt;</span>
<span class="lineno"> 4</span>     <span class="nt">&lt;a:value&gt;</span>
<span class="lineno"> 5</span>       <span class="nt">&lt;dept&gt;</span>
<span class="lineno"> 6</span>         <span class="nt">&lt;a:value&gt;</span>
<span class="lineno"> 7</span>           <span class="nt">&lt;name&gt;</span>Product Development<span class="nt">&lt;/name&gt;</span>
<span class="lineno"> 8</span>         <span class="nt">&lt;/a:value&gt;</span>
<span class="lineno"> 9</span>       <span class="nt">&lt;/dept&gt;</span>
<span class="lineno">10</span>       <span class="nt">&lt;name&gt;</span>Red Team<span class="nt">&lt;/name&gt;</span>
<span class="lineno">11</span>     <span class="nt">&lt;/a:value&gt;</span>
<span class="lineno">12</span>   <span class="nt">&lt;/team&gt;</span>
<span class="lineno">13</span> <span class="nt">&lt;/developer&gt;</span></code></pre></div>

<p>If we wanted to use this XML for a web service or similar we would ideally want Some X to be serialised as X and None to be omitted or empty, e.g.:</p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="lineno">1</span> <span class="nt">&lt;developer</span> <span class="na">xmlns:i=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><span class="nt">&gt;</span>
<span class="lineno">2</span>   <span class="nt">&lt;name&gt;</span>John Smith<span class="nt">&lt;/name&gt;</span>
<span class="lineno">3</span>   <span class="nt">&lt;team&gt;</span>
<span class="lineno">4</span>     <span class="nt">&lt;dept&gt;</span>
<span class="lineno">5</span>       <span class="nt">&lt;name&gt;</span>Product Development<span class="nt">&lt;/name&gt;</span>
<span class="lineno">6</span>     <span class="nt">&lt;/dept&gt;</span>
<span class="lineno">7</span>     <span class="nt">&lt;name&gt;</span>Red Team<span class="nt">&lt;/name&gt;</span>
<span class="lineno">8</span>   <span class="nt">&lt;/team&gt;</span>
<span class="lineno">9</span> <span class="nt">&lt;/developer&gt;</span></code></pre></div>

<p>Luckily there are a couple of tricks at our disposal.</p>

<h2>Using IDataContractSurrogate</h2>

<p>The first thing we can do is use a <a href="http://msdn.microsoft.com/en-us/library/system.runtime.serialization.idatacontractsurrogate(v=vs.110).aspx">data contract surrogate</a> to tell the serialiser that Some X should be serialised as X and None should be treated as null. The interface defines several methods but we only need to implement three of them:</p>

<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="lineno"> 1</span> <span class="k">type</span> <span class="nc">OptionSurrogate</span> <span class="bp">()</span> <span class="o">=</span> 
<span class="lineno"> 2</span>   <span class="k">interface</span> <span class="n">IDataContractSurrogate</span> <span class="k">with</span>
<span class="lineno"> 3</span>  
<span class="lineno"> 4</span>       <span class="sd">///Tell the serialiser to treat Option&lt;&#39;T&gt; as &#39;T</span>
<span class="lineno"> 5</span>       <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetDataContractType</span> <span class="o">(</span><span class="n">currentType</span> <span class="o">:</span> <span class="n">Type</span><span class="o">)</span> <span class="o">=</span> 
<span class="lineno"> 6</span>           <span class="k">match</span> <span class="o">(</span><span class="n">getOptionalType</span> <span class="n">currentType</span><span class="o">)</span> <span class="k">with</span>
<span class="lineno"> 7</span>           <span class="o">|</span> <span class="n">Some</span> <span class="n">baseType</span> <span class="o">-&gt;</span> <span class="n">baseType</span>
<span class="lineno"> 8</span>           <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">currentType</span>
<span class="lineno"> 9</span>  
<span class="lineno">10</span>       <span class="sd">///When deserialising, convert null to None and &#39;T to Some&lt;&#39;T&gt;</span>
<span class="lineno">11</span>       <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetDeserializedObject</span> <span class="o">(</span><span class="n">current</span><span class="o">,</span> <span class="n">currentType</span><span class="o">)</span> <span class="o">=</span> 
<span class="lineno">12</span>           <span class="k">if</span> <span class="o">(</span><span class="n">isOptionalType</span> <span class="n">currentType</span><span class="o">)</span> <span class="k">then</span>
<span class="lineno">13</span>               <span class="k">if</span> <span class="o">(</span><span class="n">current</span> <span class="o">&lt;&gt;</span> <span class="k">null</span><span class="o">)</span> <span class="k">then</span>
<span class="lineno">14</span>                   <span class="nn">Activator</span><span class="p">.</span><span class="n">CreateInstance</span> <span class="o">(</span><span class="n">currentType</span><span class="o">,</span> <span class="o">[|</span> <span class="n">current</span> <span class="o">|])</span>
<span class="lineno">15</span>               <span class="k">else</span>
<span class="lineno">16</span>               
<span class="lineno">17</span>                   <span class="k">let</span> <span class="nv">noneProperty</span> <span class="o">=</span> <span class="n">currentType</span><span class="o">.</span><span class="n">GetProperty</span> <span class="o">(</span><span class="s">&quot;None&quot;</span><span class="o">)</span>
<span class="lineno">18</span>                   <span class="n">noneProperty</span><span class="o">.</span><span class="n">GetValue</span> <span class="o">(</span><span class="k">null</span><span class="o">)</span>
<span class="lineno">19</span>  
<span class="lineno">20</span>           <span class="k">else</span>
<span class="lineno">21</span>               <span class="n">current</span>
<span class="lineno">22</span>  
<span class="lineno">23</span>       <span class="sd">///When serialising, convert Some&lt;&#39;T&gt; to &#39;T and None to null</span>
<span class="lineno">24</span>       <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetObjectToSerialize</span> <span class="o">(</span><span class="n">current</span><span class="o">,</span> <span class="o">_)</span> <span class="o">=</span> 
<span class="lineno">25</span>           <span class="k">if</span> <span class="o">(</span><span class="n">current</span> <span class="o">&lt;&gt;</span> <span class="k">null</span><span class="o">)</span> <span class="k">then</span>
<span class="lineno">26</span>           
<span class="lineno">27</span>               <span class="k">let</span> <span class="nv">currentType</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">GetType</span> <span class="bp">()</span>
<span class="lineno">28</span>  
<span class="lineno">29</span>               <span class="k">if</span> <span class="o">(</span><span class="n">isOptionalType</span> <span class="n">currentType</span><span class="o">)</span> <span class="k">then</span>
<span class="lineno">30</span>  
<span class="lineno">31</span>                   <span class="k">let</span> <span class="nv">isSomeProperty</span> <span class="o">=</span> <span class="n">currentType</span><span class="o">.</span><span class="n">GetProperty</span> <span class="s">&quot;IsSome&quot;</span>
<span class="lineno">32</span>                   <span class="k">let</span> <span class="nv">isSome</span> <span class="o">=</span> <span class="n">isSomeProperty</span><span class="o">.</span><span class="n">GetValue</span> <span class="o">(</span><span class="k">null</span><span class="o">,</span> <span class="o">[|</span> <span class="n">current</span> <span class="o">|])</span> <span class="o">:?&gt;</span> <span class="kt">bool</span>
<span class="lineno">33</span>  
<span class="lineno">34</span>                   <span class="k">if</span> <span class="n">isSome</span> <span class="k">then</span>
<span class="lineno">35</span>  
<span class="lineno">36</span>                       <span class="k">let</span> <span class="nv">valueProperty</span> <span class="o">=</span> <span class="n">currentType</span><span class="o">.</span><span class="n">GetProperty</span> <span class="s">&quot;Value&quot;</span>
<span class="lineno">37</span>                       <span class="n">valueProperty</span><span class="o">.</span><span class="n">GetValue</span> <span class="o">(</span><span class="n">current</span><span class="o">)</span>
<span class="lineno">38</span>  
<span class="lineno">39</span>                   <span class="k">else</span>
<span class="lineno">40</span>                       <span class="k">null</span>
<span class="lineno">41</span>               <span class="k">else</span>
<span class="lineno">42</span>                   <span class="n">current</span>
<span class="lineno">43</span>           <span class="k">else</span>
<span class="lineno">44</span>               <span class="n">current</span>
<span class="lineno">45</span>  
<span class="lineno">46</span>       <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetCustomDataToExport</span> <span class="o">(_</span> <span class="o">:</span> <span class="n">MemberInfo</span><span class="o">,</span> <span class="o">_</span> <span class="o">:</span> <span class="n">Type</span><span class="o">)</span> <span class="o">=</span> <span class="n">box</span> <span class="k">null</span>
<span class="lineno">47</span>       <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetCustomDataToExport</span> <span class="o">(_</span> <span class="o">:</span> <span class="n">Type</span><span class="o">,</span> <span class="o">_</span> <span class="o">:</span> <span class="n">Type</span><span class="o">)</span> <span class="o">=</span> <span class="n">box</span> <span class="k">null</span>
<span class="lineno">48</span>       <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetKnownCustomDataTypes</span> <span class="o">_</span> <span class="o">=</span> <span class="bp">()</span>
<span class="lineno">49</span>       <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">ProcessImportedType</span> <span class="o">(</span><span class="n">decl</span><span class="o">,</span> <span class="o">_)</span> <span class="o">=</span> <span class="n">decl</span>
<span class="lineno">50</span>       <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">GetReferencedTypeOnImport</span> <span class="o">(_,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">=</span> <span class="k">null</span></code></pre></div>

<p>Now when you create your DataContractSerializer you need to give it an instance of the surrogate:</p>

<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="lineno"> 1</span> <span class="k">let</span> <span class="nv">surrogate</span> <span class="o">=</span> <span class="n">OptionSurrogate</span> <span class="bp">()</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="k">let</span> <span class="nv">serialiser</span> <span class="o">=</span> <span class="n">DataContractSerializer</span> <span class="o">(</span>
<span class="lineno"> 4</span>  <span class="n">typeof</span><span class="o">&lt;</span><span class="n">Developer</span><span class="o">&gt;,</span> 
<span class="lineno"> 5</span>  <span class="nn">Seq</span><span class="p">.</span><span class="n">empty</span><span class="o">,</span> 
<span class="lineno"> 6</span>  <span class="nn">Int32</span><span class="p">.</span><span class="n">MaxValue</span><span class="o">,</span> 
<span class="lineno"> 7</span>  <span class="k">true</span><span class="o">,</span> 
<span class="lineno"> 8</span>  <span class="k">false</span><span class="o">,</span> 
<span class="lineno"> 9</span>  <span class="n">surrogate</span>
<span class="lineno">10</span> <span class="o">)</span></code></pre></div>

<p>When we serialise our model optional types will be slightly cleaner. For example:</p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="lineno">1</span> <span class="nt">&lt;developer</span> <span class="na">xmlns:i=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><span class="nt">&gt;</span>
<span class="lineno">2</span>   <span class="nt">&lt;name&gt;</span>John Smith<span class="nt">&lt;/name&gt;</span>
<span class="lineno">3</span>   <span class="nt">&lt;team</span> <span class="na">xmlns:a=</span><span class="s">&quot;http://schemas.datacontract.org/2004/07/Microsoft.FSharp.Core&quot;</span><span class="nt">&gt;</span>
<span class="lineno">4</span>     <span class="nt">&lt;dept&gt;</span>
<span class="lineno">5</span>       <span class="nt">&lt;name&gt;</span>Product Development<span class="nt">&lt;/name&gt;</span>
<span class="lineno">6</span>     <span class="nt">&lt;/dept&gt;</span>
<span class="lineno">7</span>     <span class="nt">&lt;name&gt;</span>Red Team<span class="nt">&lt;/name&gt;</span>
<span class="lineno">8</span>   <span class="nt">&lt;/team&gt;</span>
<span class="lineno">9</span> <span class="nt">&lt;/developer&gt;</span></code></pre></div>

<p>Or when Team is None:</p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="lineno">1</span> <span class="nt">&lt;developer</span> <span class="na">xmlns:i=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><span class="nt">&gt;</span>
<span class="lineno">2</span>   <span class="nt">&lt;name&gt;</span>John Smith<span class="nt">&lt;/name&gt;</span>
<span class="lineno">3</span>   <span class="nt">&lt;team</span> <span class="na">i:nil=</span><span class="s">&quot;true&quot;</span> <span class="na">xmlns:a=</span><span class="s">&quot;http://schemas.datacontract.org/2004/07/Microsoft.FSharp.Core&quot;</span><span class="nt">/&gt;</span>
<span class="lineno">4</span> <span class="nt">&lt;/developer&gt;</span></code></pre></div>

<p><em>Setting the EmitDefaultValue property to false on the DataMember attribute for the Team property will cause the element to be omitted entirely as None is considered to be the default value of Option<T>.</em></p>

<p>Although the XML structure is cleaner the serialiser has now started to decorate elements with attributes relating to the Option<T> type, despite it no longer being serialised.</p>

<h2>Cleaning up</h2>

<p>Luckily, removing these unnecessary attributes is fairly easy. In fact, the only attributes that are of any use to us are the ones that reside in the XML schema namespace (prefixed “i” in the examples) – so we can take the stream written to by the data contract serialiser and simply tweak the generated XML so that all attributes not in the XML schema namespace are removed.</p>

<p>For example, a simple function which cleans up a stream of XML is shown below:</p>

<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="lineno"> 1</span> <span class="sd">///castMany&lt;&#39;T&gt; : IEnumerable -&gt; &#39;T list</span>
<span class="lineno"> 2</span> <span class="sd">///getXml : Stream -&gt; XmlDocument</span>
<span class="lineno"> 3</span>  
<span class="lineno"> 4</span> <span class="k">let</span> <span class="o">[&lt;</span><span class="n">Literal</span><span class="o">&gt;]</span> <span class="n">XmlnsNamespace</span> <span class="o">=</span> <span class="s">&quot;http://www.w3.org/2000/xmlns/&quot;</span>
<span class="lineno"> 5</span> <span class="k">let</span> <span class="o">[&lt;</span><span class="n">Literal</span><span class="o">&gt;]</span> <span class="n">SchemaNamespace</span> <span class="o">=</span> <span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
<span class="lineno"> 6</span>  
<span class="lineno"> 7</span> <span class="k">let</span> <span class="nv">cleanUp</span> <span class="o">(</span><span class="n">input</span> <span class="o">:</span> <span class="n">Stream</span><span class="o">)</span> <span class="o">=</span> 
<span class="lineno"> 8</span>  
<span class="lineno"> 9</span>   <span class="k">let</span> <span class="nv">rec</span> <span class="n">removeAttrs</span> <span class="o">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">XmlNode</span><span class="o">)</span> <span class="o">=</span> 
<span class="lineno">10</span>  
<span class="lineno">11</span>       <span class="k">if</span> <span class="o">(</span><span class="n">node</span><span class="o">.</span><span class="n">Attributes</span> <span class="o">&lt;&gt;</span> <span class="k">null</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="o">.</span><span class="n">Attributes</span><span class="o">.</span><span class="n">Count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="k">then</span>
<span class="lineno">12</span>           <span class="n">node</span><span class="o">.</span><span class="n">Attributes</span>
<span class="lineno">13</span>           <span class="o">|&gt;</span> <span class="n">castMany</span><span class="o">&lt;</span><span class="n">XmlAttribute</span><span class="o">&gt;</span>
<span class="lineno">14</span>           <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">attr</span> <span class="o">-&gt;</span> <span class="ow">not</span> <span class="o">(</span><span class="n">attr</span><span class="o">.</span><span class="n">NamespaceURI</span> <span class="o">=</span> <span class="n">SchemaNamespace</span><span class="o">))</span>
<span class="lineno">15</span>           <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">attr</span> <span class="o">-&gt;</span> <span class="n">node</span><span class="o">.</span><span class="n">Attributes</span><span class="o">.</span><span class="n">Remove</span> <span class="o">(</span><span class="n">attr</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span><span class="o">)</span>
<span class="lineno">16</span>  
<span class="lineno">17</span>       <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">HasChildNodes</span> <span class="k">then</span>
<span class="lineno">18</span>           <span class="n">node</span><span class="o">.</span><span class="n">ChildNodes</span>
<span class="lineno">19</span>           <span class="o">|&gt;</span> <span class="n">castMany</span><span class="o">&lt;</span><span class="n">XmlNode</span><span class="o">&gt;</span>
<span class="lineno">20</span>           <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="n">removeAttrs</span>
<span class="lineno">21</span>  
<span class="lineno">22</span>   <span class="k">let</span> <span class="nv">appendXmlns</span> <span class="o">(</span><span class="n">xml</span> <span class="o">:</span> <span class="n">XmlDocument</span><span class="o">)</span> <span class="o">=</span> 
<span class="lineno">23</span>  
<span class="lineno">24</span>       <span class="k">let</span> <span class="nv">attr</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">CreateAttribute</span> <span class="o">(</span><span class="s">&quot;xmlns&quot;</span><span class="o">,</span> <span class="s">&quot;i&quot;</span><span class="o">,</span> <span class="n">XmlnsNamespace</span><span class="o">)</span>
<span class="lineno">25</span>       <span class="n">attr</span><span class="o">.</span><span class="n">Value</span> <span class="o">&lt;-</span> <span class="n">SchemaNamespace</span>
<span class="lineno">26</span>  
<span class="lineno">27</span>       <span class="n">xml</span><span class="o">.</span><span class="n">DocumentElement</span><span class="o">.</span><span class="n">Attributes</span><span class="o">.</span><span class="n">Append</span> <span class="o">(</span><span class="n">attr</span><span class="o">)</span>
<span class="lineno">28</span>       <span class="o">|&gt;</span> <span class="n">ignore</span>
<span class="lineno">29</span>  
<span class="lineno">30</span>   <span class="k">let</span> <span class="nv">xml</span> <span class="o">=</span> <span class="n">getXml</span> <span class="n">input</span>
<span class="lineno">31</span>  
<span class="lineno">32</span>   <span class="n">removeAttrs</span> <span class="n">xml</span><span class="o">.</span><span class="n">DocumentElement</span>
<span class="lineno">33</span>   <span class="n">appendXmlns</span> <span class="n">xml</span>
<span class="lineno">34</span>  
<span class="lineno">35</span>   <span class="k">let</span> <span class="nv">settings</span> <span class="o">=</span> <span class="n">XmlWriterSettings</span> <span class="bp">()</span>
<span class="lineno">36</span>   <span class="n">settings</span><span class="o">.</span><span class="n">OmitXmlDeclaration</span> <span class="o">&lt;-</span> <span class="k">true</span>
<span class="lineno">37</span>   <span class="n">settings</span><span class="o">.</span><span class="n">NamespaceHandling</span> <span class="o">&lt;-</span> <span class="nn">NamespaceHandling</span><span class="p">.</span><span class="n">OmitDuplicates</span>
<span class="lineno">38</span>  
<span class="lineno">39</span>   <span class="k">let</span> <span class="nv">output</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MemoryStream</span> <span class="bp">()</span>
<span class="lineno">40</span>   <span class="k">use</span> <span class="n">writer</span> <span class="o">=</span> <span class="nn">XmlWriter</span><span class="p">.</span><span class="n">Create</span> <span class="o">(</span><span class="n">output</span><span class="o">,</span> <span class="n">settings</span><span class="o">)</span>
<span class="lineno">41</span>  
<span class="lineno">42</span>   <span class="n">xml</span><span class="o">.</span><span class="n">WriteTo</span> <span class="o">(</span><span class="n">writer</span><span class="o">)</span>
<span class="lineno">43</span>  
<span class="lineno">44</span>   <span class="n">output</span></code></pre></div>

<p>When the previous examples are passed through this function we end up with:</p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="lineno">1</span> <span class="nt">&lt;developer</span> <span class="na">xmlns:i=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><span class="nt">&gt;</span>
<span class="lineno">2</span>   <span class="nt">&lt;name&gt;</span>John Smith<span class="nt">&lt;/name&gt;</span>
<span class="lineno">3</span>   <span class="nt">&lt;team&gt;</span>
<span class="lineno">4</span>     <span class="nt">&lt;dept&gt;</span>
<span class="lineno">5</span>       <span class="nt">&lt;name&gt;</span>Product Development<span class="nt">&lt;/name&gt;</span>
<span class="lineno">6</span>     <span class="nt">&lt;/dept&gt;</span>
<span class="lineno">7</span>     <span class="nt">&lt;name&gt;</span>Red Team<span class="nt">&lt;/name&gt;</span>
<span class="lineno">8</span>   <span class="nt">&lt;/team&gt;</span>
<span class="lineno">9</span> <span class="nt">&lt;/developer&gt;</span></code></pre></div>

<p>And:</p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="lineno">1</span> <span class="nt">&lt;developer</span> <span class="na">xmlns:i=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><span class="nt">&gt;</span>
<span class="lineno">2</span>   <span class="nt">&lt;name&gt;</span>John Smith<span class="nt">&lt;/name&gt;</span>
<span class="lineno">3</span>   <span class="nt">&lt;team</span> <span class="na">i:nil=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
<span class="lineno">4</span> <span class="nt">&lt;/developer&gt;</span></code></pre></div>

<p>Much better!</p>

<p>Handily the additional attributes added by the serialiser are not needed to deserialise the XML – so the above examples will both be deserialised correctly.</p>

<h2>Cavaet</h2>

<p>An unfortunate cavaet to this is that the surrogate’s GetDeserializedObject which is used to convert from T to Some T during deserialisation only appears to be called if T is a data contract. That means you cannot use this approach for optional properties which are not data contracts – e.g. String option.</p>

<h2>Example code</h2>

<p>An example application which demonstrates default serialisation, serialisation using the surrogate and serialisation using the surrogate and clean-up can be <a href="https://github.com/wattsm/serialising-f-sharp-options">found on here on GitHub</a>.</p>

</div>

<div class="related">
  <h3>Related Posts</h3>
  <ul class="related-posts">
    
      <li>
        <h5>
          <a href="/programming/2015/01/19/futures-in-fsharp/">
            Futures in F#
            <small>19 Jan 2015</small>
          </a>
        </h5>
      </li>
    
      <li>
        <h5>
          <a href="/programming/2013/07/24/fsharp-collections-reflection/">
            Creating F# collections via reflection
            <small>24 Jul 2013</small>
          </a>
        </h5>
      </li>
    
      <li>
        <h5>
          <a href="/programming/2014/11/18/modeling-mars-rovers-with-fsharp/">
            Modeling Mars rovers with F#
            <small>18 Nov 2014</small>
          </a>
        </h5>
      </li>
    
  </ul>
</div>
    </div>

  </body>
</html>
