<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>    
	Usermaatre &middot; Creating F# collections via reflection    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  
  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  
  <!-- Google analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-56516871-1', 'auto');
    ga('send', 'pageview');

  </script>
</head>


  <body class="theme-base-0b">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Usermaatre
        </a>
      </h1>
      <p class="lead">Programming, science, history and gaming. Not necessarily in that order.</p>
    </div>

    <nav class="sidebar-nav">
	  <a class="sidebar-nav-item" href="/">Home</a>
	  <a class="sidebar-nav-item" href="/about">About</a>
	  <a class="sidebar-nav-item" href="/archive">Archive</a>
      <a class="sidebar-nav-item" href="https://twitter.com/m_d_watts" target="_blank">Twitter</a>	  
      <a class="sidebar-nav-item" href="https://github.com/wattsm" target="_blank">GitHub</a>
      <span class="sidebar-nav-item">Currently v0.9</span>
    </nav>

    <p>&copy; 2014. All rights reserved.</p>
	
	<p>
		<a style='font-size: 70%' href='/tags/ci'>CI</a>
<a style='font-size: 170%' href='/tags/fsharp'>F#</a>
<a style='font-size: 70%' href='/tags/reflection'>Reflection</a>
<a style='font-size: 170%' href='/tags/tfs'>TFS</a>
<a style='font-size: 70%' href='/tags/webapi'>WebAPI</a>
<a style='font-size: 70%' href='/tags/wix'>Wix</a>
<a style='font-size: 70%' href='/tags/xunit'>xUnit</a>

	</p>
  </div>
</div>


    <div class="content container">	
      <div class="post">
  <h1 class="post-title">Creating F# collections via reflection</h1>
  <span class="post-date">
	24 Jul 2013
&middot;
Programming 

	&middot;
	<a href="/tags/fsharp">F#</a>, 	

	
	<a href="/tags/reflection">Reflection</a>	
	
  </span>
  <p>During the course of a recent project I needed to instantiate some F# types via reflection. 
This is a well documented and fairly simple process for C#, but F#’s immutable collections pose an interesting challenge.</p>

<p>In this post I will describe the process of creating and populating an F# list using reflection, as well as an F# sequence for good measure.</p>

<!-- more -->

<p><em>Note that it is possible to create generic versions of the functions in this post, but when you’re working with reflection you are normally working with Type and Object rather than types you know about at compile type.</em></p>

<h2>Creating a generic type</h2>

<p>Both the list and sequence type are generic in F# (Microsoft.FSharp.Collections.List<T> and System.Collections.Generic.IEnumerable<T> respectively), so we will need a way of creating new generic types from the collection and item types.</p>

<p>Luckily this is fairly straight forward.</p>

<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="lineno">1</span> <span class="k">let</span> <span class="nv">makeGenericType</span> <span class="o">(</span><span class="n">baseType</span> <span class="o">:</span> <span class="n">Type</span><span class="o">)</span> <span class="o">(</span><span class="n">types</span> <span class="o">:</span> <span class="n">Type</span> <span class="kt">list</span><span class="o">)</span> <span class="o">=</span> 
<span class="lineno">2</span> 
<span class="lineno">3</span>   <span class="k">if</span> <span class="o">(</span><span class="ow">not</span> <span class="n">baseType</span><span class="o">.</span><span class="n">IsGenericTypeDefinition</span><span class="o">)</span> <span class="k">then</span>
<span class="lineno">4</span>     <span class="n">invalidArg</span> <span class="s">&quot;baseType&quot;</span> <span class="s">&quot;baseType must be a generic type definition.&quot;</span>
<span class="lineno">5</span> 
<span class="lineno">6</span>   <span class="n">baseType</span><span class="o">.</span><span class="n">MakeGenericType</span> <span class="o">(</span>
<span class="lineno">7</span>     <span class="n">types</span>
<span class="lineno">8</span>     <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">toArray</span>
<span class="lineno">9</span>   <span class="o">)</span></code></pre></div>

<p>We can use this function to create generic types from a base type and type arguments. For example, here is how to create the type of int option:</p>

<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="lineno">1</span> <span class="k">let</span> <span class="nv">intOptionType</span> <span class="o">=</span> 
<span class="lineno">2</span>   <span class="n">makeGenericType</span>
<span class="lineno">3</span>   <span class="o">&lt;|</span> <span class="n">typedefof</span><span class="o">&lt;</span><span class="n">Option</span><span class="o">&lt;_&gt;&gt;</span>
<span class="lineno">4</span>   <span class="o">&lt;|</span> <span class="o">[</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="n">Int32</span><span class="o">&gt;</span> <span class="o">]</span></code></pre></div>

<p>Note the use of typedefof rather than typeof. typedefof gives you a generic type definition (e.g. Option<T>) while typeof will “fill in the blanks” and give you a full type definition (e.g. Option<obj>).</p>

<h2>Creating a sequence</h2>

<p>Now that we have a way of creating our collection’s type we can go about actually creating and populating it. F#’s sequence is actually just System.Collections.IEnumerable<T> so we can use any type implementing that interface as a sequence – so let’s keep it simple and use List<T>.</p>

<p>In order to create a sequence and populate it with some items we need to:</p>

<p>Create the desired sequence type, e.g. List<String>.
Create an instance of our sequence type using the default constructor.
Add the items to the sequence.
As List<T> is mutable this is fairly straight forward.</p>

<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="lineno"> 1</span> <span class="k">let</span> <span class="nv">makeSeqOf</span> <span class="n">itemType</span> <span class="o">(</span><span class="n">items</span> <span class="o">:</span> <span class="kt">obj</span> <span class="kt">list</span><span class="o">)</span> <span class="o">=</span> 
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span>         <span class="k">let</span> <span class="nv">seqType</span> <span class="o">=</span> 
<span class="lineno"> 4</span>             <span class="n">makeGenericType</span>
<span class="lineno"> 5</span>             <span class="o">&lt;|</span> <span class="n">typedefof</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;_&gt;&gt;</span>
<span class="lineno"> 6</span>             <span class="o">&lt;|</span> <span class="o">[</span> <span class="n">itemType</span><span class="o">;</span> <span class="o">]</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span>         <span class="k">let</span> <span class="nv">sequence</span> <span class="o">=</span> 
<span class="lineno"> 9</span>             <span class="nn">Activator</span><span class="p">.</span><span class="n">CreateInstance</span> <span class="n">seqType</span>
<span class="lineno">10</span> 
<span class="lineno">11</span>         <span class="k">let</span> <span class="nv">add</span> <span class="o">=</span> 
<span class="lineno">12</span> 
<span class="lineno">13</span>             <span class="k">let</span> <span class="nv">addMethod</span> <span class="o">=</span> 
<span class="lineno">14</span>                 <span class="n">seqType</span><span class="o">.</span><span class="n">GetMethod</span> <span class="o">(</span><span class="s">&quot;Add&quot;</span><span class="o">)</span>           
<span class="lineno">15</span>             
<span class="lineno">16</span>             <span class="k">fun</span> <span class="n">item</span> <span class="o">-&gt;</span>
<span class="lineno">17</span>                 <span class="n">addMethod</span><span class="o">.</span><span class="n">Invoke</span> <span class="o">(</span><span class="n">sequence</span><span class="o">,</span> <span class="o">[|</span> <span class="n">item</span><span class="o">;</span> <span class="o">|])</span> 
<span class="lineno">18</span>                 <span class="o">|&gt;</span> <span class="n">ignore</span>
<span class="lineno">19</span> 
<span class="lineno">20</span>         <span class="n">items</span>
<span class="lineno">21</span>         <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="n">add</span>
<span class="lineno">22</span> 
<span class="lineno">23</span>         <span class="n">sequence</span></code></pre></div>

<h2>Creating a list</h2>

<p>Creating an F# list follows the same basic principles but whereas any IEnumerable<T> can be used for a sequence, meaning we can use the mutable List<T>, the same is not true for lists.</p>

<p>The F# list is of type Microsoft.FSharp.Collections.List<T> and it is immutable, which makes our job a little bit more complicated:</p>

<p>Create the desired generic type.
Get a reference to the empty list for that type.
Fold the items into the list, creating an extended list each time.</p>

<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="lineno"> 1</span> <span class="k">let</span> <span class="nv">makeListOf</span> <span class="n">itemType</span> <span class="o">(</span><span class="n">items</span> <span class="o">:</span> <span class="kt">obj</span> <span class="kt">list</span><span class="o">)</span>  <span class="o">=</span> 
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span>         <span class="k">let</span> <span class="nv">listType</span> <span class="o">=</span> 
<span class="lineno"> 4</span>             <span class="n">makeGenericType</span> 
<span class="lineno"> 5</span>             <span class="o">&lt;|</span> <span class="n">typedefof</span><span class="o">&lt;</span><span class="nn">Microsoft</span><span class="p">.</span><span class="nn">FSharp</span><span class="p">.</span><span class="nn">Collections</span><span class="p">.</span><span class="n">List</span><span class="o">&lt;_&gt;&gt;</span> 
<span class="lineno"> 6</span>             <span class="o">&lt;|</span> <span class="o">[</span> <span class="n">itemType</span><span class="o">;</span> <span class="o">]</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span>         <span class="k">let</span> <span class="nv">add</span> <span class="o">=</span> 
<span class="lineno"> 9</span> 
<span class="lineno">10</span>             <span class="k">let</span> <span class="nv">cons</span> <span class="o">=</span> 
<span class="lineno">11</span>                 <span class="n">listType</span><span class="o">.</span><span class="n">GetMethod</span> <span class="o">(</span><span class="s">&quot;Cons&quot;</span><span class="o">)</span>
<span class="lineno">12</span>             
<span class="lineno">13</span>             <span class="k">fun</span> <span class="n">item</span> <span class="kt">list</span> <span class="o">-&gt;</span>
<span class="lineno">14</span>                 <span class="n">cons</span><span class="o">.</span><span class="n">Invoke</span> <span class="o">(</span><span class="k">null</span><span class="o">,</span> <span class="o">[|</span> <span class="n">item</span><span class="o">;</span> <span class="kt">list</span><span class="o">;</span> <span class="o">|])</span>                
<span class="lineno">15</span> 
<span class="lineno">16</span>         <span class="k">let</span> <span class="nv">list</span> <span class="o">=</span> 
<span class="lineno">17</span> 
<span class="lineno">18</span>             <span class="k">let</span> <span class="nv">empty</span> <span class="o">=</span> 
<span class="lineno">19</span>                 <span class="n">listType</span><span class="o">.</span><span class="n">GetProperty</span> <span class="o">(</span><span class="s">&quot;Empty&quot;</span><span class="o">)</span>
<span class="lineno">20</span> 
<span class="lineno">21</span>             <span class="n">empty</span><span class="o">.</span><span class="n">GetValue</span> <span class="o">(</span><span class="k">null</span><span class="o">)</span>
<span class="lineno">22</span> 
<span class="lineno">23</span>         <span class="kt">list</span>
<span class="lineno">24</span>         <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">foldBack</span> <span class="n">add</span> <span class="n">items</span></code></pre></div>

<p>F#’s list type has no default constructor, instead we need to get a reference to the empty list (the equivalent of List.empty<T> or []). Empty is a static property on the list type so we just need to get its value using GetValue.</p>

<p>In order to add items our list we need to use the cons function (more commonly seen as ::) which creates a new list by prepending an item to the head of an existing list. Cons is a static method on the list type so we call it using Invoke and pass it the item to be added and the existing list, in that order (analogous to head :: tail).</p>

<p>By using foldBack we maintain the list order (because items are added in reverse order and cons prepends to the list rather than appending).</p>

<h2>Source code</h2>

<p>The code for the three functions described in this post, as well as various others, are available in my <a href="https://github.com/wattsm/handyfs">HandyFS project on GitHub</a> (MIT licence).</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/programming/2013/11/19/fsharp-serialising-option/">
            Serialising F#'s Option type using DataContractSerialiser
            <small>19 Nov 2013</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/programming/2014/11/07/implementing-a-simple-ihttpactionresult/">
            Implementing a simple IHttpActionResult
            <small>07 Nov 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/programming/2014/05/16/tfs-2010-versioned-wix-installers/">
            Creating versioned installers using Wix and TFS 2010
            <small>16 May 2014</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

  </body>
</html>
