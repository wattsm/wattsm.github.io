<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="https://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Testing Web API OData controllers &middot; try/finally
    
  </title>

  


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>


  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        try/finally
      </a>
    </div>
    <p class="lead">Occasional programming thoughts of Mark Watts.</p>
  </header>
  <nav id="sidebar-nav-links">
  
  

  

  


  
    
  

  
    
      <a class="page-link "
          href="/about/">About</a>
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  


  
    
  

  
    
  

  
    
  

  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


  <!-- Optional additional links to insert in sidebar nav -->
</nav>


  
    <span class="site-version">Currently v1.0</span>
  

  <nav id="sidebar-icon-links">
  

  
  
  
  

  <a id="github-link"
      class="icon"
      title="GitHub" aria-label="GitHub"
      href="https://github.com/wattsm"
      target="_blank">
    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 28" height="24" width="28"><path d="M12 2c6.625 0 12 5.375 12 12 0 5.297-3.437 9.797-8.203 11.391-0.609 0.109-0.828-0.266-0.828-0.578 0-0.391 0.016-1.687 0.016-3.297 0-1.125-0.375-1.844-0.812-2.219 2.672-0.297 5.484-1.313 5.484-5.922 0-1.313-0.469-2.375-1.234-3.219 0.125-0.313 0.531-1.531-0.125-3.187-1-0.313-3.297 1.234-3.297 1.234-0.953-0.266-1.984-0.406-3-0.406s-2.047 0.141-3 0.406c0 0-2.297-1.547-3.297-1.234-0.656 1.656-0.25 2.875-0.125 3.187-0.766 0.844-1.234 1.906-1.234 3.219 0 4.594 2.797 5.625 5.469 5.922-0.344 0.313-0.656 0.844-0.766 1.609-0.688 0.313-2.438 0.844-3.484-1-0.656-1.141-1.844-1.234-1.844-1.234-1.172-0.016-0.078 0.734-0.078 0.734 0.781 0.359 1.328 1.75 1.328 1.75 0.703 2.141 4.047 1.422 4.047 1.422 0 1 0.016 1.937 0.016 2.234 0 0.313-0.219 0.688-0.828 0.578-4.766-1.594-8.203-6.094-8.203-11.391 0-6.625 5.375-12 12-12zM4.547 19.234c0.031-0.063-0.016-0.141-0.109-0.187-0.094-0.031-0.172-0.016-0.203 0.031-0.031 0.063 0.016 0.141 0.109 0.187 0.078 0.047 0.172 0.031 0.203-0.031zM5.031 19.766c0.063-0.047 0.047-0.156-0.031-0.25-0.078-0.078-0.187-0.109-0.25-0.047-0.063 0.047-0.047 0.156 0.031 0.25 0.078 0.078 0.187 0.109 0.25 0.047zM5.5 20.469c0.078-0.063 0.078-0.187 0-0.297-0.063-0.109-0.187-0.156-0.266-0.094-0.078 0.047-0.078 0.172 0 0.281s0.203 0.156 0.266 0.109zM6.156 21.125c0.063-0.063 0.031-0.203-0.063-0.297-0.109-0.109-0.25-0.125-0.313-0.047-0.078 0.063-0.047 0.203 0.063 0.297 0.109 0.109 0.25 0.125 0.313 0.047zM7.047 21.516c0.031-0.094-0.063-0.203-0.203-0.25-0.125-0.031-0.266 0.016-0.297 0.109s0.063 0.203 0.203 0.234c0.125 0.047 0.266 0 0.297-0.094zM8.031 21.594c0-0.109-0.125-0.187-0.266-0.172-0.141 0-0.25 0.078-0.25 0.172 0 0.109 0.109 0.187 0.266 0.172 0.141 0 0.25-0.078 0.25-0.172zM8.937 21.438c-0.016-0.094-0.141-0.156-0.281-0.141-0.141 0.031-0.234 0.125-0.219 0.234 0.016 0.094 0.141 0.156 0.281 0.125s0.234-0.125 0.219-0.219z"></path>
</svg>

  </a>

  
    <a id="tags-link"
       class="icon"
       title="Tags" aria-label="Tags"
       href="/tags/">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
    </a>
  

  
    <a id="search-link"
       class="icon"
       title="Search" aria-label="Search"
       href="/search/">
      <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
    <path d="M0 0h24v24H0z" fill="none"/>
</svg>
    </a>
  

  <!-- Optional additional links to insert for icons links -->
</nav>

  <p>
  &copy; 2020.  
</p>

</div>

    <main class="container">
      <header>
  <h1 class="post-title">Testing Web API OData controllers</h1>
</header>
<div class="content">
  <div class="post-meta">
  <span class="post-date">12 Dec 2014</span>
  <span class="post-categories">
    
      &bull;

      
      
      

      
        programming
      
    
      &bull;

      
      
      

      
        csharp
      
    
  </span>
</div>


  <div class="post-body">
    <p>Microsoft’s <a href="http://msdn.microsoft.com/en-us/data/ef.aspx">Entity Framework</a> is an occasionally handy <a href="https://en.wikipedia.org/wiki/Object-relational_mapping">ORM</a> framework that allows you to query database entities using LINQ and to easily add, update and delete entities via
a variety of helper classes.</p>

<p>Recently I wrote a set of <a href="http://www.asp.net/web-api">WebAPI</a> controllers to expose an Entity Framework model as <a href="http://www.odata.org/">OData</a> endpoints. Exposing an Entity Framework model as OData using WebAPI is <a href="http://www.asp.net/web-api/overview/odata-support-in-aspnet-web-api/odata-v4/create-an-odata-v4-endpoint">incredibly easy</a>.
However, when it came to testing my controllers I found that mocking Entity Framework is tricky, due to a combination of erratic use of interfaces and the apparent complexity of <code class="highlighter-rouge">IQueryable&lt;T&gt;</code>.</p>

<p>Luckily my controllers only used a few parts of the EF API, so I decided to write some lightweight wrappers to make testing easier. This had the bonus of also removing dependencies
on EF from my controllers.</p>

<!-- more -->

<h3 id="odata-controller-structure">OData controller structure</h3>

<p>My original OData controllers all inherited from a common base class which was a tweaked version of the implementation given in this <a href="http://www.asp.net/web-api/overview/odata-support-in-aspnet-web-api/odata-v4/create-an-odata-v4-endpoint">ASP.net article on creating ODAta services using
WebAPI</a>. (This is very similar to the <code class="highlighter-rouge">EntitySetController&lt;TEntity, TKey&gt;</code> defined in <code class="highlighter-rouge">System.Web.Http.OData</code> assembly, but somewhat simpler - <a href="http://msdn.microsoft.com/en-us/library/jj890573(v=vs.118).aspx">you can find information about that type here</a>.)</p>

<p>The common base class has two generic parameters, one specifying the type of the entity and another specifying the type of the entity’s key. It accepted a <code class="highlighter-rouge">DerivedContext</code> in its constructor
and used the <code class="highlighter-rouge">Set&lt;T&gt;</code> method of <code class="highlighter-rouge">DbContext</code> to get a reference to the set of entities it was exposing as OData.</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">readonly</span> <span class="n">DerivedContext</span> <span class="n">_context</span><span class="p">;</span>
<span class="k">private</span> <span class="k">readonly</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="n">_set</span><span class="p">;</span>

<span class="k">public</span> <span class="nf">EntityControllerBase</span><span class="p">(</span><span class="n">DerivedContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">_context</span> <span class="p">=</span> <span class="n">context</span><span class="p">;</span>
  <span class="n">_set</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Set</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>You can see the <a href="https://github.com/wattsm/ODataTests/blob/master/ODataTests.Before/Controllers/EntityControllerBase.cs">full source of the controller here</a>. Looking over the controller’s actions we can see that to test it we need to be able to mock the following:</p>

<ol>
  <li><code class="highlighter-rouge">DbContext.SaveChanges()</code></li>
  <li><code class="highlighter-rouge">DbContext.Set&lt;T&gt;()</code></li>
  <li><code class="highlighter-rouge">DbSet&lt;T&gt;.Find(Object[])</code></li>
  <li><code class="highlighter-rouge">DbSet&lt;T&gt;.Add(T)</code></li>
  <li><code class="highlighter-rouge">DbSet&lt;T&gt;.Remove(T)</code></li>
  <li>The <code class="highlighter-rouge">IQueryable&lt;T&gt;</code> members of <code class="highlighter-rouge">DbSet&lt;T&gt;</code></li>
</ol>

<p>We can now define two simple interfaces that will allow us to mock this functionality and remove our controller’s dependency on EF types.</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">interface</span> <span class="nc">IBasicSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span> <span class="err">{</span>
  <span class="nc">T</span> <span class="nf">Add</span><span class="p">(</span><span class="n">T</span> <span class="n">entity</span><span class="p">);</span>
  <span class="n">T</span> <span class="nf">Remove</span><span class="p">(</span><span class="n">T</span> <span class="n">entity</span><span class="p">);</span>
  <span class="n">T</span> <span class="nf">Find</span><span class="p">(</span><span class="k">params</span> <span class="n">Object</span><span class="p">[]</span> <span class="n">keyValues</span><span class="p">);</span>  
<span class="p">}</span>

<span class="k">public</span> <span class="k">interface</span> <span class="nc">IBasicContext</span> <span class="p">:</span> <span class="n">IDisposable</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="nf">SaveChanges</span><span class="p">();</span>
  <span class="n">IBasicSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">GetSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span><span class="err">;</span>
<span class="err">}</span>
</code></pre></div></div>

<h3 id="interface-implementations">Interface implementations</h3>

<p>Both of these interfaces are easy to implement. First, we can simply wrap <code class="highlighter-rouge">DbSet&lt;T&gt;</code> for <code class="highlighter-rouge">IBasicSet&lt;T&gt;</code>.</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">BasicSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IBasicSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span> <span class="err">{</span>

  <span class="nc">private</span> <span class="k">readonly</span> <span class="n">IDbSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">_wrapped</span><span class="p">;</span>
  
  <span class="k">public</span> <span class="nf">BasicSet</span><span class="p">(</span><span class="n">IDbSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">wrapped</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">_wrapped</span> <span class="p">=</span> <span class="n">wrapped</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="n">T</span> <span class="nf">Add</span><span class="p">(</span><span class="n">T</span> <span class="n">entity</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">_wrapped</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="c1">// And so on for the other members of IBasicSet&lt;T&gt;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Then, add an extension method to <code class="highlighter-rouge">IDbSet&lt;T&gt;</code> for ease of use.</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="n">IBasicSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="nf">Wrap</span><span class="p">(</span><span class="k">this</span> <span class="n">IDbSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="k">set</span><span class="p">)</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span> <span class="err">{</span>
  <span class="nc">return</span> <span class="k">new</span> <span class="n">BasicSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">set</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As <code class="highlighter-rouge">DerivedContext</code> inherits from <code class="highlighter-rouge">DbContext</code> it already has implementations for <code class="highlighter-rouge">Dispose</code> and <code class="highlighter-rouge">SaveChanges</code>, so when implementing <code class="highlighter-rouge">IBasicContext</code> the only member 
we need to explicitly implement is <code class="highlighter-rouge">GetSet&lt;T&gt;</code>, which is trivial:</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">DerivedContext</span> <span class="p">:</span> <span class="n">DbContext</span><span class="p">,</span> <span class="n">IBasicContext</span> <span class="p">{</span>

  <span class="k">public</span> <span class="n">IBasicSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">GetSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span> <span class="err">{</span>
    <span class="nc">return</span> <span class="k">this</span><span class="p">.</span><span class="n">Set</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;().</span><span class="nf">Wrap</span><span class="p">();</span>
  <span class="p">}</span>
  
  <span class="c1">// Snip...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now our controllers can be updated to use these interfaces instead of <code class="highlighter-rouge">DerivedContext</code> and <code class="highlighter-rouge">DbSet&lt;T&gt;</code>:</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">readonly</span> <span class="n">IBasicContext</span> <span class="n">_context</span><span class="p">;</span>
<span class="k">private</span> <span class="k">readonly</span> <span class="n">IBasicSet</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;</span> <span class="n">_set</span><span class="p">;</span>

<span class="k">public</span> <span class="nf">EntityControllerBase</span><span class="p">(</span><span class="n">IBasicContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">_context</span> <span class="p">=</span> <span class="n">context</span><span class="p">;</span>
  <span class="n">_set</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">GetSet</span><span class="p">&lt;</span><span class="n">TEntity</span><span class="p">&gt;();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As our new interfaces expose methods with the same signatures as those that the controller was using previously this is the only change required. The full source of the controllers
after refactoring <a href="https://github.com/wattsm/ODataTests/blob/master/ODataTests.After/Controllers/EntityControllerBase.cs">can be seen here</a>.</p>

<h3 id="testing-the-controllers">Testing the controllers</h3>

<p>For most scenarios testing our controllers now involves creating a few simple mocks - for example here I use <a href="https://github.com/Moq/moq4">Moq</a> to create mocks of <code class="highlighter-rouge">IBasicContext</code> and <code class="highlighter-rouge">IBasicSet&lt;T&gt;</code> to test that
entities are added to the correct set in the controller’s <code class="highlighter-rouge">Post</code> action.</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">Fact</span><span class="p">]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">entity_is_added_to_set</span><span class="p">()</span> <span class="p">{</span>

	<span class="kt">var</span> <span class="k">set</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IBasicSet</span><span class="p">&lt;</span><span class="n">Entity</span><span class="p">&gt;&gt;();</span>
	
	<span class="kt">var</span> <span class="n">context</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IBasicContext</span><span class="p">&gt;();</span>
	<span class="n">context</span><span class="p">.</span><span class="nf">Setup</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">GetSet</span><span class="p">&lt;</span><span class="n">Entity</span><span class="p">&gt;()).</span><span class="nf">Returns</span><span class="p">(</span><span class="k">set</span><span class="p">.</span><span class="n">Object</span><span class="p">);</span>

	<span class="kt">var</span> <span class="n">entity</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Entity</span><span class="p">();</span>
	<span class="kt">var</span> <span class="n">controller</span> <span class="p">=</span> <span class="n">Helpers</span><span class="p">.</span><span class="nf">CreateController</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">Object</span><span class="p">);</span>
	
	<span class="n">controller</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>
	
	<span class="k">set</span><span class="p">.</span><span class="nf">Verify</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">entity</span><span class="p">),</span> <span class="n">Times</span><span class="p">.</span><span class="nf">Once</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div></div>

<p><a href="https://github.com/wattsm/ODataTests/blob/master/ODataTests.After.Tests/Controllers/EntitiesControllerFacts.cs">You can see all of the controller tests here.</a></p>

<p>Some tests require slightly more complicated mocks and are worth discussing.</p>

<h4 id="mocking-iqueryablet">Mocking <code class="highlighter-rouge">IQueryable&lt;T&gt;</code></h4>

<p>At some point in your controller tests you will want to check that the data returned is correct, and to do this you will need to provide your controller with a mock of <code class="highlighter-rouge">IBasicSet&lt;T&gt;</code> with a 
working implementation of <code class="highlighter-rouge">IQueryable&lt;T&gt;</code>. Thankfully the vast majority of the functionality of <code class="highlighter-rouge">IQueryable&lt;T&gt;</code> is provided via extension methods, and 
<a href="http://msdn.microsoft.com/en-us/library/vstudio/bb337580(v=vs.90).aspx">the interface itself is actually very simple</a>, consisting of 3 properties.</p>

<p>The easiest way I’ve found of mocking <code class="highlighter-rouge">IQueryable&lt;T&gt;</code> is to create a simple collection that also implements <code class="highlighter-rouge">IQueryable&lt;T&gt;</code> and then use its <code class="highlighter-rouge">ElementType</code>, <code class="highlighter-rouge">Expression</code> and <code class="highlighter-rouge">Provider</code> properties
in my mock.</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">entities</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Entity</span><span class="p">&gt;();</span>
<span class="n">entities</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Entity</span><span class="p">()</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="m">1</span> <span class="p">});</span>
<span class="n">entities</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Entity</span><span class="p">()</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="m">2</span> <span class="p">});</span>

<span class="kt">var</span> <span class="n">queryable</span> <span class="p">=</span> <span class="n">entities</span><span class="p">.</span><span class="nf">AsQueryable</span><span class="p">();</span>

<span class="kt">var</span> <span class="k">set</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IBasicSet</span><span class="p">&lt;</span><span class="n">Entity</span><span class="p">&gt;&gt;();</span>
<span class="k">set</span><span class="p">.</span><span class="nf">Setup</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">ElementType</span><span class="p">).</span><span class="nf">Returns</span><span class="p">(</span><span class="n">queryable</span><span class="p">.</span><span class="n">ElementType</span><span class="p">);</span>
<span class="k">set</span><span class="p">.</span><span class="nf">Setup</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Expression</span><span class="p">).</span><span class="nf">Returns</span><span class="p">(</span><span class="n">queryable</span><span class="p">.</span><span class="n">Expression</span><span class="p">);</span>
<span class="k">set</span><span class="p">.</span><span class="nf">Setup</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Provider</span><span class="p">).</span><span class="nf">Returns</span><span class="p">(</span><span class="n">queryable</span><span class="p">.</span><span class="n">Provider</span><span class="p">);</span>
</code></pre></div></div>

<p>This gives your mock of <code class="highlighter-rouge">IBasicSet&lt;T&gt;</code> a working implementation of <code class="highlighter-rouge">IQueryable&lt;T&gt;</code> (essentially pointing at the collection you borrowed the 3 properties from). It has the added benefit of allowing you to manipulate the contents of the <code class="highlighter-rouge">IBasicSet&lt;T&gt;</code> during the test, meaning
you can simulate concurrency issues.</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">Fact</span><span class="p">]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">concurrency_exception_returns_not_found_if_entity_no_longer_exists</span><span class="p">()</span> <span class="p">{</span>

  <span class="kt">var</span> <span class="n">entities</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Entity</span><span class="p">&gt;(</span><span class="k">new</span> <span class="n">Entity</span><span class="p">[]</span> <span class="p">{</span>
    <span class="k">new</span> <span class="nf">Entity</span><span class="p">()</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="m">1</span> <span class="p">}</span>
  <span class="p">});</span>

  <span class="kt">var</span> <span class="n">context</span> <span class="p">=</span> <span class="n">Helpers</span><span class="p">.</span><span class="nf">CreateContext</span><span class="p">(</span><span class="n">entities</span><span class="p">);</span>

  <span class="n">context</span><span class="p">.</span><span class="nf">Setup</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nf">SaveChanges</span><span class="p">()).</span><span class="nf">Callback</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>

    <span class="c1">//Simulate another process deleting the entity by removing it</span>
    <span class="c1">//from the list used as the basis for the DbSet.</span>
    <span class="n">entities</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>

    <span class="c1">//Now tell the controller there was a concurrency error.</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">DbUpdateConcurrencyException</span><span class="p">();</span>
  <span class="p">});</span>

  <span class="kt">var</span> <span class="n">controller</span> <span class="p">=</span> <span class="n">Helpers</span><span class="p">.</span><span class="nf">CreateController</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">Object</span><span class="p">);</span>

  <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">controller</span><span class="p">.</span><span class="nf">Patch</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="k">new</span> <span class="n">Delta</span><span class="p">&lt;</span><span class="n">Entity</span><span class="p">&gt;());</span>

  <span class="n">Assert</span><span class="p">.</span><span class="nf">NotNull</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
  <span class="n">Assert</span><span class="p">.</span><span class="n">IsType</span><span class="p">&lt;</span><span class="n">NotFoundResult</span><span class="p">&gt;(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In this test we want to test that the controller correctly handles the case where an entity is deleted by another process while we are in the process of updating it. We create a collection of
entities and then when <code class="highlighter-rouge">SaveChanges</code> is called we remove everything from the collection and throw an exception. To the controller it will appear as if the entity that it was attempting to update
has been deleted by another process.</p>

<h4 id="testing-deltat">Testing <code class="highlighter-rouge">Delta&lt;T&gt;</code></h4>

<p>Figuring out how <code class="highlighter-rouge">Delta&lt;T&gt;</code> worked too me a while.</p>

<p>I wanted to be able to test that entities were being correctly updated in the controller’s <code class="highlighter-rouge">Patch</code> action - unfortunately the <code class="highlighter-rouge">Patch</code> method of <code class="highlighter-rouge">Delta&lt;T&gt;</code> is not virtual so frameworks like 
Moq cannot override or verify its behaviour.</p>

<p>Instead I started looking at simply constructing an instance of <code class="highlighter-rouge">Delta&lt;T&gt;</code>, populating it with changes and then checking the state of the entity to verify that the update had been performed. 
It was some time before I realised that <code class="highlighter-rouge">Delta&lt;T&gt;</code> is created using <code class="highlighter-rouge">dynamic</code> by WebAPI and updated properties are “tacked on” rather than there being methods to add changes to the delta. 
This is best illustrated by an example:</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">entity</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Entity</span><span class="p">()</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">Value</span> <span class="p">=</span> <span class="s">"X"</span> <span class="p">};</span>

<span class="kt">dynamic</span> <span class="n">delta</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Delta</span><span class="p">&lt;</span><span class="n">Entity</span><span class="p">&gt;();</span>
<span class="n">delta</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="s">"Y"</span><span class="p">;</span> <span class="c1">//Dynamic property, Delta&lt;T&gt; does not contain a Value property</span>

<span class="n">delta</span><span class="p">.</span><span class="nf">Patch</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>

<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">entity</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span> <span class="c1">//Y</span>
</code></pre></div></div>

<p>This makes testing quite easy, if nothing else.</p>

<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">Fact</span><span class="p">]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">entity_is_patched</span><span class="p">()</span> <span class="p">{</span>

  <span class="kt">var</span> <span class="n">entities</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Entity</span><span class="p">[]</span> <span class="p">{</span> 
    <span class="k">new</span> <span class="nf">Entity</span><span class="p">()</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">"Original"</span> <span class="p">}</span>
  <span class="p">};</span>

  <span class="kt">var</span> <span class="n">controller</span> <span class="p">=</span> <span class="n">Helpers</span><span class="p">.</span><span class="nf">CreateController</span><span class="p">(</span><span class="n">entities</span><span class="p">);</span>

  <span class="kt">dynamic</span> <span class="n">delta</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Delta</span><span class="p">&lt;</span><span class="n">Entity</span><span class="p">&gt;();</span>
  <span class="n">delta</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="s">"Updated"</span><span class="p">;</span>

  <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">controller</span><span class="p">.</span><span class="nf">Patch</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="n">delta</span><span class="p">);</span>

  <span class="n">Assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="s">"Updated"</span><span class="p">,</span> <span class="n">_entities</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Name</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="conclusion">Conclusion</h3>

<p>In this post I’ve shown that it’s possible to take a simple Entity Framework / Web API OData service controller and make it testable by creating some simple wrappers for the EF components. 
If your project is a simple database-as-OData affair then this allows you to get high test coverage without having to introduce too many new layers or abstractions on top of the basic 
controller structure set out in the original ASP.Net article.</p>

<p>You can see the full source code for the before and after versions of the controller as well as the tests <a href="https://github.com/wattsm/ODataTests">in this GitHub repository</a>.</p>


    



<div class="post-tags">
  
    
    <a href="/tags/#entity-framework">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">entity-framework</span>
    </a>
  
    
    <a href="/tags/#web-api">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">web-api</span>
    </a>
  
    
    <a href="/tags/#unit-testing">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">unit-testing</span>
    </a>
  
    
    <a href="/tags/#odata">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">odata</span>
    </a>
  
    
    <a href="/tags/#csharp">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">csharp</span>
    </a>
  
    
    <a href="/tags/#dotnet">
    
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">dotnet</span>
    </a>
  
</div>
  </div>

  
  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/programming/fsharp/2016/01/19/optimising-civ5-cities-using-genetic-algorithms/">
            Optimising Civ 5 cities using genetic algorithms
            <small>19 Jan 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/programming/csharp/2015/04/10/odata-graph-delta/">
            WebAPI OData GraphDelta<T>
            <small>10 Apr 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/programming/fsharp/2015/05/20/modeling-historical-dates/">
            Modeling historical dates
            <small>20 May 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>

</div>

    </main>

    <!-- Optional footer content -->

  </body>
</html>
